<!DOCTYPE html>
<html lang="pt-BR" data-theme="escuro">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta name="description" content="HyperFitness - Seu aplicativo de treinos" />
  <title>HyperFitness - Seu aplicativo de treinos</title>
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%2313121b'/%3E%3Cpath d='M16 14h10v36H16zM38 14h10v36H38zM26 30h12v10H26z' fill='%23ff7a1f'/%3E%3C/svg%3E" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;900&display=swap"
    rel="stylesheet" />
  <link rel="preload" href="src/imagens/HyperFitness.png" as="image" />
  <link rel="preload" href="src/imagens/capa de fundo.jpg" as="image" />
  <link rel="stylesheet" href="src/player/player.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="src/player/playlists.js"></script>
  <script>
    // Configuração de ambiente (app)
    const isLocalDev = ['localhost', '127.0.0.1', '0.0.0.0'].includes(window.location.hostname) ||
      window.location.port === '5500' ||
      window.location.protocol === 'file:';
  </script>
  <script src="src/player/player.js"></script>

  <style>
    :root {
      --quick-action-size: 64px;
      --primary-color: #ff7a1f;
      --primary-hover: #ff9147;
      --ring-amber: rgba(249, 226, 175, 0.65);
      --ring-primary: rgba(255, 122, 31, 0.55);
      --background-dark: #13121b;
      --background-darker: #0c0b13;
      --surface-0: #242234;
      --surface-1: #37354a;
      --surface-2: #4a485e;
      --overlay-0: #5d5b70;
      --overlay-1: #716f84;
      --overlay-2: #858399;
      --text: #cdd6f4;
      --subtext-0: #a6adc8;
      --subtext-1: #bac2de;
      --text-muted: rgba(186, 194, 222, 0.85);
      --text-subtle: rgba(166, 173, 200, 0.75);
      --lavender: #b4befe;
      --blue: #89b4fa;
      --sapphire: #74c7ec;
      --sky: #89dceb;
      --teal: #94e2d5;
      --green: #a6e3a1;
      --yellow: #f9e2af;
      --peach: #fab387;
      --maroon: #eba0ac;
      --red: #f38ba8;
      --mauve: #cba6f7;
      --pink: #f5c2e7;
      --flamingo: #f2cdcd;
      --rosewater: #f5e0dc;
      --glass-bg: rgba(30, 30, 46, 0.6);
      --glass-border: rgba(205, 214, 244, 0.12);
      --elev-1: 0 12px 28px -16px rgba(17, 17, 27, 0.6);
      --elev-2: 0 24px 48px -24px rgba(17, 17, 27, 0.7);
      --btn-shadow: 0 18px 40px -18px rgba(255, 122, 31, 0.75);
      --btn-shadow-hover: 0 28px 65px -22px rgba(255, 122, 31, 0.95)
    }

    [data-theme="claro"] {
      --background-dark: #eef0f6;
      --background-darker: #dfe3ec
    }

    [data-theme="escuro"] {
      --background-dark: #13121b;
      --background-darker: #0c0b13
    }

    * {
      box-sizing: border-box;
      touch-action: manipulation
    }

    html {
      overflow-x: hidden;
      overflow-y: auto;
      width: 100%;
      max-width: 100%;
      position: relative
    }

    body {
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 0 0 120px 0;
      background-color: var(--background-dark);
      color: var(--text);
      user-select: none;
      -webkit-user-select: none;
      overscroll-behavior-y: auto;
      overflow-x: hidden;
      overflow-y: auto;
      width: 100%;
      max-width: 100%;
      position: relative;
    }

    body::before,
    body::after {
      content: none
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px
    }

    ::-webkit-scrollbar-track {
      background: var(--background-darker)
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 10px
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-hover)
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none
    }

    body.modal-open {
      overflow: hidden;
      position: fixed;
      width: 100%;
      left: 0;
      right: 0
    }


    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.98)
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1)
      }
    }

    @keyframes spinner-rotate {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .spinner-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.25rem;
      height: 1.25rem;
      animation: spinner-rotate 1s linear infinite;
    }

    @keyframes pulse-glow {

      0%,
      100% {
        transform: scale(1.5);
        box-shadow: 0 0 0 0 rgba(255, 122, 31, 0.7)
      }

      70% {
        transform: scale(1.6);
        box-shadow: 0 0 0 8px rgba(255, 122, 31, 0)
      }
    }

    @keyframes stripe-animation {
      from {
        background-position: 40px 0
      }

      to {
        background-position: 0 0
      }
    }

    @keyframes shine {

      0%,
      100% {
        text-shadow: 0 0 4px #f9e2af, 0 0 8px #f9e2af;
        transform: scale(1)
      }

      50% {
        text-shadow: 0 0 8px #f9e2af, 0 0 16px #f9e2af;
        transform: scale(1.1)
      }
    }

    @keyframes pop-in {
      0% {
        transform: scale(0.5);
        opacity: 0
      }

      100% {
        transform: scale(1);
        opacity: 1
      }
    }

    @keyframes check-bounce {

      0%,
      100% {
        transform: scale(1)
      }

      25% {
        transform: scale(1.2)
      }

      50% {
        transform: scale(0.95)
      }

      75% {
        transform: scale(1.05)
      }
    }

    @keyframes check-pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(166, 227, 161, 0.7)
      }

      70% {
        box-shadow: 0 0 0 10px rgba(166, 227, 161, 0)
      }

      100% {
        box-shadow: 0 0 0 0 rgba(166, 227, 161, 0)
      }
    }

    @keyframes restPulse {
      0% {
        box-shadow: 0 0 0 0 rgba(137, 180, 250, 0.45)
      }

      70% {
        box-shadow: 0 0 0 14px rgba(137, 180, 250, 0)
      }

      100% {
        box-shadow: 0 0 0 0 rgba(137, 180, 250, 0)
      }
    }

    @keyframes grow {
      from {
        opacity: 0.5;
        transform: scale(0)
      }

      to {
        opacity: 0;
        transform: scale(3.85)
      }
    }

    .content-enter-animation {
      animation: fadeIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
      will-change: transform, opacity
    }

    .current-week-marker-animation {
      animation: pulse-glow 2s infinite;
      will-change: transform, box-shadow
    }

    .progress-bar-striped {
      background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
      background-size: 40px 40px;
      animation: stripe-animation 2s linear infinite;
      will-change: background-position
    }

    .scroll-animate {
      opacity: 0;
      transform: translateY(50px);
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
      will-change: transform, opacity
    }

    .scroll-animate.is-visible {
      opacity: 1;
      transform: translateY(0)
    }

    .trophy-shine {
      animation: shine 2.5s infinite ease-in-out;
      will-change: transform, text-shadow
    }

    #play-stop-btn.is-playing .ph-stop {
      animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      will-change: transform, opacity
    }

    .no-select {
      user-select: none;
      -webkit-user-select: none
    }

    .touch-manipulation {
      touch-action: manipulation
    }

    .no-tap-highlight {
      -webkit-tap-highlight-color: transparent
    }

    .backdrop-blur-20 {
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px)
    }

    .backdrop-blur-18 {
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px)
    }

    .backdrop-blur-16 {
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px)
    }

    .backdrop-blur-10 {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px)
    }

    .backdrop-blur-6 {
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px)
    }

    button,
    .completion-toggle-wrapper {
      will-change: transform;
      transition: transform 0.25s ease
    }

    button:active,
    .completion-toggle-wrapper:active {
      transform: scale(0.95)
    }

    .quick-actions-wrapper {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 1.25rem;
      flex-wrap: nowrap;
      overflow: visible
    }

    .quick-actions-inner {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.75rem;
      flex-shrink: 0;
      margin-left: auto;
      order: 2;
      overflow: visible
    }

    .btn-theme-principal {
      --btn-gradient-start: rgba(255, 122, 31, 0.68);
      --btn-gradient-end: rgba(255, 145, 71, 0.48);
      --btn-border-color: rgba(205, 214, 244, 0.22);
      position: relative;
      border-radius: 9999px;
      background: rgba(255, 122, 31, 0.6);
      color: var(--text);
      border: 1px solid var(--btn-border-color);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: transform 0.25s ease, background 0.35s ease, border-color 0.35s ease, opacity 0.35s ease;
      cursor: pointer;
      overflow: visible;
      isolation: isolate;
      pointer-events: auto
    }

    .btn-theme-principal::before {
      content: none;
    }

    .btn-theme-principal:hover:not(:disabled) {
      transform: translateY(-2px) scale(1.04);
      box-shadow: var(--btn-shadow-hover), inset 0 1px 0 0 rgba(205, 214, 244, 0.22);
      border-color: rgba(205, 214, 244, 0.32)
    }

    .btn-theme-principal:active:not(:disabled) {
      transform: scale(0.95)
    }

    .btn-theme-principal:focus-visible {
      outline: 2px solid rgba(249, 226, 175, 0.65);
      outline-offset: 4px
    }

    .quick-actions-toggle {
      --quick-actions-font-size: calc(var(--quick-action-size) * 0.4);
      --btn-gap: 0.35rem;
      --btn-padding: 0;
      width: var(--quick-action-size);
      height: var(--quick-action-size);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--quick-actions-font-size);
      line-height: 1;
      letter-spacing: -0.01em;
      text-align: center;
      text-overflow: clip;
      overflow: hidden;
      cursor: pointer;
      position: relative;
      z-index: 10
    }

    .quick-actions-toggle i {
      pointer-events: none;
      transition: transform 0.25s ease;
      font-size: calc(var(--quick-action-size) * 0.38);
      line-height: 1;
      flex-shrink: 0
    }

    .quick-actions-toggle[data-text-mode="true"] {
      gap: 0
    }

    .quick-actions-toggle[data-text-mode="true"] i {
      display: none
    }

    .quick-actions-toggle.is-open i {
      transform: rotate(45deg)
    }

    .quick-actions-toggle:focus-visible {
      outline: 2px solid rgba(249, 226, 175, 0.85);
      outline-offset: 4px
    }

    #quick-actions-toggle {
      width: var(--quick-action-size);
      height: var(--quick-action-size);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--btn-gap);
      padding: var(--btn-padding);
      font-size: var(--quick-actions-font-size);
      line-height: 1;
      letter-spacing: -0.01em;
      text-align: center;
      text-overflow: clip;
      overflow: hidden
    }

    .floating-actions-menu {
      position: absolute;
      bottom: calc(100% + 14px);
      right: 50%;
      transform: translateX(50%) translateY(12px);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 50
    }

    .floating-actions-menu.is-open {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(50%) translateY(0)
    }

    .floating-actions-menu button {
      position: relative;
      width: 56px;
      height: 56px;
      border-radius: 9999px;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      border: 1px solid var(--glass-border);
      background: rgba(30, 30, 46, 0.35);
      box-shadow: var(--elev-1), inset 0 1px 0 0 rgba(205, 214, 244, 0.1);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      transition: transform 0.25s ease, border-color 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
      overflow: hidden;
      isolation: isolate
    }

    .floating-actions-menu button::before {
      content: none;
    }

    .floating-actions-menu button:hover {
      transform: translateY(-2px) scale(1.04);
      border-color: rgba(205, 214, 244, 0.35);
      background: rgba(255, 122, 31, 0.35);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 18px 36px -18px rgba(255, 122, 31, 0.65)
    }

    .floating-actions-menu button:active {
      transform: scale(0.95);
      background: rgba(255, 122, 31, 0.35);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 18px 36px -18px rgba(255, 122, 31, 0.65)
    }

    /* Herdar cores do complete-workout-btn ao interagir */
    .quick-actions-wrapper:has(#complete-workout-btn[data-variant="warning"]) .floating-actions-menu button:hover,
    .quick-actions-wrapper:has(#complete-workout-btn[data-variant="warning"]) .floating-actions-menu button:active {
      background: rgba(243, 139, 168, 0.35);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-color: rgba(243, 139, 168, 0.38);
      box-shadow: 0 18px 36px -18px rgba(243, 139, 168, 0.75)
    }

    .quick-actions-wrapper:has(#complete-workout-btn[data-variant="success"]) .floating-actions-menu button:hover,
    .quick-actions-wrapper:has(#complete-workout-btn[data-variant="success"]) .floating-actions-menu button:active {
      background: rgba(166, 227, 161, 0.35);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-color: rgba(166, 227, 161, 0.38);
      box-shadow: 0 18px 36px -18px rgba(166, 227, 161, 0.75)
    }

    .quick-actions-wrapper:has(#complete-workout-btn[data-variant="amber"]) .floating-actions-menu button:hover,
    .quick-actions-wrapper:has(#complete-workout-btn[data-variant="amber"]) .floating-actions-menu button:active {
      background: rgba(249, 226, 175, 0.35);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-color: rgba(249, 226, 175, 0.38);
      box-shadow: 0 18px 36px -18px rgba(249, 226, 175, 0.75)
    }

    .quick-actions-wrapper:has(#complete-workout-btn[data-variant="neutral"]) .floating-actions-menu button:hover,
    .quick-actions-wrapper:has(#complete-workout-btn[data-variant="neutral"]) .floating-actions-menu button:active {
      background: rgba(108, 112, 134, 0.35);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-color: rgba(108, 112, 134, 0.35);
      box-shadow: 0 18px 36px -18px rgba(108, 112, 134, 0.6)
    }

    .floating-actions-menu button:focus-visible {
      outline: 2px solid rgba(249, 226, 175, 0.85);
      outline-offset: 4px
    }

    @media (max-width:640px) {
      :root {
        --quick-action-size: 56px
      }

      .quick-actions-wrapper {
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        gap: 0.75rem;
        flex-wrap: nowrap
      }

      #footer-container #complete-workout-btn {
        order: 1;
        flex: 1 1 auto;
        width: auto;
        min-width: 0;
        padding: 0 1.35rem;
        font-size: 0.98rem;
        white-space: nowrap !important;
        word-break: normal;
        overflow-wrap: normal
      }

      .quick-actions-inner {
        order: 2;
        align-self: auto;
        justify-content: center;
        margin-left: 0
      }

      #footer-container .quick-actions-toggle {
        width: var(--quick-action-size);
        height: var(--quick-action-size);
        --quick-actions-font-size: calc(var(--quick-action-size) * 0.36);
        white-space: nowrap !important;
        word-break: normal;
        overflow-wrap: normal
      }
    }

    #complete-workout-btn {
      --btn-font-weight: 700;
      --btn-font-size: 1.05rem;
      --btn-letter-spacing: 0.01em;
      width: auto;
      max-width: 100%;
      flex: 1 1 auto;
      min-width: 0;
      order: 1;
      height: var(--quick-action-size);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.85rem;
      padding: 0 1.75rem;
      font-weight: var(--btn-font-weight);
      font-size: var(--btn-font-size);
      letter-spacing: var(--btn-letter-spacing);
      white-space: nowrap;
      margin-right: calc(var(--quick-action-size) + 1.25rem)
    }

    @media (min-width: 640px) {
      #complete-workout-btn {
        margin-right: calc(var(--quick-action-size) + 2.25rem)
      }
    }

    #quick-actions-container {
      right: 1rem;
    }

    @media (min-width: 920px) {
      #quick-actions-container {
        right: calc(50% - 28rem + 1rem);
      }
    }

    #complete-workout-btn:focus-visible {
      outline: 3px solid rgba(249, 226, 175, 0.45);
      outline-offset: 4px
    }

    #complete-workout-btn:disabled {
      cursor: not-allowed;
      opacity: 1;
      transform: none;
      box-shadow: var(--btn-shadow), inset 0 1px 0 0 rgba(255, 255, 255, 0.2)
    }

    #complete-workout-btn:disabled::before {
      opacity: 0.55
    }

    #complete-workout-btn[data-variant="warning"] {
      --btn-gradient-start: rgba(243, 139, 168, 0.7);
      --btn-gradient-end: rgba(243, 139, 168, 0.5);
      --btn-shadow: 0 18px 40px -18px rgba(243, 139, 168, 0.75);
      --btn-shadow-hover: 0 28px 65px -22px rgba(243, 139, 168, 0.95);
      --btn-border-color: rgba(243, 139, 168, 0.38);
      background: rgba(243, 139, 168, 0.6)
    }

    #complete-workout-btn[data-variant="success"] {
      --btn-gradient-start: rgba(166, 227, 161, 0.72);
      --btn-gradient-end: rgba(166, 227, 161, 0.58);
      --btn-shadow: 0 18px 40px -18px rgba(166, 227, 161, 0.75);
      --btn-shadow-hover: 0 28px 65px -22px rgba(166, 227, 161, 0.95);
      --btn-border-color: rgba(166, 227, 161, 0.38);
      background: rgba(166, 227, 161, 0.6)
    }

    #complete-workout-btn[data-variant="amber"] {
      --btn-gradient-start: rgba(249, 226, 175, 0.8);
      --btn-gradient-end: rgba(249, 226, 175, 0.6);
      --btn-shadow: 0 18px 40px -18px rgba(249, 226, 175, 0.75);
      --btn-shadow-hover: 0 28px 65px -22px rgba(249, 226, 175, 0.92);
      --btn-border-color: rgba(249, 226, 175, 0.38);
      background: rgba(249, 226, 175, 0.65)
    }

    #complete-workout-btn[data-variant="neutral"] {
      --btn-gradient-start: rgba(108, 112, 134, 0.55);
      --btn-gradient-end: rgba(69, 71, 90, 0.5);
      --btn-shadow: 0 18px 40px -18px rgba(108, 112, 134, 0.6);
      --btn-shadow-hover: 0 28px 65px -22px rgba(108, 112, 134, 0.72);
      --btn-border-color: rgba(108, 112, 134, 0.35);
      background: rgba(108, 112, 134, 0.5)
    }

    .quick-actions-wrapper:has(#complete-workout-btn[data-variant="warning"]) .quick-actions-inner>.btn-theme-principal {
      --btn-shadow: 0 18px 40px -18px rgba(243, 139, 168, 0.75);
      --btn-shadow-hover: 0 28px 65px -22px rgba(243, 139, 168, 0.95);
      --btn-border-color: rgba(243, 139, 168, 0.38);
      background: rgba(243, 139, 168, 0.6)
    }

    .quick-actions-wrapper:has(#complete-workout-btn[data-variant="success"]) .quick-actions-inner>.btn-theme-principal {
      --btn-shadow: 0 18px 40px -18px rgba(166, 227, 161, 0.75);
      --btn-shadow-hover: 0 28px 65px -22px rgba(166, 227, 161, 0.95);
      --btn-border-color: rgba(166, 227, 161, 0.38);
      background: rgba(166, 227, 161, 0.6)
    }

    .quick-actions-wrapper:has(#complete-workout-btn[data-variant="amber"]) .quick-actions-inner>.btn-theme-principal {
      --btn-shadow: 0 18px 40px -18px rgba(249, 226, 175, 0.75);
      --btn-shadow-hover: 0 28px 65px -22px rgba(249, 226, 175, 0.92);
      --btn-border-color: rgba(249, 226, 175, 0.38);
      background: rgba(249, 226, 175, 0.65)
    }

    .quick-actions-wrapper:has(#complete-workout-btn[data-variant="neutral"]) .quick-actions-inner>.btn-theme-principal {
      --btn-shadow: 0 18px 40px -18px rgba(108, 112, 134, 0.6);
      --btn-shadow-hover: 0 28px 65px -22px rgba(108, 112, 134, 0.72);
      --btn-border-color: rgba(108, 112, 134, 0.35);
      background: rgba(108, 112, 134, 0.5)
    }

    #day-selector {
      justify-content: center
    }

    #day-selector button {
      flex: 1;
      white-space: nowrap;
      min-width: 0
    }

    .container,
    #main-content {
      max-width: 100%;
      overflow-x: hidden
    }

    #footer-container {
      max-width: 100%
    }

    #footer-container .container {
      overflow: visible
    }

    @media (min-width:1280px) {
      #main-content {
        max-width: 1200px
      }

      nav[aria-label="Navegação por semanas"],
      #day-selector {
        max-width: 900px;
        margin-left: auto;
        margin-right: auto
      }

      #phase-header {
        max-width: 800px;
        margin-left: auto;
        margin-right: auto
      }

      .phase-title,
      #phase-header h2,
      #phase-header .phase-title {
        color: #ff7a1f;
        position: relative;
        display: inline-block;
        font-weight: 900;
        letter-spacing: -0.02em
      }

      @supports not (background-clip:text) {

        .phase-title,
        #phase-header h2,
        #phase-header .phase-title {
          color: #ff7a1f;
          background: none
        }
      }

      #workout-details {
        max-width: 1000px;
        margin-left: auto;
        margin-right: auto;
        gap: 1.5rem
      }

      .workout-card {
        max-width: 480px
      }

      #workout-title {
        max-width: 800px;
        margin-left: auto;
        margin-right: auto
      }

      #progress-bar-container {
        max-width: 900px;
        margin-left: auto;
        margin-right: auto
      }
    }

    @media (min-width:1536px) {
      #main-content {
        max-width: 1280px
      }

      #workout-details {
        max-width: 1100px;
        gap: 2rem
      }

      .workout-card {
        max-width: 520px
      }

      nav[aria-label="Navegação por semanas"],
      #day-selector {
        max-width: 1000px
      }

      #phase-header,
      #workout-title {
        max-width: 900px
      }

      #progress-bar-container {
        max-width: 1000px
      }
    }

    @media (min-width:1920px) {
      #main-content {
        max-width: 1400px
      }

      #workout-details {
        max-width: 1200px;
        gap: 2.5rem
      }

      .workout-card {
        max-width: 560px
      }

      nav[aria-label="Navegação por semanas"],
      #day-selector {
        max-width: 1100px
      }

      #phase-header,
      #workout-title {
        max-width: 1000px
      }

      #progress-bar-container {
        max-width: 1100px
      }
    }

    .step-tooltip {
      position: absolute;
      bottom: calc(100% + 12px);
      left: 50%;
      transform: translate(-50%, 4px);
      min-width: 100px;
      padding: 0.6rem 0.8rem;
      border-radius: 0.75rem;
      background: rgba(30, 30, 46, 0.96);
      border: 1px solid var(--glass-border);
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
      z-index: 100;
      font-size: 0.75rem;
      font-weight: 600;
      color: rgba(226, 232, 240, 0.9);
      letter-spacing: 0.04em;
      white-space: nowrap
    }

    .step-tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 7px;
      border-style: solid;
      border-color: rgba(30, 30, 46, 0.95) transparent transparent transparent
    }

    .group:hover .step-tooltip {
      visibility: visible;
      opacity: 1;
      transform: translate(-50%, -2px);
      pointer-events: auto
    }

    .glass-effect {
      background: rgba(40, 40, 55, 0.7);
      -webkit-backdrop-filter: blur(20px) saturate(130%);
      backdrop-filter: blur(20px) saturate(130%);
      border: 1px solid var(--glass-border)
    }

    /* Liquid Glass Effect - Apple Style */
    .liquid-glass {
      position: relative;
      background: rgba(255, 255, 255, 0.02);
      -webkit-backdrop-filter: blur(60px) saturate(120%);
      backdrop-filter: blur(60px) saturate(120%);
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow:
        0 4px 24px rgba(0, 0, 0, 0.06),
        inset 0 0.5px 0 rgba(255, 255, 255, 0.05);
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      overflow: hidden;
    }

    .liquid-glass::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid transparent;
      border-top-color: rgba(255, 255, 255, 0.015);
      border-left-color: rgba(255, 255, 255, 0.008);
      pointer-events: none;
    }

    .liquid-glass:hover {
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(255, 255, 255, 0.06);
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.08),
        inset 0 0.5px 0 rgba(255, 255, 255, 0.08);
    }

    .liquid-glass:active {
      transform: scale(0.97);
      background: rgba(255, 255, 255, 0.02);
      transition-duration: 0.1s;
    }

    .modal-subtitle,
    .notepad-toolbar .notepad-indicator,
    #timer-status,
    #notepad-updated-at,
    .notepad-hint {
      color: var(--text-subtle)
    }

    .text-slate-300 {
      color: var(--text-muted)
    }

    .workout-card {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1;
      transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
      overflow: visible;
      display: flex;
      flex-direction: column
    }

    .workout-card::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: rgba(0, 0, 0, 0.35);
      opacity: 0;
      transition: opacity 0.25s ease;
      z-index: 5
    }

    .workout-card:hover::after,
    .workout-card:focus-within::after {
      opacity: 1
    }

    .workout-card>.absolute.inset-0 {
      overflow: hidden;
      border-radius: inherit
    }

    .workout-card:hover {
      transform: translateY(-4px);
      border-color: rgba(255, 122, 31, 0.4) !important;
      box-shadow: 0 20px 40px -10px rgba(255, 122, 31, 0.3), 0 0 0 1px rgba(255, 122, 31, 0.2)
    }

    .workout-card:active {
      transform: translateY(-2px)
    }

    .exercise-completed {
      opacity: 0.85
    }

    .exercise-completed h3 {
      text-decoration: line-through;
      text-decoration-color: var(--green);
      text-decoration-thickness: 2px
    }

    .workout-card.exercise-completed:hover {
      border-color: rgba(166, 227, 161, 0.5) !important;
      box-shadow: 0 20px 40px -10px rgba(166, 227, 161, 0.35), 0 0 0 1px rgba(166, 227, 161, 0.3)
    }

    .workout-card .relative.z-10 {
      flex-shrink: 0
    }

    .workout-card .relative.z-10.p-4.flex {
      flex: 0 0 auto;
      padding-top: clamp(2rem, 4vw, 3rem)
    }

    .workout-card .relative.z-10.p-4.space-y-4 {
      margin-top: auto;
      flex: 0 0 auto
    }

    .workout-card h3 {
      font-size: clamp(1.15rem, 3.5vw, 1.5rem);
      line-height: 1.2;
      word-break: break-word;
      hyphens: auto
    }

    @media (min-width:768px) {
      .workout-card h3 {
        font-size: clamp(1.25rem, 2.2vw, 1.5rem)
      }
    }

    @media (max-width:640px) {
      .workout-card h3 {
        font-size: clamp(1rem, 4.5vw, 1.3rem)
      }
    }

    .workout-card .exercise-card-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      transform: translate3d(0, var(--card-parallax-offset, 0), 0) scale(var(--card-image-scale, 1.05));
      transition: transform 0.6s ease;
      will-change: transform;
      pointer-events: none
    }

    .workout-card:hover .exercise-card-image,
    .workout-card:focus-within .exercise-card-image {
      --card-image-scale: 1.12
    }

    @media (prefers-reduced-motion:reduce) {
      .workout-card .exercise-card-image {
        transition-duration: 0.3s;
        transform: scale(1.02)
      }
    }

    .exercise-stats-chip-group {
      display: flex;
      gap: clamp(0.4rem, 1vw, 0.65rem);
      flex-wrap: nowrap;
      justify-content: space-between;
      align-items: stretch;
      width: 100%
    }

    .exercise-stat-button {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: clamp(0.3rem, 1vw, 0.5rem);
      min-width: 0;
      max-width: 100%;
      width: 100%;
      padding: clamp(0.65rem, 1.5vw, 0.9rem) clamp(0.5rem, 1vw, 0.75rem);
      border-radius: 0.75rem;
      border: 1px solid var(--glass-border);
      background: var(--glass-bg);
      color: var(--text);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
      transition: transform 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
      cursor: pointer;
      overflow: visible;
      flex: 1 1 0;
      min-height: clamp(75px, 15vw, 95px)
    }

    @media (max-width:640px) {
      .exercise-stats-chip-group {
        gap: 0.5rem;
        justify-content: space-between
      }

      .exercise-stat-button {
        min-width: 0;
        flex: 1 1 0;
        max-width: calc(33.333% - 0.35rem);
        padding: 0.7rem 0.5rem;
        gap: 0.35rem;
        min-height: 85px
      }

      .exercise-stat-button .chip-header {
        font-size: 0.58rem;
        gap: 0.3rem
      }

      .exercise-stat-button .stat-icon {
        font-size: 0.9rem
      }

      .exercise-stat-button .stat-value {
        font-size: 1.05rem
      }

      .exercise-stat-button .stat-helper {
        font-size: 0.5rem;
        letter-spacing: 0.06em
      }

      .exercise-stat-button .stat-progress-bar {
        left: 0.5rem;
        right: 0.5rem;
        bottom: 0.35rem
      }
    }

    .exercise-stat-button:hover,
    .exercise-stat-button:focus-visible {
      transform: translateY(-2px) scale(1.035);
      border-color: rgba(205, 214, 244, 0.22);
      background-color: rgba(49, 50, 68, 0.5);
      outline: none
    }

    .exercise-stat-button:active {
      transform: scale(0.95)
    }

    .exercise-stat-button .chip-header {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: clamp(0.25rem, 0.8vw, 0.4rem);
      font-size: clamp(0.55rem, 1.2vw, 0.7rem);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(226, 232, 240, 0.82)
    }

    .exercise-stat-button .stat-label {
      font-size: inherit;
      font-weight: inherit;
      letter-spacing: inherit;
      text-transform: inherit
    }

    .exercise-stat-button .stat-icon {
      font-size: clamp(0.85rem, 1.8vw, 1.1rem);
      color: rgba(255, 255, 255, 0.78);
      line-height: 1
    }

    .exercise-stat-button .stat-value {
      font-size: clamp(1.05rem, 2.5vw, 1.4rem);
      font-weight: 800;
      line-height: 1;
      letter-spacing: -0.01em;
      color: var(--text);
      transition: color 0.2s ease;
      text-align: center;
      width: 100%
    }

    .exercise-stat-button .stat-helper {
      font-size: clamp(0.5rem, 1.1vw, 0.65rem);
      font-weight: 600;
      color: rgba(255, 255, 255, 0.58);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      text-align: center
    }

    .exercise-stat-button[data-stat-type="rest"].finished .stat-helper {
      white-space: nowrap;
      font-size: clamp(0.45rem, 0.8vw+0.2rem, 0.55rem);
      letter-spacing: 0.05em
    }

    .exercise-method-pill {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: clamp(0.35rem, 0.8vw, 0.5rem);
      padding: clamp(0.35rem, 0.8vw, 0.45rem) clamp(0.7rem, 1.5vw, 0.9rem);
      margin-bottom: clamp(0.6rem, 1.5vw, 0.85rem);
      border-radius: 999px;
      border: 1px solid var(--glass-border);
      background: var(--glass-bg);
      color: var(--text);
      font-size: clamp(0.6rem, 1.3vw, 0.75rem);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
      transition: transform 0.25s ease, border-color 0.25s ease, background 0.25s ease;
      z-index: 50;
      flex-shrink: 0
    }

    .exercise-method-pill:hover,
    .exercise-method-pill:focus-visible {
      transform: translateY(-1px);
      border-color: rgba(205, 214, 244, 0.25);
      background: rgba(49, 50, 68, 0.65);
      outline: none
    }

    .exercise-method-pill .method-icon {
      font-size: clamp(0.85rem, 1.8vw, 1.05rem);
      line-height: 1;
      color: rgba(255, 255, 255, 0.75)
    }

    .exercise-method-pill .method-label {
      white-space: nowrap
    }

    .exercise-method-pill .method-tooltip {
      position: absolute;
      bottom: calc(100%+12px);
      left: 50%;
      transform: translate(-50%, 8px);
      min-width: 180px;
      max-width: 260px;
      padding: 0.6rem 0.8rem;
      border-radius: 0.75rem;
      background: rgba(30, 30, 46, 0.96);
      border: 1px solid var(--glass-border);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 0.4rem
    }

    .exercise-method-pill .method-tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 7px;
      border-style: solid;
      border-color: rgba(30, 30, 46, 0.95) transparent transparent transparent
    }

    .exercise-method-pill .method-tooltip span {
      font-size: 0.65rem;
      font-weight: 500;
      color: rgba(226, 232, 240, 0.9);
      letter-spacing: 0.04em;
      text-transform: none
    }

    .exercise-method-pill.is-open .method-tooltip {
      opacity: 1;
      transform: translate(-50%, 0);
      pointer-events: auto
    }

    @media (max-width:640px) {
      .exercise-method-pill {
        font-size: 0.62rem;
        gap: 0.35rem;
        padding: 0.35rem 0.7rem;
        letter-spacing: 0.14em
      }

      .exercise-method-pill .method-tooltip {
        min-width: 150px;
        max-width: 220px
      }

      .exercise-method-pill .method-tooltip span {
        font-size: 0.58rem
      }
    }

    .exercise-stat-button .stat-progress-bar {
      position: absolute;
      left: 0.65rem;
      right: 0.65rem;
      bottom: 0.45rem;
      height: 4px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.1);
      overflow: hidden
    }

    .exercise-stat-button .stat-progress-fill {
      position: absolute;
      top: 0;
      left: 0;
      width: 0%;
      height: 100%;
      background: var(--primary-color);
      transition: width 0.2s linear
    }

    .exercise-stat-button[data-stat-type="series"].is-complete .stat-value {
      color: var(--green)
    }

    .exercise-stat-button[data-stat-type="series"].is-complete {
      border-color: rgba(166, 227, 161, 0.5);
      background-color: rgba(166, 227, 161, 0.2)
    }

    .exercise-stat-button[data-stat-type="series"].is-active {
      border-color: rgba(255, 122, 31, 0.6)
    }

    .exercise-stat-button[data-stat-type="rest"].is-counting {
      border-color: rgba(137, 180, 250, 0.6);
      background-color: rgba(137, 180, 250, 0.2)
    }

    .exercise-stat-button[data-stat-type="rest"].is-counting .stat-value {
      color: var(--blue)
    }

    .exercise-stat-button[data-stat-type="rest"].finished {
      border-color: rgba(166, 227, 161, 0.6);
      background-color: rgba(166, 227, 161, 0.22)
    }

    .exercise-stat-button[data-stat-type="rest"].finished .stat-value {
      color: var(--green)
    }

    .exercise-stat-button .stat-details {
      position: absolute;
      bottom: calc(100%+12px);
      left: 50%;
      transform: translate(-50%, 8px);
      background: rgba(30, 30, 46, 0.96);
      border: 1px solid var(--glass-border);
      border-radius: 0.75rem;
      padding: 0.6rem 0.7rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 50;
      min-width: 150px
    }

    .exercise-stat-button .stat-details::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 7px;
      border-style: solid;
      border-color: rgba(30, 30, 46, 0.95) transparent transparent transparent
    }

    .exercise-stat-button .stat-details span {
      display: block;
      font-size: 0.7rem;
      font-weight: 500;
      color: rgba(226, 232, 240, 0.88);
      letter-spacing: 0.02em
    }

    .exercise-stat-button.is-open .stat-details {
      opacity: 1;
      transform: translate(-50%, 0);
      pointer-events: auto
    }

    .exercise-stat-button[data-stat-type="rest"].is-counting::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid rgba(137, 180, 250, 0.3);
      animation: restPulse 1.8s infinite;
      pointer-events: none
    }

    #exercise-image-modal {
      z-index: 60;
      transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
      will-change: opacity, visibility
    }

    #exercise-image-modal.active {
      opacity: 1;
      visibility: visible
    }

    #exercise-image-content {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transform: scale(0.9);
      opacity: 0;
      transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
      padding: 0;
      margin: 0;
      line-height: 0
    }

    #exercise-image-modal.active #exercise-image-content {
      transform: scale(1);
      opacity: 1
    }

    #exercise-image-content img {
      max-width: min(640px, 90vw);
      max-height: 85vh;
      width: 420px;
      height: 420px;
      border-radius: 0.5rem;
      object-fit: contain;
      display: block
    }

    @media (max-width:768px) {
      #exercise-image-content img {
        width: auto;
        height: auto;
        max-width: 90vw;
        max-height: 90vh
      }

      .modal-close-btn {
        top: 0.75rem;
        right: 0.75rem;
        width: 2.75rem;
        height: 2.75rem
      }

      .modal-close-btn i {
        font-size: 1.25rem
      }
    }

    @media (max-width:480px) {
      .modal-close-btn {
        top: 0.5rem;
        right: 0.5rem
      }
    }

    .modal-close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 70;
      border-radius: 9999px;
      border: 1px solid var(--glass-border);
      background: rgba(40, 40, 55, 0.7);
      color: var(--text);
      box-shadow: var(--elev-2);
      transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease
    }

    .modal-close-btn i {
      pointer-events: none
    }

    .modal-close-btn:hover {
      transform: translateY(-1px) scale(1.05);
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.22)
    }

    .modal-close-btn:active {
      transform: scale(0.95)
    }

    .modal-close-btn:focus-visible {
      outline: 2px solid var(--ring-amber);
      outline-offset: 3px
    }

    .modal-card {
      background: rgba(30, 30, 46, 0.5);
      border: 1.5px solid var(--glass-border);
      border-radius: 2rem;
      box-shadow: var(--elev-1), var(--elev-2)
    }

    .modal-card::before {
      content: none;
    }

    [data-theme="claro"] .modal-card {
      background: rgba(50, 52, 70, 0.35);
    }

    [data-theme="claro"] .notepad-editor-wrapper {
      background: rgb(255, 250, 215);
      border-color: rgba(205, 180, 140, 0.2);
    }

    [data-theme="claro"] .notepad-editor {
      color: rgba(18, 20, 25, 1);
    }

    [data-theme="claro"] .notepad-editor:empty::before {
      color: rgba(55, 60, 70, 0.65);
    }

    .notepad-format-btn {
      color: rgba(18, 20, 25, 1) !important;
    }

    .notepad-format-btn:hover {
      background: rgba(40, 45, 55, 0.12);
      color: rgba(18, 20, 25, 1) !important;
    }

    .notepad-format-btn[data-active="true"] {
      background: rgba(255, 160, 50, 0.2);
      color: rgba(18, 20, 25, 1) !important;
    }

    [data-theme="claro"] .notepad-format-btn {
      color: rgba(18, 20, 25, 1) !important;
    }

    [data-theme="claro"] .notepad-format-btn:hover {
      background: rgba(40, 45, 55, 0.12);
      color: rgba(18, 20, 25, 1) !important;
    }

    [data-theme="claro"] .notepad-format-btn[data-active="true"] {
      background: rgba(255, 160, 50, 0.2);
      color: rgba(18, 20, 25, 1) !important;
    }

    .notepad-editor-toolbar {
      border-bottom-color: rgba(0, 0, 0, 0.08);
    }

    [data-theme="claro"] .notepad-editor-toolbar {
      border-bottom-color: rgba(0, 0, 0, 0.08);
    }

    .notepad-char-counter {
      position: absolute;
      bottom: 0.75rem;
      right: 1rem;
      font-size: 0.7rem;
      font-weight: 600;
      color: rgba(60, 65, 75, 0.5);
      letter-spacing: 0.04em;
      pointer-events: none;
      user-select: none;
      transition: color 0.2s ease;
    }

    .notepad-char-counter.warning {
      color: rgba(255, 140, 40, 0.85);
    }

    .notepad-char-counter.error {
      color: rgba(243, 139, 168, 0.9);
      font-weight: 700;
    }

    [data-theme="claro"] .notepad-char-counter {
      color: rgba(55, 60, 70, 0.55);
    }

    [data-theme="claro"] .notepad-char-counter.warning {
      color: rgba(220, 120, 30, 0.85);
    }

    [data-theme="claro"] .notepad-char-counter.error {
      color: rgba(200, 80, 100, 0.9);
    }

    .notepad-editor-wrapper {
      position: relative;
    }

    .timer-header h2 {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: var(--primary-color);
      text-transform: uppercase
    }

    .timer-header p {
      color: rgba(226, 232, 240, 0.8);
      font-size: 0.95rem;
      margin-top: 0.35rem
    }

    .timer-display {
      font-size: clamp(2.75rem, 6vw, 3.75rem);
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.12em;
      color: var(--text)
    }

    .timer-status {
      font-size: 0.95rem;
      color: rgba(203, 213, 225, 0.85)
    }

    .timer-controls {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem
    }

    .timer-control-btn {
      --btn-gradient-start: rgba(255, 122, 31, 0.68);
      --btn-gradient-end: rgba(255, 145, 71, 0.48);
      --btn-border-color: rgba(205, 214, 244, 0.22);
      position: relative;
      border-radius: 9999px;
      background: rgba(255, 122, 31, 0.6);
      color: var(--text);
      border: 1px solid var(--btn-border-color);
      box-shadow: var(--btn-shadow), inset 0 1px 0 0 rgba(205, 214, 244, 0.2);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: transform 0.25s ease, box-shadow 0.35s ease, background 0.35s ease, border-color 0.35s ease, opacity 0.35s ease;
      cursor: pointer;
      overflow: visible;
      isolation: isolate;
      pointer-events: auto;
      padding: 0.9rem 1.2rem;
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem
    }

    .timer-control-btn::before {
      content: none;
    }

    .timer-control-btn.primary:hover:not(:disabled) {
      transform: translateY(-2px) scale(1.04);
      box-shadow: var(--btn-shadow-hover), inset 0 1px 0 0 rgba(205, 214, 244, 0.22);
      border-color: rgba(205, 214, 244, 0.32)
    }

    .timer-control-btn.secondary {
      --btn-gradient-start: rgba(49, 50, 68, 0.5);
      --btn-gradient-end: rgba(49, 50, 68, 0.5)
    }

    .timer-control-btn.secondary:hover:not(:disabled) {
      --btn-gradient-start: rgba(69, 71, 90, 0.65);
      --btn-gradient-end: rgba(69, 71, 90, 0.65);
      transform: translateY(-2px) scale(1.04);
      border-color: rgba(205, 214, 244, 0.2);
      box-shadow: var(--btn-shadow-hover), inset 0 1px 0 0 rgba(205, 214, 244, 0.15)
    }

    .timer-control-btn:active:not(:disabled) {
      transform: scale(0.95)
    }

    .timer-control-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none
    }

    .timer-control-btn:focus-visible {
      outline: 2px solid rgba(249, 226, 175, 0.65);
      outline-offset: 4px
    }

    .timer-control-btn {
      animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      will-change: transform, opacity
    }

    .timer-control-btn:nth-child(1) {
      animation-delay: 0.05s
    }

    .timer-control-btn:nth-child(2) {
      animation-delay: 0.15s
    }

    #timer-toggle-btn.is-running .ph-pause {
      animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      will-change: transform, opacity
    }

    #timer-toggle-btn:not(.is-running) .ph-play {
      animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      will-change: transform, opacity
    }

    @media (max-width:480px) {
      .timer-controls {
        grid-template-columns: 1fr
      }
    }

    #edit-schedule-card {
      max-height: min(90vh, 650px);
      display: flex;
      flex-direction: column
    }

    @supports (height:100dvh) {
      #edit-schedule-card {
        max-height: min(90dvh, 650px)
      }

      .edit-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        color: var(--primary-color);
        text-transform: uppercase
      }

      .edit-header p {
        color: rgba(226, 232, 240, 0.8);
        font-size: 0.95rem;
        margin-top: 0.35rem
      }

      #edit-schedule-list {
        overflow-y: auto;
        flex: 1;
        min-height: 0
      }

      #edit-schedule-list::-webkit-scrollbar {
        width: 6px
      }

      #edit-schedule-list::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 9999px
      }

      @media (max-height:700px) {
        #edit-schedule-card {
          padding: 1.25rem 1.5rem 1.5rem
        }

        .edit-header {
          margin-bottom: 1.25rem !important
        }

        .edit-header h2 {
          font-size: 1.25rem
        }

        .edit-header p {
          font-size: 0.85rem;
          margin-top: 0.25rem
        }

        #edit-schedule-list {
          margin-bottom: 1.25rem !important
        }

        #edit-schedule-card .flex.justify-end.gap-3 button {
          padding: 0.5rem 1rem;
          font-size: 0.85rem
        }

        #edit-schedule-card .mt-8:last-child {
          margin-top: 1rem !important
        }
      }

      @media (max-height:600px) {
        #edit-schedule-card {
          padding: 1rem 1.25rem 1.25rem
        }

        .edit-header {
          margin-bottom: 1rem !important
        }

        .edit-header h2 {
          font-size: 1.1rem
        }

        .edit-header p {
          font-size: 0.8rem
        }

        #edit-schedule-list {
          margin-bottom: 1rem !important
        }

        #edit-schedule-card .flex.justify-end.gap-3 {
          gap: 0.5rem !important
        }

        #edit-schedule-card .flex.justify-end.gap-3 button {
          padding: 0.45rem 0.9rem;
          font-size: 0.8rem
        }

        #edit-schedule-card .text-\[0\.7rem\]:last-child {
          margin-top: 0.75rem !important;
          font-size: 0.65rem !important
        }
      }
    }

    #notepad-card {
      width: min(100%, 680px);
      max-height: min(90vh, 760px);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      overflow: hidden
    }

    #rename-card,
    #delete-card {
      overflow: hidden
    }

    @supports (height:100dvh) {
      #notepad-card {
        max-height: min(90dvh, 760px)
      }
    }

    .notepad-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      min-height: 0
    }

    .notepad-header {
      display: flex;
      flex-direction: column;
      gap: 0.45rem
    }

    .notepad-header h2 {
      font-size: 1.45rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--primary-color)
    }

    .notepad-header p {
      color: rgba(226, 232, 240, 0.8);
      font-size: 0.95rem;
      margin-top: 0.35rem
    }

    .notepad-scroll-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      overflow-y: auto;
      padding-right: 0.35rem;
      margin-right: -0.35rem;
      padding-bottom: 1.25rem
    }

    .notepad-scroll-area::-webkit-scrollbar {
      width: 6px
    }

    .notepad-scroll-area::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 9999px
    }

    .notepad-tab-wrapper {
      display: flex;
      flex-direction: column;
      gap: 0.75rem
    }

    .notepad-tabs-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem
    }

    .notepad-tablist {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 0;
      margin-bottom: 0;
      scroll-snap-type: x mandatory
    }

    .notepad-tablist::-webkit-scrollbar {
      height: 6px
    }

    .notepad-tablist::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 9999px
    }

    .notepad-tab {
      position: relative;
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 44px;
      padding: 0 1.15rem;
      border-radius: 9999px;
      background: rgba(30, 30, 46, 0.88);
      color: var(--text);
      border: 1px solid var(--glass-border);
      box-shadow: var(--elev-1), inset 0 1px 0 0 rgba(205, 214, 244, 0.1);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      scroll-snap-align: center;
      isolation: isolate;
      overflow: hidden
    }

    .notepad-tab::before {
      content: none;
    }

    .notepad-tab:hover {
      border-color: rgba(205, 214, 244, 0.35);
      box-shadow: 0 18px 36px -18px rgba(255, 122, 31, 0.65)
    }

    .notepad-tab.is-active {
      background: rgba(255, 122, 31, 0.6);
      border: 1px solid rgba(205, 214, 244, 0.22);
      box-shadow: 0 18px 40px -18px var(--primary-color, 0.75), inset 0 1px 0 0 rgba(205, 214, 244, 0.2);
      overflow: visible
    }

    .notepad-tab.is-active::before {
      content: none;
    }

    .notepad-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 1rem
    }

    .notepad-editor-wrapper {
      width: 100%;
      border-radius: 1.25rem;
      border: 1px solid rgba(205, 214, 244, 0.15);
      background: rgb(255, 248, 210);
      overflow: hidden;
      transition: border-color 0.2s ease;
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      min-height: 0
    }

    .notepad-editor-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.65rem 1rem;
      background: transparent;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      gap: 0.5rem;
      flex-shrink: 0
    }

    .notepad-format-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      flex: 1;
      background: transparent;
      border: none
    }

    .notepad-toolbar .notepad-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem
    }

    .notepad-format-btn {
      flex: 1;
      height: 32px;
      border-radius: 0.45rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      color: rgba(18, 20, 25, 1);
      cursor: pointer;
      transition: transform 0.15s ease, background 0.15s ease, color 0.15s ease;
      position: relative;
      z-index: 1
    }

    .notepad-format-btn i {
      font-size: 1.05rem;
      pointer-events: none
    }

    .notepad-format-btn:hover {
      background: rgba(40, 45, 55, 0.12);
      color: rgba(18, 20, 25, 1);
      transform: scale(1.08)
    }

    .notepad-format-btn:active {
      transform: scale(0.92)
    }

    .notepad-format-btn:focus-visible {
      outline: 2px solid rgba(249, 226, 175, 0.5);
      outline-offset: 2px
    }

    .notepad-format-btn[data-active="true"] {
      background: rgba(255, 160, 50, 0.2);
      color: rgba(18, 20, 25, 1)
    }

    .notepad-toolbar .notepad-title {
      font-weight: 600;
      color: rgba(226, 232, 240, 0.92);
      font-size: 0.95rem;
      letter-spacing: 0.04em
    }

    .notepad-toolbar .notepad-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: rgba(148, 163, 184, 0.75)
    }

    .notepad-toolbar .notepad-indicator.is-saving {
      color: rgba(249, 226, 175, 0.85)
    }

    .notepad-toolbar .notepad-indicator.is-warning {
      color: rgba(243, 139, 168, 0.9)
    }

    .notepad-footer {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem
    }

    .notepad-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.5rem 0.85rem;
      border-radius: 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border: 1px solid rgba(205, 214, 244, 0.1);
      background: rgba(30, 30, 46, 0.6);
      color: rgba(186, 194, 222, 0.85);
      transition: transform 0.15s ease, background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px)
    }

    .notepad-action-btn:hover {
      transform: scale(1.03);
      border-color: rgba(205, 214, 244, 0.2);
      background: rgba(69, 71, 90, 0.7);
      color: var(--text)
    }

    .notepad-action-btn:active {
      transform: scale(0.97)
    }

    .notepad-action-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      transform: none;
      border-color: rgba(255, 255, 255, 0.08)
    }

    .notepad-action-btn.secondary {
      background: rgba(49, 50, 68, 0.5);
      color: var(--text);
      border-color: var(--glass-border)
    }

    .notepad-editor {
      width: 100%;
      min-height: clamp(220px, 32vh, 360px);
      padding: 1.25rem 1.5rem;
      border: none;
      background: transparent;
      color: rgba(20, 22, 28, 1);
      font-size: 0.95rem;
      line-height: 1.65;
      flex: 1 1 auto;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word
    }

    .notepad-editor:focus {
      outline: none
    }

    .notepad-editor-wrapper:focus-within {
      border-color: var(--primary-color, 0.55)
    }

    .notepad-editor:empty::before {
      content: attr(data-placeholder);
      color: rgba(60, 65, 75, 0.6);
      pointer-events: none;
      font-weight: 400
    }

    .notepad-editor[contenteditable="false"] {
      opacity: 0.5;
      pointer-events: none
    }

    .notepad-editor p,
    .notepad-editor div {
      margin: 0 0 0.75rem 0
    }

    .notepad-editor p:last-child,
    .notepad-editor div:last-child {
      margin-bottom: 0
    }

    .notepad-editor ul,
    .notepad-editor ol {
      margin: 0 0 0.9rem 0;
      padding-left: 1.45rem
    }

    .notepad-editor ul[data-list-type="checklist"] {
      list-style: none !important;
      list-style-type: none !important;
      padding-left: 0 !important;
      margin-left: 0
    }

    .notepad-editor ul[data-list-type="checklist"] li {
      display: flex !important;
      gap: 0.7rem;
      align-items: flex-start;
      padding: 0.25rem 0;
      padding-left: 0 !important;
      position: relative;
      list-style: none !important;
      list-style-type: none !important
    }

    .notepad-editor ul[data-list-type="checklist"] li::before,
    .notepad-editor ul[data-list-type="checklist"] li::marker {
      display: none !important;
      content: none !important
    }

    .notepad-editor ul:not([data-list-type="checklist"]) {
      list-style-type: disc;
      list-style-position: outside
    }

    .notepad-editor ol {
      list-style-type: decimal;
      list-style-position: outside
    }

    .notepad-editor ul:not([data-list-type="checklist"]) li,
    .notepad-editor ol li {
      margin: 0.25rem 0;
      padding-left: 0.5rem
    }

    .notepad-editor ul[data-list-type="checklist"] li.is-checked {
      color: rgba(148, 163, 184, 0.7);
      text-decoration: line-through
    }

    .notepad-check-handle {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 2px solid var(--overlay-1);
      background: rgba(30, 30, 46, 0.96);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s ease;
      cursor: pointer;
      padding: 0;
      margin-top: 0.2rem;
      appearance: none;
      -webkit-appearance: none;
      position: relative;
      z-index: 1;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      pointer-events: auto
    }

    .notepad-check-handle::before {
      content: "\2713";
      font-size: 0.9rem;
      color: rgba(30, 30, 46, 0.95);
      opacity: 0;
      transform: scale(0.7);
      transition: opacity 0.2s ease, transform 0.2s ease
    }

    .notepad-check-handle[data-checked="true"] {
      background: var(--primary-color);
      border-color: var(--primary-color)
    }

    .notepad-check-handle[data-checked="true"]::before {
      opacity: 1;
      transform: scale(1);
      color: rgba(30, 30, 46, 0.95)
    }

    .notepad-check-handle:hover {
      border-color: var(--lavender)
    }

    .notepad-check-handle:focus-visible {
      outline: 2px solid rgba(249, 226, 175, 0.55);
      outline-offset: 2px
    }

    .notepad-check-text {
      flex: 1 1 auto;
      min-width: 0;
      display: inline-block;
      word-break: break-word;
      outline: none;
      user-select: text;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text
    }

    .notepad-editor ul[data-list-type="checklist"] li>*:not(.notepad-check-handle) {
      flex: 1 1 auto;
      min-width: 0;
      display: inline-block;
      word-break: break-word
    }

    .notepad-hint {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.26em;
      color: rgba(148, 163, 184, 0.62)
    }

    @media (max-width:640px) {
      #notepad-modal {
        padding: clamp(1rem, 3vh, 1.75rem);
        align-items: flex-end;
        justify-content: flex-end
      }

      #notepad-card {
        max-width: 100%;
        border-radius: 1.75rem;
        max-height: calc(100vh - 1.5rem);
        gap: 1rem;
        padding: clamp(1.25rem, 4.5vw, 1.75rem);
        padding-top: clamp(1.5rem, 5.5vw, 2.25rem)
      }

      @supports (height:100dvh) {
        #notepad-card {
          max-height: calc(100dvh - 1.5rem)
        }
      }

      .notepad-body {
        gap: 1rem
      }

      .notepad-scroll-area {
        gap: 1.2rem;
        padding-bottom: max(1rem, env(safe-area-inset-bottom, 1rem))
      }

      .notepad-tabs-row {
        gap: 0.6rem;
        margin-bottom: 0.65rem
      }

      .notepad-header h2 {
        font-size: 1.22rem;
        letter-spacing: 0.06em
      }

      .notepad-header p {
        font-size: 0.82rem
      }

      .notepad-tablist {
        gap: 0.4rem
      }

      .notepad-tab {
        height: 40px;
        padding: 0 0.95rem;
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
        justify-content: center
      }

      .notepad-toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem
      }

      .notepad-toolbar .notepad-actions {
        width: 100%;
        justify-content: center;
        gap: 0.5rem
      }

      .notepad-editor-wrapper {
        flex: 0 0 auto !important;
        min-height: auto !important
      }

      .notepad-editor-toolbar {
        padding: 0.35rem 0.55rem
      }

      .notepad-format-toolbar {
        gap: 0.3rem
      }

      .notepad-format-btn {
        height: 28px;
        width: 28px;
        font-size: 0.9rem
      }

      .notepad-action-btn {
        flex: 1;
        justify-content: center;
        font-size: 0.7rem;
        padding: 0.5rem 0.7rem;
        letter-spacing: 0.1em
      }

      .notepad-footer {
        flex-direction: column;
        align-items: flex-start
      }

      .notepad-hint {
        font-size: 0.68rem;
        letter-spacing: 0.18em
      }

      .notepad-editor {
        height: 280px !important;
        min-height: 280px !important;
        max-height: 280px !important;
        flex: 0 0 280px !important;
        padding: 1.05rem 1.2rem
      }
    }

    .animated-check-container {
      width: clamp(28px, 5.5vw, 34px);
      height: clamp(28px, 5.5vw, 34px);
      min-width: clamp(28px, 5.5vw, 34px);
      min-height: clamp(28px, 5.5vw, 34px);
      flex-shrink: 0;
      cursor: pointer;
      transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)
    }

    .animated-check-container:hover {
      transform: scale(1.1)
    }

    .animated-check-container:active {
      transform: scale(0.95)
    }

    .animated-check-svg {
      width: 100%;
      height: 100%;
      display: block
    }

    .animated-check-circle {
      stroke: var(--surface-2);
      stroke-width: 3;
      fill: rgba(88, 91, 112, 0.25);
      transition: stroke 0.4s ease, fill 0.4s ease
    }

    .animated-check-path {
      stroke: var(--text);
      stroke-width: 4;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
      stroke-dasharray: 24;
      stroke-dashoffset: 24;
      transition: stroke-dashoffset 0.4s 0.1s ease-in-out
    }

    .animated-check-container.completed {
      animation: check-bounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)
    }

    .animated-check-container.completed .animated-check-circle {
      stroke: var(--green);
      fill: rgba(166, 227, 161, 0.22);
      animation: check-pulse 0.6s ease-out
    }

    .animated-check-container.completed .animated-check-path {
      stroke-dashoffset: 0;
      stroke: var(--green)
    }

    .completion-toggle-wrapper {
      min-height: clamp(48px, 9vw, 54px);
      flex-shrink: 0;
      padding: clamp(0.65rem, 1.2vw, 0.85rem) clamp(0.75rem, 1.5vw, 1rem);
      gap: clamp(0.6rem, 1.2vw, 0.85rem)
    }

    .completion-toggle-wrapper span {
      white-space: nowrap;
      font-size: clamp(0.85rem, 1.8vw, 1rem)
    }

    .header-background {
      background-image: url("src/imagens/capa de fundo.jpg");
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      position: relative;
      margin-top: calc(-1rem - 1.5rem);
      margin-left: -50vw;
      margin-right: -50vw;
      left: 50%;
      right: 50%;
      width: 100vw;
      padding-left: calc(50vw - 50%);
      padding-right: calc(50vw - 50%);
      padding-top: 1.5rem;
    }

    .header-background::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: -2px;
      background: linear-gradient(to bottom, rgba(36, 34, 52, 0.65) 0%, rgba(24, 22, 36, 0.78) 35%, rgba(13, 12, 19, 0.92) 80%, var(--background-dark) 100%);
      z-index: 1
    }

    [data-theme="claro"] .header-background::before {
      background: linear-gradient(to bottom, rgba(255, 235, 210, 0.6) 0%, rgba(248, 242, 255, 0.55) 30%, rgba(241, 244, 250, 0.85) 70%, var(--background-dark) 100%);
    }

    .header-background>* {
      position: relative;
      z-index: 2
    }

    #card-slider-container {
      -webkit-overflow-scrolling: touch
    }

    .card-slider-item {
      flex: 0 0 224px;
      height: 224px;
      scroll-snap-align: center;
      border-radius: 0.5rem;
      overflow: hidden;
      background-color: rgba(49, 50, 68, 0.4);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s ease, background-color 0.4s ease;
      transform: scale(0.85);
      opacity: 0.5;
      position: relative
    }

    .card-slider-item.is-active {
      transform: scale(1);
      opacity: 1;
      background-color: rgba(49, 50, 68, 0.5)
    }

    .card-slider-item img,
    .card-slider-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none
    }
  </style>
</head>

<body>

  <header class="text-center mb-10 header-background py-12">
    <div class="flex justify-center items-center h-32">
      <img src="src/imagens/HyperFitness.png" alt="HyperFitness Logo" class="h-24 md:h-32 w-auto" />
    </div>
  </header>

  <div id="main-content" class="container mx-auto p-4 md:p-6 max-w-6xl transition-all duration-500">

    <section id="phase-header" class="text-center mb-8 content-enter-animation" role="banner"></section>

    <nav class="glass-effect backdrop-blur-20 p-2 rounded-xl mb-8 content-enter-animation"
      aria-label="Navegação por semanas">
      <div id="stepper-nav" class="py-2 overflow-visible"></div>
    </nav>

    <nav id="day-selector" class="flex gap-1 mb-8 glass-effect backdrop-blur-20 p-2 rounded-xl content-enter-animation"
      aria-label="Seleção de dia de treino"></nav>

    <main id="current-workout-container">
      <header id="workout-title" class="text-center mb-4 min-h-[48px] content-enter-animation"></header>
      <div id="progress-bar-container" class="mb-8 px-2 content-enter-animation"></div>
      <section id="workout-details" class="grid grid-cols-1 md:grid-cols-2 gap-6"></section>
    </main>

  </div>

  <!-- Quick Actions Overlay com blur -->
  <div id="quick-actions-overlay" class="fixed inset-0 z-[45] opacity-0 invisible pointer-events-none" style="background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); transition: opacity 0.25s ease, visibility 0.25s ease;"></div>

  <!-- Quick Actions Toggle (fora do footer para z-index independente) -->
  <div id="quick-actions-container" class="fixed bottom-4 z-[46]">
    <div class="quick-actions-inner">
      <button id="quick-actions-toggle"
        class="quick-actions-toggle btn-theme-principal backdrop-blur-20 no-select touch-manipulation no-tap-highlight"
        type="button" aria-label="Abrir ações rápidas" aria-expanded="false" aria-controls="quick-actions-menu">
        <i class="ph-bold ph-plus" aria-hidden="true"></i>
      </button>

      <div id="quick-actions-menu" class="floating-actions-menu" role="menu" aria-hidden="true">
        <button type="button" data-action="notepad" aria-label="Abrir bloco de anotações" role="menuitem"
          tabindex="-1">
          <i class="ph-bold ph-note-pencil" aria-hidden="true"></i>
        </button>
        <button type="button" data-action="timer" aria-label="Abrir cronômetro" role="menuitem" tabindex="-1">
          <i class="ph-bold ph-timer" aria-hidden="true"></i>
        </button>
        <button type="button" data-action="music" aria-label="Abrir player de música" role="menuitem" tabindex="-1">
          <i class="ph-bold ph-music-notes-simple" aria-hidden="true"></i>
        </button>
        <button id="toggle-theme-btn" type="button" aria-label="Alternar tema" role="menuitem" tabindex="-1">
          <i class="ph-bold ph-moon-stars" aria-hidden="true"></i>
        </button>
      </div>
    </div>
  </div>

  <footer id="footer-container" class="fixed bottom-0 left-0 right-0 p-4 z-40">
    <div class="container mx-auto max-w-4xl">
      <div class="quick-actions-wrapper">
        <button id="complete-workout-btn" class="btn-theme-principal no-select touch-manipulation no-tap-highlight"
          type="button" aria-label="Concluir treino atual">
          <i class="ph-bold ph-checks text-2xl" aria-hidden="true"></i>
          Concluir Treino
        </button>
      </div>
    </div>
  </footer>

  <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[100]"
    aria-hidden="true"></canvas>

  <div id="edit-schedule-modal"
    class="fixed inset-0 bg-black/70 backdrop-blur-2xl z-50 flex items-center justify-center p-4 opacity-0 invisible transition-opacity duration-300"
    role="dialog" aria-labelledby="edit-title" aria-hidden="true">
    <div id="edit-schedule-card"
      class="modal-card relative w-full max-w-sm glass-effect rounded-3xl p-7 pt-9 transform scale-95 transition-all duration-300 overflow-hidden"
      tabindex="-1">

      <button id="close-edit-schedule-btn"
        class="absolute top-4 right-4 glass-effect text-white/90 w-11 h-11 rounded-full hover:bg-white/10 hover:text-white flex items-center justify-center z-30 transition-all transform hover:scale-110 hover:rotate-90 shadow-lg"
        aria-label="Fechar edição">
        <i class="ph-bold ph-x text-lg" aria-hidden="true"></i>
      </button>

      <div class="edit-header text-center mb-8">
        <h2 id="edit-title">Editar Treinos</h2>
        <p class="modal-subtitle">Personalize sua rotina para alcançar resultados máximos.</p>
      </div>

      <div id="edit-schedule-list" class="space-y-3 mb-8"></div>

      <div class="flex justify-end gap-3">
        <button id="cancel-edit-btn"
          class="px-5 py-2.5 bg-white/5 hover:bg-white/10 rounded-lg font-semibold transition-all text-sm border border-white/5"
          aria-label="Cancelar edição">Cancelar</button>
        <button id="save-edit-btn"
          class="px-5 py-2.5 bg-gradient-to-br from-[var(--primary-color)] to-[var(--primary-hover)] hover:shadow-lg rounded-lg font-bold text-white transition-all text-sm"
          aria-label="Salvar alterações">Salvar</button>
      </div>

      <div class="mt-8 text-[0.7rem] text-center uppercase tracking-[0.55em]" style="color:var(--overlay-1);">planeje
        com precisão</div>
    </div>
  </div>

  <div id="exercise-image-modal"
    class="fixed inset-0 bg-black/70 backdrop-blur-2xl z-60 flex items-center justify-center opacity-0 invisible transition-opacity duration-300"
    role="dialog" aria-labelledby="exercise-image-title" aria-hidden="true">
    <button id="close-exercise-image-btn"
      class="modal-close-btn glass-effect text-white/90 w-11 h-11 rounded-full hover:bg-white/10 hover:text-white flex items-center justify-center transition-all transform hover:scale-110 hover:rotate-90 shadow-lg no-tap-highlight touch-manipulation"
      aria-label="Fechar imagem do exercício" title="Fechar (Esc)">
      <i class="ph-bold ph-x text-lg" aria-hidden="true"></i>
    </button>
    <div id="exercise-image-content" class="relative" tabindex="-1">
      <img id="exercise-image" src="" alt="Imagem do exercício" />
    </div>
  </div>

  <div id="timer-modal"
    class="fixed inset-0 bg-black/70 backdrop-blur-2xl z-50 flex items-center justify-center p-4 opacity-0 invisible transition-opacity duration-300"
    role="dialog" aria-labelledby="timer-title" aria-hidden="true">
    <div id="timer-card"
      class="modal-card relative w-full max-w-sm glass-effect rounded-3xl p-7 pt-9 transform scale-95 transition-all duration-300 overflow-hidden"
      tabindex="-1">
      <button id="close-timer-btn"
        class="absolute top-4 right-4 glass-effect text-white/90 w-11 h-11 rounded-full hover:bg-white/10 hover:text-white flex items-center justify-center z-30 transition-all transform hover:scale-110 hover:rotate-90 shadow-lg"
        aria-label="Fechar cronômetro">
        <i class="ph-bold ph-x text-lg" aria-hidden="true"></i>
      </button>

      <div class="timer-header text-center mb-8">
        <h2 id="timer-title">Cronômetro</h2>
        <p class="modal-subtitle">Mantenha o foco absoluto em cada série.</p>
      </div>

      <div class="glass-effect rounded-2xl px-6 py-6 flex flex-col items-center gap-3 mb-8 border border-white/5">
        <div id="timer-display" class="timer-display" role="timer" aria-live="polite">00:00</div>
        <div id="timer-status" class="timer-status text-center" role="status" aria-live="polite">Pronto para iniciar
        </div>
      </div>

      <div class="timer-controls">
        <button id="timer-toggle-btn" class="timer-control-btn primary" type="button">
          <i id="timer-play-icon" class="ph-bold ph-play text-xl" aria-hidden="true"></i>
          <i id="timer-pause-icon" class="ph-bold ph-pause text-xl hidden" aria-hidden="true"></i>
          <span id="timer-toggle-label">Iniciar</span>
        </button>
        <button id="timer-reset-btn" class="timer-control-btn secondary" type="button" disabled>
          <i class="ph-bold ph-arrow-counter-clockwise text-xl" aria-hidden="true"></i>
          <span>Resetar</span>
        </button>
      </div>

      <div class="mt-8 text-[0.7rem] text-center uppercase tracking-[0.55em]" style="color:var(--overlay-1);">tempo sob
        controle</div>
    </div>
  </div>

  <div id="notepad-modal"
    class="fixed inset-0 bg-black/70 backdrop-blur-2xl z-50 flex items-center justify-center p-4 opacity-0 invisible transition-opacity duration-300"
    role="dialog" aria-labelledby="notepad-title" aria-hidden="true">
    <div id="notepad-card"
      class="modal-card relative w-full max-w-lg glass-effect rounded-3xl p-7 pt-9 transform scale-95 transition-all duration-300 overflow-hidden"
      tabindex="-1">
      <button id="close-notepad-btn"
        class="absolute top-4 right-4 glass-effect text-white/90 w-11 h-11 rounded-full hover:bg-white/10 hover:text-white flex items-center justify-center z-30 transition-all transform hover:scale-110 hover:rotate-90 shadow-lg"
        aria-label="Fechar bloco de anotações">
        <i class="ph-bold ph-x text-lg" aria-hidden="true"></i>
      </button>

      <div class="notepad-body">
        <div class="notepad-header text-center">
          <h2 id="notepad-title">Bloco de Anotações</h2>
          <p class="modal-subtitle">Centralize ajustes de treino, feedbacks e insights estratégicos.</p>
        </div>

        <div class="notepad-scroll-area">
          <div class="notepad-tab-wrapper">
            <div class="notepad-tabs-row">
              <div class="flex-1 overflow-hidden">
                <div id="notepad-pages-list" class="notepad-tablist scrollbar-hide" role="tablist"
                  aria-label="Páginas do bloco"></div>
              </div>
              <button id="notepad-add-page-btn"
                class="glass-effect text-white/90 w-11 h-11 rounded-full hover:bg-white/10 hover:text-white flex items-center justify-center transition-all transform hover:scale-110 active:scale-95 shadow-lg"
                type="button" aria-label="Adicionar nova página" title="Adicionar nova página">
                <i class="ph-bold ph-plus text-lg" aria-hidden="true"></i>
              </button>
            </div>
          </div>

          <div class="notepad-toolbar">
            <div>
              <div id="notepad-active-title" class="notepad-title">Página Atual</div>
              <div id="notepad-save-indicator" class="notepad-indicator">
                <i class="ph-bold ph-sparkle text-sm" aria-hidden="true"></i>
                Tudo salvo
              </div>
            </div>
            <div class="notepad-actions">
              <button id="notepad-rename-btn" class="notepad-action-btn" type="button" aria-label="Renomear página">
                <i class="ph-bold ph-textbox text-sm" aria-hidden="true"></i>
                Renomear
              </button>
              <button id="notepad-delete-btn" class="notepad-action-btn" type="button" aria-label="Excluir página">
                <i class="ph-bold ph-trash text-sm" aria-hidden="true"></i>
                Excluir
              </button>
            </div>
          </div>

          <label id="notepad-editor-label" class="sr-only" aria-hidden="true">Área de edição da página
            selecionada</label>
          <div class="notepad-editor-wrapper">
            <div class="notepad-editor-toolbar">
              <div class="notepad-format-toolbar" role="group" aria-label="Ferramentas de formatação">
                <button id="notepad-format-checklist" class="notepad-format-btn" type="button" data-command="checklist"
                  aria-label="Lista de verificação" title="Lista de verificação" aria-pressed="false">
                  <i class="ph-bold ph-check-square-offset" aria-hidden="true"></i>
                </button>
                <button id="notepad-format-bullet" class="notepad-format-btn" type="button" data-command="bullet"
                  aria-label="Lista com marcadores" title="Lista com marcadores" aria-pressed="false">
                  <i class="ph-bold ph-list-bullets" aria-hidden="true"></i>
                </button>
                <button id="notepad-format-number" class="notepad-format-btn" type="button" data-command="number"
                  aria-label="Lista numerada" title="Lista numerada" aria-pressed="false">
                  <i class="ph-bold ph-list-numbers" aria-hidden="true"></i>
                </button>
                <button id="notepad-format-paragraph" class="notepad-format-btn" type="button" data-command="paragraph"
                  aria-label="Texto padrão" title="Texto padrão" aria-pressed="false">
                  <i class="ph-bold ph-text-aa" aria-hidden="true"></i>
                </button>
              </div>
            </div>
            <div id="notepad-editor" class="notepad-editor" contenteditable="true" role="textbox" aria-multiline="true"
              aria-labelledby="notepad-editor-label" spellcheck="true"
              data-placeholder="Anote ajustes de treino, cargas, repetições, alimentação ou estados mentais. Tudo fica salvo automaticamente.">
            </div>
            <div id="notepad-char-counter" class="notepad-char-counter">0 / 280</div>
          </div>

          <div class="notepad-footer flex flex-wrap items-center justify-between gap-3">
            <div class="notepad-hint">Dica: crie páginas para fases, grupos musculares ou check-ins semanais.</div>
            <div id="notepad-updated-at" class="text-xs tracking-[0.18em] uppercase" style="color:var(--subtext-0);">
              Atualizado agora</div>
          </div>
        </div>
      </div>

      <div class="mt-6 text-[0.7rem] text-center uppercase tracking-[0.55em]" style="color:var(--overlay-1);">evolução
        documentada</div>
    </div>
  </div>

  <div id="rename-modal"
    class="fixed inset-0 bg-black/70 backdrop-blur-2xl z-[60] flex items-center justify-center p-4 opacity-0 invisible transition-opacity duration-300"
    role="dialog" aria-labelledby="rename-modal-title" aria-hidden="true">
    <div id="rename-card"
      class="modal-card relative w-full max-w-sm glass-effect rounded-3xl p-6 transform scale-95 transition-all duration-300"
      tabindex="-1">
      <button id="close-rename-btn"
        class="absolute top-4 right-4 glass-effect text-white/90 w-11 h-11 rounded-full hover:bg-white/10 hover:text-white flex items-center justify-center z-30 transition-all transform hover:scale-110 hover:rotate-90 shadow-lg"
        aria-label="Fechar renomear">
        <i class="ph-bold ph-x text-lg" aria-hidden="true"></i>
      </button>

      <div class="text-center mb-6">
        <h2 id="rename-modal-title" class="text-xl font-bold uppercase tracking-wider mb-2">Renomear Página</h2>
        <p class="text-sm" style="color:var(--subtext-1);">Digite o novo título para a página</p>
      </div>

      <div class="space-y-4">
        <div>
          <label for="rename-input" class="block text-sm font-medium mb-2" style="color:var(--subtext-1);">Título da
            Página</label>
          <input type="text" id="rename-input"
            class="w-full px-4 py-3 border border-white/10 rounded-xl text-white focus:outline-none focus:border-[var(--primary-color)] focus:ring-2 focus:ring-[var(--primary-color)]/20 transition-all"
            style="background:var(--surface-0);color:var(--text);" placeholder-style="color:var(--overlay-1);"
            placeholder="Digite o título..." maxlength="50" />
          <div class="mt-1 text-xs" style="color:var(--subtext-0);" id="rename-char-count">0 / 50</div>
        </div>

        <div class="flex gap-3">
          <button id="rename-cancel-btn"
            class="flex-1 px-4 py-3 text-white font-semibold rounded-xl transition-all transform hover:scale-105 active:scale-95"
            style="background:var(--surface-1);" onmouseover="this.style.background='var(--surface-2)'"
            onmouseout="this.style.background='var(--surface-1)'" type="button">
            Cancelar
          </button>
          <button id="rename-confirm-btn"
            class="flex-1 px-4 py-3 bg-[var(--primary-color)] hover:bg-[var(--primary-hover)] text-white font-semibold rounded-xl transition-all transform hover:scale-105 active:scale-95"
            type="button">
            Confirmar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="delete-modal"
    class="fixed inset-0 bg-black/70 backdrop-blur-2xl z-[60] flex items-center justify-center p-4 opacity-0 invisible transition-opacity duration-300"
    role="dialog" aria-labelledby="delete-modal-title" aria-hidden="true">
    <div id="delete-card"
      class="modal-card relative w-full max-w-sm glass-effect rounded-3xl p-6 transform scale-95 transition-all duration-300"
      tabindex="-1">
      <button id="close-delete-btn"
        class="absolute top-4 right-4 glass-effect text-white/90 w-11 h-11 rounded-full hover:bg-white/10 hover:text-white flex items-center justify-center z-30 transition-all transform hover:scale-110 hover:rotate-90 shadow-lg"
        aria-label="Fechar confirmação">
        <i class="ph-bold ph-x text-lg" aria-hidden="true"></i>
      </button>

      <div class="text-center mb-6">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
          <i class="ph-bold ph-trash text-3xl text-red-400" aria-hidden="true"></i>
        </div>
        <h2 id="delete-modal-title" class="text-xl font-bold uppercase tracking-wider mb-2">Excluir Página</h2>
        <p class="text-sm" style="color:var(--subtext-1);">Tem certeza que deseja excluir a página</p>
        <p class="text-base font-semibold text-white mt-2" id="delete-page-title"></p>
        <p class="text-xs mt-3" style="color:var(--subtext-0);">Esta ação não pode ser desfeita.</p>
      </div>

      <div class="flex gap-3">
        <button id="delete-cancel-btn"
          class="flex-1 px-4 py-3 text-white font-semibold rounded-xl transition-all transform hover:scale-105 active:scale-95"
          style="background:var(--surface-1);" onmouseover="this.style.background='var(--surface-2)'"
          onmouseout="this.style.background='var(--surface-1)'" type="button">
          Cancelar
        </button>
        <button id="delete-confirm-btn"
          class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-all transform hover:scale-105 active:scale-95"
          type="button">
          Excluir
        </button>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    (function () {
      const THEME_KEY = 'hf_theme';
      function applyTheme(theme) {
        const root = document.documentElement;
        if (!theme) return;
        root.setAttribute('data-theme', theme);
      }
      function getSavedTheme() {
        try { return localStorage.getItem(THEME_KEY) || 'escuro'; } catch { return 'escuro'; }
      }
      function saveTheme(theme) {
        try { localStorage.setItem(THEME_KEY, theme); } catch { }
      }
      function updateThemeButtonIcon(theme) {
        const btn = document.getElementById('toggle-theme-btn');
        if (!btn) return;
        const icon = btn.querySelector('i');
        if (!icon) return;
        if (theme === 'escuro') {
          icon.className = 'ph-bold ph-sun';
          btn.setAttribute('aria-label', 'Alternar para tema claro');
          btn.title = 'Tema claro';
        } else {
          icon.className = 'ph-bold ph-moon-stars';
          btn.setAttribute('aria-label', 'Alternar para tema escuro');
          btn.title = 'Tema escuro';
        }
      }
      function toggleTheme() {
        const current = getSavedTheme();
        const next = current === 'escuro' ? 'claro' : 'escuro';
        saveTheme(next);
        applyTheme(next);
        updateThemeButtonIcon(next);
      }

      const initial = getSavedTheme();
      applyTheme(initial);

      document.addEventListener('DOMContentLoaded', function () {
        const btn = document.getElementById('toggle-theme-btn');
        if (btn) {
          btn.addEventListener('click', toggleTheme);
          updateThemeButtonIcon(getSavedTheme());
        }
      });
    })();

    const WORKOUT_PHASES = {
      phase1: {
        title: "Fase 1: Adaptação", weeks: [1],
        schedule: { Seg: "A", Ter: "B", Qua: "C", Qui: "A", Sex: "B", Sáb: "OFF", Dom: "OFF" },
        workouts: {
          A: { name: "Treino A - Puxar", exercises: [{ name: "Pulley Frente Aberto", series: "3", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Puxada Triângulo", series: "3", rept: "15 a 20", descanso: "1 Min", method: "Convencional" }, { name: "Remada Serrote", series: "3", rept: "15 a 20", descanso: "1 Min", method: "Convencional" }, { name: "Remada Baixa Triângulo", series: "3", rept: "15 a 20", descanso: "1 Min", method: "Convencional" }, { name: "Rosca Direta Barra Reta", series: "3", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Tríceps Corda", series: "3", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Rosca Martelo + Tríceps Francês (Corda)", series: "3", rept: "15 a 20", descanso: "1 Min", method: "BI-SET" },] },
          B: { name: "Treino B - Pernas", exercises: [{ name: "Cadeira Extensora", series: "3", rept: "8 a 12", descanso: "90 seg", method: "Convencional" }, { name: "Leg Press 45", series: "3", rept: "8 a 12", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Adutora", series: "3", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Extensora (2)", series: "3", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Flexora", series: "4", rept: "8 a 12", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Abdutora", series: "3", rept: "15 a 20", descanso: "90 seg", method: "Convencional" },] },
          C: { name: "Treino C - Empurrar", exercises: [{ name: "Supino Inclinado Máquina", series: "3", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Crucifixo Inclinado", series: "3", rept: "15 a 20", descanso: "60 seg", method: "Isometria" }, { name: "Supino Reto Máquina", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Desenvolvimento Máquina Aberto", series: "3", rept: "8 a 12", descanso: "60 seg", method: "Conv+Isometria" }, { name: "Elevação Lateral", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Convencional" }, { name: "Tríceps Paralela", series: "3", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Tríceps Corda", series: "3", rept: "15 a 20", descanso: "60 seg", method: "Convencional" },] },
        },
      },
      phase2: {
        title: "Fase 2: Aumento de Volume", weeks: [2, 3, 4, 5, 6],
        schedule: { Seg: "A", Ter: "B", Qua: "C", Qui: "OFF", Sex: "D", Sáb: "E", Dom: "OFF" },
        workouts: {
          A: { name: "Treino A - Ombros", exercises: [{ name: "Desenvolvimento Máquina", series: "4", rept: "20/18/15/12", descanso: "1 Min", method: "Pirâmide Crescente" }, { name: "Elevação Lateral na Polia", series: "4", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Elevação Lateral com Halter", series: "4", rept: "15 a 20", descanso: "1 Min", method: "Drop Set 1 descida" }, { name: "Elevação Frontal na Polia", series: "3", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Elevação Frontal Barra", series: "3", rept: "15 a 20", descanso: "1 Min", method: "Convencional" }, { name: "Crucifixo Inverso Máquina", series: "3", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Pull Face", series: "3", rept: "15 a 20", descanso: "1 Min", method: "Drop Set 1 descida" },] },
          B: { name: "Treino B - Quadríceps", exercises: [{ name: "Cadeira Extensora", series: "3", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Leg Press 45", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Agachamento Hack", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Cadeira Adutora", series: "4", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Extensora", series: "4", rept: "15 a 20", descanso: "90 seg", method: "Drop Set 1 descida" }, { name: "Panturrilha em Pé Máquina", series: "6", rept: "15 a 20", descanso: "45 seg", method: "Convencional" },] },
          C: { name: "Treino C - Costas e Bíceps", exercises: [{ name: "Puxada Frente Aberta", series: "4", rept: "20/18/15/12", descanso: "60 seg", method: "Pirâmide Crescente" }, { name: "Barra Fixa", series: "3", rept: "Falha", descanso: "60 seg", method: "Convencional" }, { name: "Remada na Máquina Articulada", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Remada Baixa Triângulo", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set 1 descida" }, { name: "Remada Pronada na Máquina", series: "3", rept: "15 a 20", descanso: "60 seg", method: "Convencional" }, { name: "Rosca Direta Barra W", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Rosca Scott na Máquina com Barra W", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set 1 descida" },] },
          D: { name: "Treino D - Peito e Tríceps", exercises: [{ name: "Supino Inclinado Máquina", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Pirâmide Crescente" }, { name: "Crucifixo Inclinado", series: "3", rept: "15 a 20", descanso: "60 seg", method: "Convencional" }, { name: "Supino Reto Máquina", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Crucifixo Máquina Reto", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set 1 descida" }, { name: "Tríceps Paralela", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Tríceps Corda", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set 1 descida" },] },
          E: { name: "Treino E - Posterior e Glúteo", exercises: [{ name: "Mesa Flexora", series: "3", rept: "8 a 12", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Flexora", series: "4", rept: "12 a 15", descanso: "90 seg", method: "Drop Set 1 descida" }, { name: "Stiff", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Cadeira Abdutora", series: "3", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Elevação Pélvica com Barra", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Panturrilha em Pé Máquina", series: "5", rept: "15 a 20", descanso: "90 seg", method: "Convencional" },] },
        },
      },
      phase3: {
        title: "Fase 3: Mais Volume e Técnicas", weeks: [7, 8, 9, 10],
        schedule: { Seg: "A", Ter: "B", Qua: "C", Qui: "OFF", Sex: "D", Sáb: "E", Dom: "OFF" },
        workouts: {
          A: { name: "Treino A - Ombros", exercises: [{ name: "Desenvolvimento Máquina", series: "4", rept: "20/18/15/12", descanso: "1 Min", method: "Pirâmide Crescente" }, { name: "Elevação Lateral na Polia", series: "4", rept: "8 a 12", descanso: "1 Min", method: "Rest Pause Última Série" }, { name: "Elevação Lateral com Halter", series: "4", rept: "15 a 20", descanso: "1 Min", method: "Drop Set Todas as Séries" }, { name: "Elevação Frontal na Polia", series: "4", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Elevação Frontal Barra", series: "4", rept: "15 a 20", descanso: "1 Min", method: "Rest Pause Última Série" }, { name: "Crucifixo Inverso Máquina", series: "4", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Pull Face", series: "4", rept: "15 a 20", descanso: "1 Min", method: "Drop Set Todas as Séries" },] },
          B: { name: "Treino B - Quadríceps", exercises: [{ name: "Cadeira Extensora", series: "4", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Leg Press 45", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Agachamento Hack", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Agachamento Smith", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Cadeira Adutora", series: "4", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Extensora", series: "4", rept: "15 a 20", descanso: "90 seg", method: "Drop Set Todas as Séries" }, { name: "Panturrilha em Pé Máquina", series: "6", rept: "15 a 20", descanso: "45 seg", method: "Convencional" },] },
          C: { name: "Treino C - Costas e Bíceps", exercises: [{ name: "Puxada Frente Aberta", series: "4", rept: "20/18/15/12", descanso: "60 seg", method: "Pirâmide Crescente" }, { name: "Barra Fixa", series: "4", rept: "Falha", descanso: "60 seg", method: "Rest Pause Última Série" }, { name: "Remada na Máquina Articulada", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Remada Baixa Triângulo", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set Todas as Séries" }, { name: "Remada Pronada na Máquina", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Convencional" }, { name: "Rosca Direta Barra W", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Rosca Scott na Máquina com Barra W", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Rest Pause Última Série" }, { name: "Rosca Spider com Barra W", series: "3", rept: "15 a 20", descanso: "60 seg", method: "Drop Set Todas as Séries" },] },
          D: { name: "Treino D - Peito e Tríceps", exercises: [{ name: "Supino Inclinado Máquina", series: "4", rept: "20/18/15/12", descanso: "60 seg", method: "Pirâmide Crescente" }, { name: "Crucifixo Inclinado", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Convencional" }, { name: "Supino Reto Máquina", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Crucifixo Máquina Reto", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set 1 descida" }, { name: "Tríceps Paralela", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Tríceps Corda", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set 1 descida" },] },
          E: { name: "Treino E - Posterior e Glúteo", exercises: [{ name: "Mesa Flexora", series: "3", rept: "8 a 12", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Flexora", series: "4", rept: "12 a 15", descanso: "90 seg", method: "Drop Set 1 descida" }, { name: "Stiff", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Cadeira Abdutora", series: "3", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Elevação Pélvica com Barra", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Panturrilha em Pé Máquina", series: "5", rept: "15 a 20", descanso: "90 seg", method: "Convencional" },] },
        },
      },
      phase4: {
        title: "Fase 4: Método MAIS CINCO", weeks: [11, 12],
        schedule: { Seg: "A", Ter: "B", Qua: "C", Qui: "OFF", Sex: "D", Sáb: "E", Dom: "OFF" },
        workouts: {
          A: { name: "Treino A - Ombros", exercises: [{ name: "Desenvolvimento Máquina", series: "4", rept: "20/18/15/12", descanso: "90 Seg", method: "Pirâmide + MAIS CINCO" }, { name: "Elevação Lateral Polia", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Elevação Lateral com Halter", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Elevação Frontal na Polia", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Elevação Frontal Barra", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Crucifixo Inverso Máquina", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Pull Face", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" },] },
          B: { name: "Treino B - Quadríceps", exercises: [{ name: "Cadeira Extensora", series: "4", rept: "15 a 20", descanso: "2 Min", method: "MAIS CINCO" }, { name: "Leg Press 45", series: "4", rept: "20/18/15/12", descanso: "2 Min", method: "Pirâmide + MAIS CINCO" }, { name: "Agachamento Hack", series: "4", rept: "20/18/15/12", descanso: "2 Min", method: "Pirâmide + MAIS CINCO" }, { name: "Agachamento Smith", series: "4", rept: "20/18/15/12", descanso: "2 Min", method: "Pirâmide + MAIS CINCO" }, { name: "Cadeira Adutora", series: "4", rept: "15 a 20", descanso: "2 Min", method: "MAIS CINCO" }, { name: "Cadeira Extensora", series: "4", rept: "15 a 20", descanso: "2 Min", method: "MAIS CINCO" }, { name: "Panturrilha em Pé Máquina", series: "6", rept: "15 a 20", descanso: "45 seg", method: "MAIS CINCO" },] },
          C: { name: "Treino C - Costas e Bíceps", exercises: [{ name: "Puxada Frente Aberta", series: "4", rept: "20/18/15/12", descanso: "90 Seg", method: "Pirâmide + MAIS CINCO" }, { name: "Barra Fixa", series: "4", rept: "Falha", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Remada na Máquina Articulada", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Remada Baixa Triângulo", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Remada Pronada na Máquina", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Rosca Direta Barra W", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Rosca Scott na Máquina com Barra W", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Rosca Spider com Barra W", series: "3", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" },] },
          D: { name: "Treino D - Peito e Tríceps", exercises: [{ name: "Supino Inclinado Máquina", series: "4", rept: "20/18/15/12", descanso: "90 Seg", method: "Pirâmide + MAIS CINCO" }, { name: "Crucifixo Inclinado", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Supino Reto Máquina", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Crucifixo Máquina Reto", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Tríceps Francês Corda", series: "3", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Tríceps Paralela", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Tríceps Corda", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" },] },
          E: { name: "Treino E - Posterior e Glúteo", exercises: [{ name: "Mesa Flexora", series: "4", rept: "8 a 12", descanso: "2 Min", method: "MAIS CINCO" }, { name: "Cadeira Flexora", series: "4", rept: "12 a 15", descanso: "2 Min", method: "MAIS CINCO" }, { name: "Stiff", series: "4", rept: "20/18/15/12", descanso: "2 Min", method: "Pirâmide + MAIS CINCO" }, { name: "Cadeira Abdutora", series: "4", rept: "15 a 20", descanso: "2 Min", method: "MAIS CINCO" }, { name: "Elevação Pélvica com Barra", series: "4", rept: "20/18/15/12", descanso: "2 Min", method: "Pirâmide + MAIS CINCO" }, { name: "Panturrilha em Pé Máquina", series: "5", rept: "15 a 20", descanso: "2 Min", method: "MAIS CINCO" },] },
        },
      },
    };

    const APP_STATE = {
      currentWeekNumber: 1,
      currentDay: "Seg",
      highestUnlockedWeek: 1,
      highestUnlockedDayIndex: 0,
      completionStatus: {},
      allCompletions: {},
      confettiLaunched: {},
      seriesTracker: {}
    };

    const DOM_ELEMENTS = {};
    let confettiInstance;
    let scrollObserver;
    const REST_COUNTDOWNS = new Map();
    const REPS_TOOLTIP_TIMEOUTS = new Map();
    let repsOutsideClickBound = false;
    const METHOD_TOOLTIP_TIMEOUTS = new Map();
    let methodOutsideClickBound = false;
    const METHOD_DESCRIPTION_MAP = Object.freeze({
      'convencional': 'execução tradicional com foco total na técnica',
      'conv isometria': 'combine repetições tradicionais com uma pausa isométrica no pico da contração',
      'isometria': 'segure o pico de contração por 2-3 segundos em cada repetição',
      'piramide': 'varie a carga e repetições de forma crescente ou decrescente',
      'piramide crescente': 'aumente a carga a cada série enquanto reduz levemente as repetições',
      'piramide decrescente': 'reduza a carga progressivamente a cada série mantendo o volume',
      'piramide mais cinco': 'após as pirâmides, adicione 5 repetições extras assistidas ou parciais',
      'mais cinco': 'chegue à falha e complete 5 repetições adicionais assistidas ou parciais',
      'drop set': 'ao falhar, reduza a carga e continue sem descanso',
      'drop set 1 descida': 'realize uma queda de carga após a falha e continue',
      'drop set 2 descidas': 'execute duas reduções de carga consecutivas após a falha',
      'drop set todas as series': 'em todas as séries, ao chegar na falha reduza a carga e continue',
      'rest pause': 'alcance a falha, descanse 10-15 segundos e repita com a mesma carga',
      'rest pause ultima serie': 'somente a última série recebe pausa curta após a falha para estender o esforço',
      'falha': 'siga até não conseguir mais uma repetição com boa forma',
      'bi set': 'combine dois exercícios sem descanso entre eles',
      'tri set': 'execute três exercícios na sequência sem descanso',
      'super set': 'una dois exercícios focados em grupos musculares opostos ou complementares',
      'pico de contracao': 'enfatize a contração máxima mantendo 1-2 segundos no topo',
      'tempo controlado': 'mantenha cadência cadenciada (ex.: 3-1-1) em cada repetição',
      'negativa': 'realce a fase excêntrica descendo em 4-5 segundos',
      'isometrico': 'segure a posição de maior tensão pelo tempo indicado',
      'clusters': 'faça mini-blocos de 2-3 reps com micro descansos de 10-15 segundos',
      'cluster': 'divida a série em blocos com mini descansos para força máxima',
      'forcada': 'após a falha, receba ajuda para completar mais repetições',
      'tempo': 'controle a cadência conforme indicado, evitando movimentos balísticos',
      'tempo 3 0 3': 'cadência 3-0-3: 3s descendo, 0s de pausa, 3s subindo',
      'tempo 3 1 1': 'cadência 3-1-1: 3s descendo, 1s em isometria, 1s subindo',
      'tempo 4 0 2': 'cadência 4-0-2: 4s descendo, 0s pausa, 2s subindo',
      'a falha': 'continue até o limite técnico, mantendo postura e amplitude seguras',
      'piramide invertida': 'comece pesado e reduza a carga a cada série para manter reps',
      'piramide regressiva': 'reduza progressivamente a carga, mantendo intensidade alta',
      'piramide progressiva': 'aumente gradualmente a carga após aquecer com reps maiores',
      'rest pause 2 mini series': 'faça 2 mini séries após a falha com descansos curtos',
      'rest pause 3 mini series': 'faça 3 mini séries após a falha com descansos curtos',
      'passada continua': 'mantenha movimento contínuo sem travar as articulações',
      'pre exaustao': 'fatigue o músculo alvo com um isolador antes do composto',
      'post exaustao': 'finalize com um isolador após o movimento composto para exaurir fibras',
      'tensao continua': 'não relaxe no topo/inferior; mantenha tensão todo o tempo',
      'isometria final': 'encerre com uma pausa isométrica prolongada ao fim da série',
      'tempo lento': 'movimente-se lentamente para aumentar o tempo sob tensão',
      'tempo rapido': 'execute com explosão controlada mantendo segurança',
      'isometria inicial': 'inicie a série segurando alguns segundos na fase de alongamento',
      'angiogenesis': 'mantenha alto volume para estimular vascularização',
      'contagem 21': '21s: faça 7 reps meia amplitude baixa, 7 meia amplitude alta, 7 completas',
      'contagem 30': 'execute 30 reps contínuas com carga moderada focando em resistência',
      'contracao maxima': 'busque a contração máxima em cada repetição com foco mente-músculo',
      'alongamento forçado': 'após a série, mantenha alongamento profundo por 20-30 segundos',
      'pre exaustao isolador': 'inicie com exercício isolador para pré-fatigar o músculo alvo',
      'post exaustao isolador': 'complemente com isolador após composto para esgotar as fibras',
      'piramide completa': 'eleve e reduza a carga dentro das mesmas repetições planejadas',
      'piramide dupla': 'suba e desça duas vezes dentro do mesmo bloco de séries',
      'gota': 'estratégia de drop set: reduza carga e siga lutando pela falha',
      'retracao escapular': 'mantenha escápulas estáveis e retraídas para proteger ombros',
      'tecnica': 'priorize técnica perfeita, ritmo controlado e amplitude completa',
      'metodo': '{method}'
    });
    const CARD_PARALLAX_STATE = {
      observer: null,
      rafId: null,
      items: new Map(),
      initialized: false
    };
    const PREFERS_REDUCED_MOTION_QUERY = typeof window !== "undefined" && window.matchMedia ? window.matchMedia('(prefers-reduced-motion: reduce)') : null;
    let appInitialized = false;

    function createElement(tag, className = '', innerHTML = '') {
      const element = document.createElement(tag);
      if (className) element.className = className;
      if (innerHTML) element.innerHTML = innerHTML;
      return element;
    }

    function addEventListenerSafe(element, event, handler, options = {}) {
      if (element) {
        element.addEventListener(event, handler, options);
      }
    }

    // Helper para adicionar listener de fechar modal ao clicar no backdrop
    function addBackdropCloseListener(modal, closeHandler) {
      modal?.addEventListener('click', (event) => {
        if (event.target === modal) closeHandler();
      });
    }

    // Helper para parar propagação de evento
    function stopEvent(event) {
      event.preventDefault();
      event.stopPropagation();
    }

    function showCompletionMessage() {
      const modal = createElement("div", "fixed inset-0 bg-black/70 flex items-center justify-center z-[200] p-4");
      modal.innerHTML = `
        <div class="rounded-lg p-8 text-center shadow-2xl content-enter-animation" style="background: var(--surface-0); border: 1px solid var(--surface-2);">
          <h2 class="text-3xl font-bold text-[var(--primary-color)] mb-4">Parabéns!</h2>
          <p class="text-white text-lg mb-6">Você concluiu o programa de 12 semanas!</p>
          <button id="close-modal-btn" class="bg-[var(--primary-color)] text-white font-bold py-2 px-6 rounded-lg hover:bg-[var(--primary-hover)] no-select touch-manipulation no-tap-highlight">Fechar</button>
        </div>
      `;
      document.body.appendChild(modal);

      const fireConfetti = () => confettiInstance({
        particleCount: 150,
        spread: 90,
        origin: { y: 0.6 },
        colors: ["var(--primary-color)", "var(--primary-hover)", "#f9e2af", "#cdd6f4"]
      });

      fireConfetti();
      const confettiInterval = setInterval(fireConfetti, 3000);

      addEventListenerSafe(document.getElementById("close-modal-btn"), "click", () => {
        clearInterval(confettiInterval);
        modal.remove();
      }, { once: true });
    }

    function showNotification(message, type = 'error') {
      const bgColor = type === 'error' ? 'bg-red-600' : 'bg-green-600';
      const notification = createElement("div", `fixed top-5 right-5 ${bgColor} text-white text-sm font-bold px-4 py-3 rounded-lg shadow-lg z-[200] content-enter-animation`);
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = "0";
        notification.style.transition = "opacity 0.5s ease-out";
        setTimeout(() => notification.remove(), 500);
      }, 3000);
    }

    function areAllWeekWorkoutsCompleted(weekNumber) {
      const phaseData = getPhaseDataByWeek(weekNumber);
      if (!phaseData) return false;
      const { schedule, workouts } = phaseData;
      return Object.keys(schedule).every(day => {
        const workoutLetter = schedule[day];
        if (workoutLetter === "OFF") return true;
        const workout = workouts[workoutLetter];
        if (!workout) return true;
        const completionKey = `week${weekNumber}-${day}`;
        const dayCompletions = APP_STATE.allCompletions[completionKey] || {};
        return Object.values(dayCompletions).filter(Boolean).length >= workout.exercises.length;
      });
    }

    function hasPreviousUncompletedWorkouts(weekNumber, currentDay) {
      const phaseData = getPhaseDataByWeek(weekNumber);
      if (!phaseData) return false;

      const schedule = phaseData.schedule;
      const dayKeys = Object.keys(schedule);
      const currentDayIndex = dayKeys.indexOf(currentDay);

      for (let i = 0; i < currentDayIndex; i++) {
        const day = dayKeys[i];
        const workoutLetter = schedule[day];

        if (workoutLetter !== "OFF") {
          const workout = phaseData.workouts[workoutLetter];
          if (workout) {
            const totalExercises = workout.exercises.length;
            const completionKey = `week${weekNumber}-${day}`;
            const dayCompletions = APP_STATE.allCompletions[completionKey] || {};
            const completedCount = Object.values(dayCompletions).filter(Boolean).length;

            if (completedCount < totalExercises) {
              return true;
            }
          }
        }
      }
      return false;
    }

    function updateProgressAfterScheduleChange() {
      const phaseData = getPhaseDataByWeek(APP_STATE.currentWeekNumber);
      if (!phaseData) return;
      const dayKeys = Object.keys(phaseData.schedule);
      if (APP_STATE.currentWeekNumber === APP_STATE.highestUnlockedWeek) {
        const currentDayIndex = dayKeys.indexOf(APP_STATE.currentDay);
        APP_STATE.highestUnlockedDayIndex = currentDayIndex !== -1 ? currentDayIndex : dayKeys.findIndex(d => phaseData.schedule[d] !== "OFF") || 0;
      }
    }

    function resetApplicationState() {
      localStorage.clear();
      Object.assign(APP_STATE, {
        currentWeekNumber: 1,
        currentDay: "Seg",
        highestUnlockedWeek: 1,
        highestUnlockedDayIndex: 0,
        completionStatus: {},
        allCompletions: {},
        confettiLaunched: {},
        seriesTracker: {}
      });
      console.warn("Application state was reset.");
    }

    function resetWorkout() {
      const key = getCompletionKey();
      APP_STATE.completionStatus = {};

      if (APP_STATE.allCompletions[key]) {
        APP_STATE.allCompletions[key] = {};
      }

      delete APP_STATE.confettiLaunched[key];
      if (APP_STATE.seriesTracker[key]) {
        delete APP_STATE.seriesTracker[key];
      }

      saveApplicationState();
      renderWorkoutDetails();
    }

    function getCompletionKey(weekNumber = APP_STATE.currentWeekNumber, day = APP_STATE.currentDay) {
      return `week${weekNumber}-${day}`;
    }

    function saveApplicationState() {
      const progressData = {
        highestUnlockedWeek: APP_STATE.highestUnlockedWeek,
        highestUnlockedDayIndex: APP_STATE.highestUnlockedDayIndex,
        allCompletions: APP_STATE.allCompletions,
        confettiLaunched: APP_STATE.confettiLaunched,
        seriesTracker: APP_STATE.seriesTracker
      };

      localStorage.setItem("workoutProgress", JSON.stringify(progressData));

      const customSchedules = Object.fromEntries(Object.entries(WORKOUT_PHASES).map(([key, phase]) => [key, phase.schedule]));
      localStorage.setItem("customSchedules", JSON.stringify(customSchedules));
    }

    function loadApplicationState() {
      try {

        const savedSchedules = JSON.parse(localStorage.getItem("customSchedules") || "{}");
        Object.keys(savedSchedules).forEach(key => {
          if (WORKOUT_PHASES[key]) WORKOUT_PHASES[key].schedule = savedSchedules[key];
        });

        const savedState = JSON.parse(localStorage.getItem("workoutProgress"));
        if (!savedState || typeof savedState.highestUnlockedWeek !== 'number') return;

        let { highestUnlockedWeek, highestUnlockedDayIndex, allCompletions, confettiLaunched, seriesTracker } = savedState;

        if (highestUnlockedWeek < 1 || highestUnlockedWeek > 12) {
          throw new Error("Invalid week");
        }

        const phaseData = getPhaseDataByWeek(highestUnlockedWeek);
        if (!phaseData) throw new Error("Invalid phase data");

        const dayKeys = Object.keys(phaseData.schedule);
        if (highestUnlockedDayIndex < 0 || highestUnlockedDayIndex >= dayKeys.length) {
          highestUnlockedDayIndex = 0;
        }

        Object.assign(APP_STATE, {
          highestUnlockedWeek,
          currentWeekNumber: highestUnlockedWeek,
          highestUnlockedDayIndex,
          currentDay: dayKeys[highestUnlockedDayIndex],
          allCompletions: allCompletions || {},
          confettiLaunched: confettiLaunched || {},
          seriesTracker: seriesTracker || {}
        });

        loadCurrentCompletionStatus();
      } catch (error) {
        console.error("Failed to load state, resetting.", error);
        resetApplicationState();
      }
    }

    function getPhaseDataByWeek(weekNumber) {
      return Object.values(WORKOUT_PHASES).find(p => p.weeks.includes(weekNumber)) || null;
    }

    function getPhaseKeyByWeek(weekNumber) {
      return Object.keys(WORKOUT_PHASES).find(key =>
        WORKOUT_PHASES[key].weeks.includes(weekNumber)) || null;
    }

    function loadCurrentCompletionStatus() {
      const key = getCompletionKey();
      APP_STATE.completionStatus = APP_STATE.allCompletions[key] || {};
    }

    function getDayCompletionStats(weekNumber, day) {
      const phaseData = getPhaseDataByWeek(weekNumber);
      if (!phaseData) {
        return { totalExercises: 0, completedExercises: 0, hasWorkout: false };
      }

      const workoutLetter = phaseData.schedule[day];
      if (!workoutLetter || workoutLetter === "OFF") {
        return { totalExercises: 0, completedExercises: 0, hasWorkout: false };
      }

      const workout = phaseData.workouts[workoutLetter];
      if (!workout || !Array.isArray(workout.exercises)) {
        return { totalExercises: 0, completedExercises: 0, hasWorkout: false };
      }

      const completionKey = getCompletionKey(weekNumber, day);
      const dayCompletions = APP_STATE.allCompletions[completionKey] || {};
      const completedExercises = Object.values(dayCompletions).filter(Boolean).length;

      return {
        totalExercises: workout.exercises.length,
        completedExercises,
        hasWorkout: workout.exercises.length > 0
      };
    }

    function renderStepperNavigation() {
      DOM_ELEMENTS.stepperNav.innerHTML = "";
      const container = document.createElement("div");
      container.className = "relative w-full px-1 md:px-2";

      const track = document.createElement("div");
      track.className = "absolute top-1/2 -translate-y-1/2 left-0 w-full h-1 rounded-full";
      track.style.background = "var(--surface-1)";

      const progressPercentage = APP_STATE.highestUnlockedWeek > 1 ? ((APP_STATE.highestUnlockedWeek - 1) / 11) * 100 : 0;
      const progressFill = document.createElement("div");
      progressFill.className = "absolute top-1/2 -translate-y-1/2 left-0 h-1 bg-[var(--primary-color)] rounded-full transition-all duration-500";
      progressFill.style.width = `${progressPercentage}%`;

      container.append(track, progressFill);

      const markersContainer = document.createElement("div");
      markersContainer.className = "relative flex justify-between items-center px-1 md:px-0";

      for (let i = 1; i <= 12; i++) {
        markersContainer.appendChild(createWeekMarker(i));
      }

      container.appendChild(markersContainer);
      DOM_ELEMENTS.stepperNav.appendChild(container);
    }

    function createWeekMarker(weekNumber) {
      const isLocked = weekNumber > APP_STATE.highestUnlockedWeek;
      const isCurrent = weekNumber === APP_STATE.currentWeekNumber;
      const isCompleted = weekNumber < APP_STATE.highestUnlockedWeek;

      const markerWrapper = document.createElement("div");
      markerWrapper.className = `group relative flex flex-col items-center p-0.5 md:p-2 ${isLocked ? "cursor-not-allowed" : "cursor-pointer"}`;

      if (!isLocked) {
        addEventListenerSafe(markerWrapper, "click", () => navigateToWeek(weekNumber));
      }

      const marker = document.createElement("div");
      let markerClasses = "rounded-full transition-all duration-300 flex items-center justify-center border-2";

      if (isCurrent) {
        markerClasses += " w-3 h-3 md:w-4 md:h-4 bg-[var(--primary-color)] border-[var(--primary-hover)] scale-150 current-week-marker-animation";
      } else if (isCompleted) {
        markerClasses += " w-3 h-3 md:w-4 md:h-4 border-[var(--primary-color)]";
        marker.style.background = "var(--surface-0)";
      } else if (isLocked) {
        markerClasses += " w-5 h-5 md:w-6 md:h-6";
        marker.style.background = "var(--surface-0)";
        marker.style.borderColor = "var(--overlay-0)";
        const icon = weekNumber === 12 ? "ph-trophy text-amber-400 trophy-shine" : "ph-lock-key";
        marker.innerHTML = `<i class='ph-fill ${icon} text-xs md:text-sm'></i>`;
      } else {
        markerClasses += " w-3 h-3 md:w-4 md:h-4";
        marker.style.background = "var(--overlay-0)";
        marker.style.borderColor = "var(--surface-2)";
      }

      marker.className = markerClasses;

      const tooltip = document.createElement("span");
      tooltip.className = "step-tooltip";
      tooltip.textContent = `Semana ${weekNumber}`;

      markerWrapper.append(tooltip, marker);
      return markerWrapper;
    }

    function navigateToWeek(weekNumber) {
      APP_STATE.currentWeekNumber = weekNumber;
      const newPhaseData = getPhaseDataByWeek(weekNumber);
      const dayKeys = Object.keys(newPhaseData.schedule);
      APP_STATE.currentDay = (weekNumber === APP_STATE.highestUnlockedWeek)
        ? dayKeys[APP_STATE.highestUnlockedDayIndex]
        : dayKeys.find(d => newPhaseData.schedule[d] !== "OFF") || dayKeys[0];
      loadCurrentCompletionStatus();
      renderAllComponents();
    }

    function renderPhaseHeader() {
      const phaseData = getPhaseDataByWeek(APP_STATE.currentWeekNumber);
      if (phaseData) {
        DOM_ELEMENTS.phaseHeader.innerHTML = `
            <h2 class="phase-title text-4xl font-black tracking-tight" style="color: #ff7a1f; position: relative; display: inline-block;">${phaseData.title}</h2>
            <p class="text-lg font-light mt-1" style="color: var(--subtext-1);">Semana ${APP_STATE.currentWeekNumber} de 12</p>
          `;
      }
    }

    function renderDaySelector() {
      const phaseData = getPhaseDataByWeek(APP_STATE.currentWeekNumber);
      const dayKeys = Object.keys(phaseData.schedule);
      DOM_ELEMENTS.daySelector.innerHTML = "";

      dayKeys.forEach((day, index) => {
        DOM_ELEMENTS.daySelector.appendChild(createDayButton(day, index, phaseData));
      });

      const editButton = createEditButton();
      DOM_ELEMENTS.daySelector.appendChild(editButton);
    }

    function createDayButton(day, index, phaseData) {
      const workoutLetter = phaseData.schedule[day];
      const button = document.createElement("button");
      button.textContent = day;

      const dayKeys = Object.keys(phaseData.schedule);
      const currentDayIndex = dayKeys.indexOf(APP_STATE.currentDay);

      const isPastDay = APP_STATE.currentWeekNumber < APP_STATE.highestUnlockedWeek ||
        (APP_STATE.currentWeekNumber === APP_STATE.highestUnlockedWeek && index < APP_STATE.highestUnlockedDayIndex);
      const isCurrentDay = APP_STATE.currentDay === day;
      const isOffDay = workoutLetter === "OFF";
      const isBeforeCurrentDay = currentDayIndex !== -1 && index < currentDayIndex;

      const { totalExercises, completedExercises, hasWorkout } = getDayCompletionStats(APP_STATE.currentWeekNumber, day);
      const isComplete = hasWorkout && totalExercises > 0 && completedExercises >= totalExercises;
      const hasAnyProgress = hasWorkout && completedExercises > 0;
      const shouldFlagIncomplete = hasWorkout && !isCurrentDay && !isComplete && (isPastDay || isBeforeCurrentDay || hasAnyProgress);

      let buttonClasses = "flex-1 px-1 sm:px-2 py-2 text-xs sm:text-sm rounded-lg font-bold transition-all duration-300 text-center transform hover:-translate-y-1 whitespace-nowrap ";

      if (isOffDay) {
        buttonClasses += "bg-transparent cursor-default hover:transform-none font-light";
        button.style.color = "var(--overlay-0)";
        button.disabled = true;
        button.dataset.status = "off";
        button.title = "Dia de descanso";
      } else if (isCurrentDay) {
        buttonClasses += "bg-[var(--primary-color)] text-white shadow-lg shadow-[var(--primary-color)]/30";
        button.dataset.status = "current";
        if (hasWorkout) {
          button.title = `${completedExercises} de ${totalExercises} exercícios concluídos`;
        }
      } else if (shouldFlagIncomplete) {
        buttonClasses += "bg-red-600/70 text-red-100 hover:bg-red-500/70";
        button.dataset.status = "incomplete";
        if (hasWorkout) {
          button.title = `${completedExercises} de ${totalExercises} exercícios concluídos`;
        }
      } else if (isComplete) {
        buttonClasses += "bg-green-600/50 text-green-200 hover:bg-green-500/50";
        button.dataset.status = "complete";
        button.title = `${completedExercises} de ${totalExercises} exercícios concluídos`;
      } else {
        buttonClasses += "hover:bg-zinc-600/70";
        button.style.background = "var(--surface-1)";
        button.style.color = "var(--subtext-1)";
        button.dataset.status = "pending";
        if (hasWorkout) {
          button.title = `${completedExercises} de ${totalExercises} exercícios concluídos`;
        }
      }

      button.className = buttonClasses;

      if (!isOffDay) {
        addEventListenerSafe(button, "click", () => navigateToDay(day));
      }

      return button;
    }

    function createEditButton() {
      const editButton = document.createElement("button");
      editButton.className = "flex-shrink-0 flex items-center justify-center p-2 rounded-lg hover:text-[var(--primary-color)] transition-colors duration-200 whitespace-nowrap";
      editButton.style.color = "var(--subtext-0)";
      editButton.onmouseover = function () { this.style.background = 'var(--surface-1)'; };
      editButton.onmouseout = function () { this.style.background = 'transparent'; };
      editButton.innerHTML = '<i class="ph-bold ph-pencil-simple text-lg sm:text-xl"></i>';
      editButton.title = "Editar treinos da semana";
      addEventListenerSafe(editButton, "click", openEditModal);
      return editButton;
    }

    function navigateToDay(day) {
      APP_STATE.currentDay = day;
      loadCurrentCompletionStatus();
      renderWorkoutDetails();
      renderDaySelector();
    }

    function renderWorkoutDetails() {
      const phaseData = getPhaseDataByWeek(APP_STATE.currentWeekNumber);
      if (!phaseData) return;

      const workoutLetter = phaseData.schedule[APP_STATE.currentDay];
      DOM_ELEMENTS.workoutDetails.innerHTML = "";
      DOM_ELEMENTS.workoutTitle.innerHTML = "";
      DOM_ELEMENTS.progressBarContainer.innerHTML = "";
      DOM_ELEMENTS.footer.style.display = "none";

      if (workoutLetter === "OFF" || !phaseData.workouts[workoutLetter]) {
        DOM_ELEMENTS.workoutTitle.innerHTML = `<h2 class="text-2xl font-light text-slate-400">Dia de Descanso</h2>`;
        refreshCardParallax();
        return;
      }

      DOM_ELEMENTS.footer.style.display = "block";
      const workout = phaseData.workouts[workoutLetter];
      DOM_ELEMENTS.workoutTitle.innerHTML = `<h2 class="text-3xl font-bold text-white">${workout.name}</h2>`;

      const totalExercises = workout.exercises.length;
      const completedExercises = Object.values(APP_STATE.completionStatus).filter(Boolean).length;
      const progress = totalExercises > 0 ? (completedExercises / totalExercises) * 100 : 0;

      updateWorkoutButton(completedExercises >= totalExercises);
      renderProgressBar(completedExercises, totalExercises, progress);

      getSeriesTrackerForCurrentWorkout();

      const fragment = document.createDocumentFragment();
      workout.exercises.forEach((ex, idx) => fragment.appendChild(createExerciseCard(ex, idx)));
      DOM_ELEMENTS.workoutDetails.appendChild(fragment);
      refreshCardParallax();

      const backToTopBtn = document.createElement('div');
      backToTopBtn.className = 'col-span-full flex justify-center mt-8 mb-4';
      backToTopBtn.innerHTML = `
        <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="hover:text-white px-6 py-3 font-light transition-all duration-300 transform hover:-translate-y-1 flex items-center gap-2" style="color: var(--subtext-0);">
          <i class="ph-light ph-arrow-up text-lg"></i>
          Voltar ao Topo
        </button>
      `;
      DOM_ELEMENTS.workoutDetails.appendChild(backToTopBtn);

      DOM_ELEMENTS.workoutDetails.querySelectorAll('.scroll-animate').forEach(card => scrollObserver?.observe(card));
    }

    function updateWorkoutButton(allDone) {
      const { currentWeekNumber, currentDay, highestUnlockedWeek, highestUnlockedDayIndex } = APP_STATE;
      const phaseData = getPhaseDataByWeek(currentWeekNumber);
      const dayKeys = Object.keys(phaseData.schedule);
      const currentDayIndex = dayKeys.indexOf(currentDay);

      const isPastWorkout = currentWeekNumber < highestUnlockedWeek || (currentWeekNumber === highestUnlockedWeek && currentDayIndex < highestUnlockedDayIndex);
      const hasPreviousUncompleted = hasPreviousUncompletedWorkouts(currentWeekNumber, currentDay);
      const isAheadOfProgression = currentWeekNumber > highestUnlockedWeek || (currentWeekNumber === highestUnlockedWeek && currentDayIndex > highestUnlockedDayIndex);

      const config = {
        variant: "primary",
        icon: "ph-checks",
        text: "Concluir Treino",
        disabled: false
      };

      if (hasPreviousUncompleted || isAheadOfProgression) {
        Object.assign(config, { variant: "warning", icon: "ph-warning", text: "Conclua treinos anteriores", disabled: true });
      } else if (allDone) {
        if (isPastWorkout) {
          Object.assign(config, { variant: "amber", icon: "ph-arrow-counter-clockwise", text: "Recomeçar Treino" });
        } else {
          Object.assign(config, { variant: "success", icon: "ph-arrow-right", text: "Avançar Treino" });
        }
      }

      const button = DOM_ELEMENTS.completeWorkoutBtn;
      if (config.variant && config.variant !== "primary") {
        button.dataset.variant = config.variant;
      } else {
        delete button.dataset.variant;
      }

      button.innerHTML = `<i class="ph-bold ${config.icon} text-2xl"></i> ${config.text}`;
      button.disabled = config.disabled;
      button.setAttribute("aria-label", config.text);
      button.setAttribute("aria-disabled", String(config.disabled));
      button.title = config.text;
    }

    function renderProgressBar(completed, total, progress) {
      DOM_ELEMENTS.progressBarContainer.innerHTML = `
        <div class="flex justify-between items-center mb-1 text-base font-light">
          <span style="color: var(--subtext-0);">Progresso do Treino</span>
          <span class="font-semibold text-white">${completed} / ${total}</span>
        </div>
        <div class="w-full rounded-full h-2.5 overflow-hidden" style="background: var(--surface-1);">
          <div class="bg-[var(--primary-color)] h-2.5 rounded-full transition-all duration-500 progress-bar-striped" style="width: ${progress}%"></div>
        </div>
      `;
    }

    function createExerciseCard(exercise, index) {
      const isCompleted = !!APP_STATE.completionStatus[index];
      const isPastWorkout = isPastWorkoutCheck();
      const isLocked = isPastWorkout && isCompleted;
      const imageUrl = getExerciseImageUrl(exercise.name);

      const card = document.createElement("div");
      card.className = `workout-card relative rounded-3xl shadow-xl shadow-black/20 border transition-all duration-300 flex flex-col justify-end group scroll-animate cursor-pointer ${isCompleted ? "exercise-completed" : ""
        }`;
      if (isCompleted) {
        card.style.borderColor = "rgba(166, 227, 161, 0.6)";
      } else {
        card.style.borderColor = "var(--surface-0)";
      }

      card.dataset.imageUrl = imageUrl;

      card.innerHTML = createExerciseCardHTML(exercise, index, isCompleted, isLocked);

      addEventListenerSafe(card, 'click', (event) => {
        const isCompletionButton = event.target.closest('.completion-toggle-wrapper');
        if (!isCompletionButton) {
          stopEvent(event);
          openExerciseImageModal(imageUrl);
        }
      });

      initializeExerciseStats(card, index);
      initializeMethodBadge(card, index);
      return card;
    }

    function isPastWorkoutCheck() {
      const phaseData = getPhaseDataByWeek(APP_STATE.currentWeekNumber);
      const dayKeys = Object.keys(phaseData.schedule);
      const currentDayIndex = dayKeys.indexOf(APP_STATE.currentDay);
      return APP_STATE.currentWeekNumber < APP_STATE.highestUnlockedWeek ||
        (APP_STATE.currentWeekNumber === APP_STATE.highestUnlockedWeek && currentDayIndex < APP_STATE.highestUnlockedDayIndex);
    }

    function createMethodBadgeHTML(exercise, index) {
      const method = exercise.method || "Método";
      const methodSegments = parseMethodSegments(method);
      const tooltipSegments = methodSegments.length ? methodSegments : [method];
      const formattedSegments = tooltipSegments.map(segment => formatMethodTooltipSegment(segment, method));

      return `
        <button type="button" class="exercise-method-pill glass-effect no-tap-highlight touch-manipulation" data-method-badge data-exercise-index="${index}" aria-expanded="false">
          <i class="ph-bold ph-info method-icon" aria-hidden="true"></i>
          <span class="method-label">${escapeHTML(method)}</span>
          <span class="method-tooltip" role="dialog" aria-label="Detalhes do método">
            ${formattedSegments.map(segment => `<span>${escapeHTML(segment)}</span>`).join('')}
          </span>
        </button>
      `;
    }

    function createExerciseCardHTML(exercise, index, isCompleted, isLocked) {
      const imageUrl = getExerciseImageUrl(exercise.name);
      return `
        <div class="absolute inset-0 overflow-hidden rounded-3xl">
          <img src="${imageUrl}"
            alt="Ilustração do exercício ${exercise.name}" class="exercise-card-image" data-parallax-image>
          <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-t from-black/90 via-black/60 to-transparent"></div>
        </div>

        <div class="relative z-10 p-4 flex flex-col justify-end flex-grow">
          <div>
            ${createMethodBadgeHTML(exercise, index)}
            <h3 class="text-2xl font-black text-white tracking-tight leading-tight">${exercise.name}</h3>
          </div>
        </div>

        <div class="relative z-10 p-4 space-y-4 bg-gradient-to-t from-black/50 to-transparent rounded-b-3xl">
          ${createExerciseStatsHTML(exercise, index)}
          ${createCompletionButtonHTML(index, isCompleted, isLocked)}
        </div>
      `;
    }

    function initializeCardParallaxSystem() {
      if (CARD_PARALLAX_STATE.initialized) return;

      CARD_PARALLAX_STATE.observer = new IntersectionObserver(handleCardParallaxIntersection, {
        root: null,
        rootMargin: "0px",
        threshold: 0
      });

      const scrollHandler = () => scheduleCardParallaxUpdate();
      window.addEventListener('scroll', scrollHandler, { passive: true });
      window.addEventListener('resize', scrollHandler);

      if (PREFERS_REDUCED_MOTION_QUERY) {
        const motionHandler = () => {
          CARD_PARALLAX_STATE.items.forEach(({ image }) => {
            image.style.setProperty('--card-parallax-offset', '0px');
          });
          scheduleCardParallaxUpdate();
        };

        if (typeof PREFERS_REDUCED_MOTION_QUERY.addEventListener === 'function') {
          PREFERS_REDUCED_MOTION_QUERY.addEventListener('change', motionHandler);
        } else if (typeof PREFERS_REDUCED_MOTION_QUERY.addListener === 'function') {
          PREFERS_REDUCED_MOTION_QUERY.addListener(motionHandler);
        }
      }

      CARD_PARALLAX_STATE.initialized = true;
    }

    function refreshCardParallax() {
      if (!CARD_PARALLAX_STATE.initialized || !CARD_PARALLAX_STATE.observer) return;

      CARD_PARALLAX_STATE.items.forEach((_, card) => {
        CARD_PARALLAX_STATE.observer.unobserve(card);
      });
      CARD_PARALLAX_STATE.items.clear();

      const cards = document.querySelectorAll('.workout-card');
      cards.forEach(card => {
        const image = card.querySelector('[data-parallax-image]');
        if (!image) return;
        image.style.setProperty('--card-parallax-offset', '0px');
        CARD_PARALLAX_STATE.observer.observe(card);
      });

      scheduleCardParallaxUpdate();
    }

    function handleCardParallaxIntersection(entries) {
      entries.forEach(entry => {
        const card = entry.target;
        if (!entry.isIntersecting) {
          CARD_PARALLAX_STATE.items.delete(card);
          return;
        }

        const image = card.querySelector('[data-parallax-image]');
        if (!image) return;

        CARD_PARALLAX_STATE.items.set(card, { image });
      });

      scheduleCardParallaxUpdate();
    }

    function scheduleCardParallaxUpdate() {
      if (!CARD_PARALLAX_STATE.initialized) return;
      if (CARD_PARALLAX_STATE.rafId !== null) return;

      CARD_PARALLAX_STATE.rafId = window.requestAnimationFrame(updateCardParallaxPositions);
    }

    function updateCardParallaxPositions() {
      CARD_PARALLAX_STATE.rafId = null;
      const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 1;
      const viewportCenter = viewportHeight / 2;

      CARD_PARALLAX_STATE.items.forEach(({ image }, card) => {
        if (!image || !card.isConnected) {
          CARD_PARALLAX_STATE.items.delete(card);
          return;
        }

        if (PREFERS_REDUCED_MOTION_QUERY && PREFERS_REDUCED_MOTION_QUERY.matches) {
          image.style.setProperty('--card-parallax-offset', '0px');
          return;
        }

        const rect = card.getBoundingClientRect();
        const cardCenter = rect.top + rect.height / 2;
        const distanceFromCenter = cardCenter - viewportCenter;
        const normalized = distanceFromCenter / viewportHeight;
        const offset = Math.max(-18, Math.min(18, normalized * -42));

        image.style.setProperty('--card-parallax-offset', `${offset.toFixed(2)}px`);
      });
    }

    function createExerciseStatsHTML(exercise, index) {
      const repsSegments = parseRepetitionSegments(exercise.rept);
      const encodedSegments = repsSegments.map(segment => segment.replace(/\|/g, '/')).join('|');
      const restSeconds = parseRestToSeconds(exercise.descanso);
      const restLabel = formatRestLabel(exercise.descanso);

      return `
        <div class="exercise-stats-chip-group">
          <button type="button" class="exercise-stat-button glass-effect" data-stat-type="series" data-exercise-index="${index}" data-total-series="${parseTotalSeries(exercise.series) || ''}" data-original-value="${escapeHTML(exercise.series)}" aria-pressed="false">
            <span class="chip-header">
              <i class="ph-bold ph-stack-simple stat-icon" aria-hidden="true"></i>
              <span class="stat-label">Séries</span>
            </span>
            <span class="stat-value" data-role="series-value">${escapeHTML(exercise.series)}</span>
            <span class="stat-helper">Toque para registrar</span>
            <div class="stat-progress-bar" aria-hidden="true">
              <span class="stat-progress-fill"></span>
            </div>
          </button>
          <button type="button" class="exercise-stat-button glass-effect" data-stat-type="reps" data-exercise-index="${index}" data-reps="${escapeHTML(encodedSegments)}">
            <span class="chip-header">
              <i class="ph-bold ph-repeat stat-icon" aria-hidden="true"></i>
              <span class="stat-label">Reps</span>
            </span>
            <span class="stat-value">${escapeHTML(exercise.rept)}</span>
            <span class="stat-helper">Toque para detalhes</span>
            <div class="stat-details" role="dialog" aria-label="Detalhes das repetições">
              ${repsSegments.length ? repsSegments.map(segment => `<span>${escapeHTML(segment)}</span>`).join('') : `<span>${escapeHTML(exercise.rept || 'Sem dados')}</span>`}
            </div>
          </button>
          <button type="button" class="exercise-stat-button glass-effect" data-stat-type="rest" data-exercise-index="${index}" data-rest-seconds="${restSeconds || ''}" data-original-value="${escapeHTML(restLabel)}" aria-live="polite">
            <span class="chip-header">
              <i class="ph-bold ph-timer stat-icon" aria-hidden="true"></i>
              <span class="stat-label">Descanso</span>
            </span>
            <span class="stat-value" data-role="rest-value">${escapeHTML(restLabel)}</span>
            <span class="stat-helper" data-role="rest-helper">Toque para iniciar</span>
            <div class="stat-progress-bar" aria-hidden="true">
              <span class="stat-progress-fill"></span>
            </div>
          </button>
        </div>
      `;
    }

    function parseTotalSeries(seriesValue) {
      if (seriesValue === null || seriesValue === undefined) return null;
      const match = String(seriesValue).match(/\d+/);
      return match ? parseInt(match[0], 10) : null;
    }

    function parseMethodSegments(methodValue) {
      if (!methodValue && methodValue !== 0) return [];
      const normalized = String(methodValue).replace(/\s+/g, ' ').trim();
      if (!normalized) return [];

      const separatorRegex = /\s*(?:\+|\/|\||;|·|•)\s*|\s*,\s*/;
      const rawSegments = normalized.split(separatorRegex)
        .map(segment => segment.trim())
        .filter(Boolean);

      if (rawSegments.length <= 1) {
        return [normalized];
      }

      const uniqueSegments = [];
      const seen = new Set();
      rawSegments.forEach(segment => {
        const key = segment.toLowerCase();
        if (!seen.has(key)) {
          seen.add(key);
          uniqueSegments.push(segment);
        }
      });

      return uniqueSegments;
    }

    function formatMethodTooltipSegment(segment, fullMethod = '') {
      const descriptions = getMethodDescriptions();
      const normalizedKey = normalizeMethodKey(segment);
      const description = descriptions[normalizedKey];

      if (!description) {
        return segment.trim();
      }

      if (description.includes('{segment}')) {
        return description.replace('{segment}', segment.trim());
      }

      if (description.includes('{method}')) {
        return description.replace('{method}', fullMethod.trim());
      }

      return `${segment.trim()} — ${description}`;
    }

    function normalizeMethodKey(segment) {
      return segment
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, ' ')
        .trim();
    }

    function getMethodDescriptions() {
      return METHOD_DESCRIPTION_MAP;
    }

    function parseRepetitionSegments(repsValue) {
      if (!repsValue && repsValue !== 0) return [];
      const value = String(repsValue).trim();
      if (!value) return [];

      const normalized = value.replace(/\s+/g, ' ');
      if (normalized.includes('/')) {
        return normalized.split('/').map((segment, index) => `${index + 1}ª série: ${segment.trim()}`.trim());
      }

      if (normalized.includes(',')) {
        return normalized.split(',').map(part => part.trim()).filter(Boolean);
      }

      const rangeMatch = normalized.match(/^(\d+(?:,\d+)?)\s*(?:a|-)\s*(\d+(?:,\d+)?)/i);
      if (rangeMatch) {
        const min = rangeMatch[1].replace(',', '.');
        const max = rangeMatch[2].replace(',', '.');
        return [`Mínimo sugerido: ${min}`, `Máximo sugerido: ${max}`];
      }

      if (/falha/i.test(normalized)) {
        return ["Ir até a falha controlada"];
      }

      return [normalized];
    }

    function parseRestToSeconds(restValue) {
      if (!restValue && restValue !== 0) return null;
      const normalized = String(restValue).trim().toLowerCase().replace(',', '.');
      if (!normalized || /livre|auto|flexível/.test(normalized)) return null;

      const minuteMatch = normalized.match(/(\d+(?:\.\d+)?)\s*(?:min|minuto|minutos|m)/);
      const secondMatch = normalized.match(/(\d+(?:\.\d+)?)\s*(?:seg|segundo|segundos|s)/);
      const onlyNumber = normalized.match(/^(\d+(?:\.\d+)?)/);

      let seconds = null;
      if (minuteMatch) {
        seconds = parseFloat(minuteMatch[1]) * 60;
      } else if (secondMatch) {
        seconds = parseFloat(secondMatch[1]);
      } else if (onlyNumber) {
        const value = parseFloat(onlyNumber[1]);
        seconds = value > 10 ? value : value * 60;
      }

      if (Number.isNaN(seconds) || seconds === null) return null;
      return Math.round(seconds);
    }

    function formatRestLabel(restValue) {
      if (!restValue && restValue !== 0) return "Livre";
      const normalized = String(restValue).trim().replace(/\s{2,}/g, ' ');
      return normalized || "Livre";
    }

    // Função unificada de formatação de tempo
    function formatTime(value, { inputUnit = 'ms', showHours = 'auto' } = {}) {
      const totalSeconds = Math.max(0, Math.floor(inputUnit === 'ms' ? value / 1000 : value));
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      const pad = (v) => String(v).padStart(2, '0');
      
      const includeHours = showHours === true || (showHours === 'auto' && hours > 0);
      return includeHours 
        ? `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`
        : `${pad(minutes)}:${pad(seconds)}`;
    }

    // Aliases para compatibilidade
    const formatSecondsToClock = (seconds) => formatTime(seconds, { inputUnit: 's' });
    const formatDuration = (ms) => formatTime(ms, { inputUnit: 'ms' });

    function getSeriesTrackerForCurrentWorkout() {
      const key = getCompletionKey();
      if (!APP_STATE.seriesTracker[key]) {
        APP_STATE.seriesTracker[key] = {};
      }
      return APP_STATE.seriesTracker[key];
    }

    function initializeExerciseStats(card, index) {
      const seriesButton = card.querySelector(`.exercise-stat-button[data-stat-type="series"][data-exercise-index="${index}"]`);
      const repsButton = card.querySelector(`.exercise-stat-button[data-stat-type="reps"][data-exercise-index="${index}"]`);
      const restButton = card.querySelector(`.exercise-stat-button[data-stat-type="rest"][data-exercise-index="${index}"]`);

      if (seriesButton) {
        setupSeriesButton(seriesButton, index);
      }
      if (repsButton) {
        setupRepsButton(repsButton);
      }
      if (restButton) {
        setupRestButton(restButton, index);
      }
    }

    function initializeMethodBadge(card, index) {
      const methodButton = card.querySelector(`.exercise-method-pill[data-exercise-index="${index}"]`);
      if (methodButton) {
        setupMethodButton(methodButton);
      }
    }

    function setupSeriesButton(button, index) {
      const total = parseInt(button.dataset.totalSeries, 10);
      const helper = button.querySelector('.stat-helper');
      const tracker = getSeriesTrackerForCurrentWorkout();
      const storedValue = tracker[index];
      const current = typeof storedValue === 'number' ? storedValue : 0;

      button.dataset.seriesTotal = Number.isFinite(total) ? String(total) : '';
      button.dataset.seriesCurrent = String(current);

      if (!Number.isFinite(total) || total <= 0) {
        helper && (helper.textContent = 'Informativo');
        button.style.cursor = 'default';
        button.setAttribute('aria-disabled', 'true');
        const valueEl = button.querySelector('[data-role="series-value"]');
        if (valueEl) {
          valueEl.textContent = button.dataset.originalValue || '--';
        }
        const fillEl = button.querySelector('.stat-progress-fill');
        fillEl && (fillEl.style.width = '0%');
        return;
      }

      updateSeriesButtonDisplay(button, current, total);

      addEventListenerSafe(button, 'click', (event) => {
        stopEvent(event);
        handleSeriesButtonPress(button, index, total);
      });
    }

    function handleSeriesButtonPress(button, index, total) {
      const tracker = getSeriesTrackerForCurrentWorkout();
      const currentStored = tracker[index] || 0;
      const nextValue = currentStored >= total ? 0 : currentStored + 1;

      if (nextValue === 0) {
        delete tracker[index];
      } else {
        tracker[index] = nextValue;
      }

      updateSeriesButtonDisplay(button, nextValue, total);
      button.dataset.seriesCurrent = String(nextValue);
      button.setAttribute('aria-pressed', nextValue > 0 ? 'true' : 'false');
      saveApplicationState();
    }

    function updateSeriesButtonDisplay(button, current, total) {
      const valueEl = button.querySelector('[data-role="series-value"]');
      const helper = button.querySelector('.stat-helper');
      const fillEl = button.querySelector('.stat-progress-fill');

      if (valueEl) {
        valueEl.textContent = `${current}/${total}`;
      }

      if (helper) {
        helper.textContent = current >= total ? 'Séries completas' : current > 0 ? 'Toque para avançar' : 'Toque para registrar';
      }

      const progress = total > 0 ? Math.min(1, current / total) : 0;
      fillEl && (fillEl.style.width = `${(progress * 100).toFixed(1)}%`);

      button.classList.toggle('is-active', current > 0 && current < total);
      button.classList.toggle('is-complete', current >= total && total > 0);
    }

    function setupRestButton(button, index) {
      const seconds = parseInt(button.dataset.restSeconds, 10);
      const helper = button.querySelector('[data-role="rest-helper"]');

      button.dataset.timerKey = `${getCompletionKey()}-${index}`;

      if (!Number.isFinite(seconds) || seconds <= 0) {
        helper && (helper.textContent = 'Descanso livre');
        button.style.cursor = 'default';
        addEventListenerSafe(button, 'click', (event) => {
          stopEvent(event);
        });
        return;
      }

      addEventListenerSafe(button, 'click', (event) => {
        stopEvent(event);
        handleRestButtonClick(button, seconds);
      });
    }

    function handleRestButtonClick(button, seconds) {
      if (button.dataset.timerRunning === 'true') {
        stopRestCountdown(button, { userCancelled: true });
      } else {
        startRestCountdown(button, seconds);
      }
    }

    function startRestCountdown(button, seconds) {
      clearPendingRestReset(button);
      stopRestCountdown(button);

      const key = button.dataset.timerKey;
      const valueEl = button.querySelector('[data-role="rest-value"]');
      const helper = button.querySelector('[data-role="rest-helper"]');
      const fillEl = button.querySelector('.stat-progress-fill');

      const startedAt = Date.now();
      button.dataset.timerRunning = 'true';
      button.classList.remove('finished');
      button.classList.add('is-counting');
      button.setAttribute('aria-pressed', 'true');
      helper && (helper.textContent = 'toque para cancelar');
      valueEl && (valueEl.textContent = formatSecondsToClock(seconds));
      fillEl && (fillEl.style.width = '0%');

      const intervalId = window.setInterval(() => {
        const elapsed = Math.floor((Date.now() - startedAt) / 1000);
        const remaining = Math.max(0, seconds - elapsed);
        const progress = seconds > 0 ? Math.min(1, (seconds - remaining) / seconds) : 1;

        valueEl && (valueEl.textContent = formatSecondsToClock(remaining));
        fillEl && (fillEl.style.width = `${(progress * 100).toFixed(1)}%`);

        if (remaining <= 0) {
          stopRestCountdown(button, { completed: true });
        }
      }, 250);

      REST_COUNTDOWNS.set(key, intervalId);
    }

    function stopRestCountdown(button, options = {}) {
      const { completed = false } = options;
      const key = button.dataset.timerKey;
      const intervalId = REST_COUNTDOWNS.get(key);
      if (intervalId) {
        clearInterval(intervalId);
        REST_COUNTDOWNS.delete(key);
      }

      const valueEl = button.querySelector('[data-role="rest-value"]');
      const helper = button.querySelector('[data-role="rest-helper"]');
      const fillEl = button.querySelector('.stat-progress-fill');

      button.dataset.timerRunning = 'false';
      button.classList.remove('is-counting');
      button.setAttribute('aria-pressed', 'false');

      if (completed) {
        button.classList.add('finished');
        valueEl && (valueEl.textContent = 'Pronto!');
        helper && (helper.textContent = 'Respire e retome');
        fillEl && (fillEl.style.width = '100%');
        if (typeof navigator !== 'undefined' && 'vibrate' in navigator) {
          navigator.vibrate([100, 60, 100]);
        }
        const timeoutId = window.setTimeout(() => {
          if (button.dataset.timerRunning === 'true') return;
          resetRestButton(button);
        }, 4000);
        button.dataset.resetTimeout = String(timeoutId);
      } else {
        resetRestButton(button);
      }
    }

    function resetRestButton(button) {
      const valueEl = button.querySelector('[data-role="rest-value"]');
      const helper = button.querySelector('[data-role="rest-helper"]');
      const fillEl = button.querySelector('.stat-progress-fill');

      button.classList.remove('finished');
      button.classList.remove('is-counting');
      button.dataset.timerRunning = 'false';
      button.setAttribute('aria-pressed', 'false');

      if (valueEl) {
        valueEl.textContent = button.dataset.originalValue || 'Descanso';
      }
      if (helper) {
        helper.textContent = 'Toque para iniciar';
      }
      fillEl && (fillEl.style.width = '0%');
      clearPendingRestReset(button);
    }

    function clearPendingRestReset(button) {
      const timeoutId = button.dataset.resetTimeout;
      if (timeoutId) {
        clearTimeout(Number(timeoutId));
        delete button.dataset.resetTimeout;
      }
    }

    function setupRepsButton(button) {
      button.setAttribute('aria-expanded', 'false');
      addEventListenerSafe(button, 'click', (event) => {
        stopEvent(event);
        handleRepsButtonToggle(button);
      });
    }

    function handleRepsButtonToggle(button) {
      const isOpen = button.classList.toggle('is-open');
      button.setAttribute('aria-expanded', isOpen ? 'true' : 'false');

      if (isOpen) {
        closeOtherRepsTooltips(button);
        scheduleRepsAutoClose(button);
      } else {
        cancelRepsAutoClose(button);
      }
    }

    function closeOtherRepsTooltips(currentButton) {
      document.querySelectorAll('.exercise-stat-button[data-stat-type="reps"].is-open').forEach(button => {
        if (button !== currentButton) {
          button.classList.remove('is-open');
          button.setAttribute('aria-expanded', 'false');
          cancelRepsAutoClose(button);
        }
      });
    }

    function scheduleRepsAutoClose(button) {
      cancelRepsAutoClose(button);
      const timeoutId = window.setTimeout(() => {
        button.classList.remove('is-open');
        button.setAttribute('aria-expanded', 'false');
        REPS_TOOLTIP_TIMEOUTS.delete(button);
      }, 5000);
      REPS_TOOLTIP_TIMEOUTS.set(button, timeoutId);
    }

    function cancelRepsAutoClose(button) {
      const timeoutId = REPS_TOOLTIP_TIMEOUTS.get(button);
      if (timeoutId) {
        clearTimeout(timeoutId);
        REPS_TOOLTIP_TIMEOUTS.delete(button);
      }
    }

    function setupRepsOutsideClickHandler() {
      if (repsOutsideClickBound) return;
      repsOutsideClickBound = true;

      document.addEventListener('click', (event) => {
        if (event.target.closest('.exercise-stat-button[data-stat-type="reps"]')) return;
        document.querySelectorAll('.exercise-stat-button[data-stat-type="reps"].is-open').forEach(button => {
          button.classList.remove('is-open');
          button.setAttribute('aria-expanded', 'false');
          cancelRepsAutoClose(button);
        });
      });
    }

    function setupMethodButton(button) {
      setupMethodOutsideClickHandler();
      button.setAttribute('aria-expanded', 'false');

      addEventListenerSafe(button, 'click', (event) => {
        stopEvent(event);
        handleMethodButtonToggle(button);
      });

      addEventListenerSafe(button, 'keydown', (event) => {
        if (event.key === 'Escape' && button.classList.contains('is-open')) {
          event.stopPropagation();
          handleMethodButtonToggle(button, { forceClose: true });
          button.focus();
        }
      });
    }

    function handleMethodButtonToggle(button, options = {}) {
      const shouldClose = options.forceClose === true;
      const isOpen = shouldClose ? false : !button.classList.contains('is-open');

      document.querySelectorAll('.exercise-stat-button[data-stat-type="reps"].is-open').forEach(repsButton => {
        repsButton.classList.remove('is-open');
        repsButton.setAttribute('aria-expanded', 'false');
        cancelRepsAutoClose(repsButton);
      });

      if (isOpen) {
        closeOtherMethodTooltips(button);
        button.classList.add('is-open');
        button.setAttribute('aria-expanded', 'true');
        scheduleMethodAutoClose(button);
      } else {
        button.classList.remove('is-open');
        button.setAttribute('aria-expanded', 'false');
        cancelMethodAutoClose(button);
      }
    }

    function closeOtherMethodTooltips(currentButton) {
      document.querySelectorAll('.exercise-method-pill.is-open').forEach(button => {
        if (button !== currentButton) {
          button.classList.remove('is-open');
          button.setAttribute('aria-expanded', 'false');
          cancelMethodAutoClose(button);
        }
      });
    }

    function scheduleMethodAutoClose(button) {
      cancelMethodAutoClose(button);
      const timeoutId = window.setTimeout(() => {
        button.classList.remove('is-open');
        button.setAttribute('aria-expanded', 'false');
        METHOD_TOOLTIP_TIMEOUTS.delete(button);
      }, 5000);
      METHOD_TOOLTIP_TIMEOUTS.set(button, timeoutId);
    }

    function cancelMethodAutoClose(button) {
      const timeoutId = METHOD_TOOLTIP_TIMEOUTS.get(button);
      if (timeoutId) {
        clearTimeout(timeoutId);
        METHOD_TOOLTIP_TIMEOUTS.delete(button);
      }
    }

    function setupMethodOutsideClickHandler() {
      if (methodOutsideClickBound) return;
      methodOutsideClickBound = true;

      document.addEventListener('click', (event) => {
        if (event.target.closest('.exercise-method-pill')) return;
        document.querySelectorAll('.exercise-method-pill.is-open').forEach(button => {
          button.classList.remove('is-open');
          button.setAttribute('aria-expanded', 'false');
          cancelMethodAutoClose(button);
        });
      });
    }

    function createCompletionButtonHTML(index, isCompleted, isLocked) {
      const buttonClasses = isLocked
        ? "cursor-not-allowed !border-green-800/80"
        : isCompleted
          ? "!border-green-500/80 shadow-lg shadow-green-500/10 hover:!border-green-500"
          : "hover:!bg-white/10 hover:!border-white/20";

      const buttonText = isCompleted ? "Concluído!" : "Marcar como Concluído";
      const textStyle = isCompleted ? 'color: var(--green);' : 'color: var(--subtext-1);';

      return `
        <button class="completion-toggle-wrapper glass-effect w-full flex items-center justify-center gap-3 p-3 rounded-xl transition-all duration-300 transform hover:scale-[1.03] active:scale-100 ${buttonClasses}" data-index="${index}">
          <div class="animated-check-container ${isCompleted ? "completed" : ""}">
            <svg class="animated-check-svg" viewBox="0 0 24 24">
              <circle class="animated-check-circle" cx="12" cy="12" r="10"/>
              <path class="animated-check-path" d="M7 13l3 3 7-7"/>
            </svg>
          </div>
          <span class="font-bold text-base transition-colors duration-300" style="${textStyle}">
            ${buttonText}
          </span>
        </button>
      `;
    }

    function handleExerciseToggle(event) {
      const toggleWrapper = event.target.closest(".completion-toggle-wrapper");
      if (!toggleWrapper) return;

      const index = parseInt(toggleWrapper.dataset.index);
      const isPastWorkout = isPastWorkoutCheck();

      if (isPastWorkout && APP_STATE.completionStatus[index]) return;

      const wasCompleted = APP_STATE.completionStatus[index];
      APP_STATE.completionStatus[index] = !wasCompleted;

      const checkContainer = toggleWrapper.querySelector('.animated-check-container');
      if (checkContainer && !wasCompleted) {

        checkContainer.classList.remove('completed');

        void checkContainer.offsetWidth;

        checkContainer.classList.add('completed');
      }

      const key = getCompletionKey();
      APP_STATE.allCompletions[key] = APP_STATE.completionStatus;

      saveApplicationState();

      setTimeout(() => {
        renderWorkoutDetails();
      }, 100);
    }

    const EXERCISE_IMAGE_MAP = {
      "Elevação Lateral na Polia": "Elevação Lateral na Polia.gif",
      "Pulley Frente Aberto": "Pulley Frente Aberto.gif",
      "Puxada Triângulo": "Puxada Triângulo.gif",
      "Remada Serrote": "Remada Serrote.gif",
      "Remada Baixa Triângulo": "Remada Baixa Triângulo.gif",
      "Rosca Direta Barra Reta": "Rosca Direta Barra Reta.gif",
      "Tríceps Corda": "Tríceps Corda.gif",
      "Rosca Martelo + Tríceps Francês (Corda)": "Rosca Martelo + Tríceps Francês (Corda).gif",
      "Desenvolvimento Máquina": "Desenvolvimento Máquina.gif",
      "Cadeira Extensora": "Cadeira Extensora.gif",
      "Leg Press 45": "Leg Press 45.gif",
      "Cadeira Adutora": "Cadeira Adutora.gif",
      "Cadeira Extensora (2)": "Cadeira Extensora (2).gif",
      "Cadeira Flexora": "Cadeira Flexora.gif",
      "Cadeira Abdutora": "Cadeira Abdutora.gif",
      "Supino Inclinado Máquina": "Supino Inclinado Máquina.gif",
      "Crucifixo Inclinado": "Crucifixo Inclinado.gif",
      "Supino Reto Máquina": "Supino Reto Máquina.gif",
      "Desenvolvimento Máquina Aberto": "Desenvolvimento Máquina Aberto.gif",
      "Elevação Lateral": "Elevação Lateral.gif",
      "Tríceps Paralela": "Tríceps Paralela.gif",
      "Elevação Lateral com Halter": "Elevação Lateral com Halter.gif",
      "Elevação Frontal na Polia": "Elevação Frontal na Polia.gif",
      "Elevação Frontal Barra": "Elevação Frontal Barra.gif",
      "Crucifixo Inverso Máquina": "Crucifixo Inverso Máquina.gif",
      "Pull Face": "Pull Face.gif",
      "Puxada Frente Aberta": "Puxada Frente Aberta.gif",
      "Barra Fixa": "Barra Fixa.gif",
      "Remada na Máquina Articulada": "Remada na Máquina Articulada.gif",
      "Remada Pronada na Máquina": "Remada Pronada na Máquina.gif",
      "Rosca Direta Barra W": "Rosca Direta Barra W.gif",
      "Rosca Scott na Máquina com Barra W": "Rosca Scott na Máquina com Barra W.gif",
      "Rosca Spider com Barra W": "Rosca Spider com Barra W.gif",
      "Tríceps Francês Corda": "Tríceps Francês Corda.gif",
      "Mesa Flexora": "Mesa Flexora.gif",
      "Stiff": "Stiff.gif",
      "Elevação Pélvica com Barra": "Elevação Pélvica com Barra.gif",
      "Panturrilha em Pé Máquina": "Panturrilha em Pé Máquina.gif",
      "Agachamento Hack": "Agachamento Hack.gif",
      "Crucifixo Máquina Reto": "Crucifixo Máquina Reto.gif",
      "Agachamento Smith": "Agachamento Smith.gif",
      "Elevação Lateral Polia": "Elevação Lateral Polia.gif",
      "Rosca Martelo": "Rosca Martelo.gif",
      "Tríceps Francês": "Tríceps Francês.gif"
    };

    function getExerciseImageUrl(exerciseName) {
      const filename = EXERCISE_IMAGE_MAP[exerciseName];

      if (filename) {
        const imageUrl = `src/imagens/${filename}`;
        return imageUrl;
      } else {
        console.warn(`Imagem não encontrada para "${exerciseName}". Usando placeholder.`);
        const firstWord = exerciseName.split(" ")[0];
        return `https://placehold.co/600x600/0F1419/FFFFFF?text=${encodeURIComponent(firstWord)}&font=poppins`;
      }
    }

    function renderAllComponents() {
      renderStepperNavigation();
      renderPhaseHeader();
      renderDaySelector();
      renderWorkoutDetails();
    }

    function setupScrollAnimation() {
      scrollObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add("is-visible");
            observer.unobserve(entry.target);
          }
        });
      }, { rootMargin: "0px 0px -100px 0px" });
    }

    function handleWorkoutCompletion() {
      const { currentWeekNumber, currentDay, highestUnlockedWeek, highestUnlockedDayIndex } = APP_STATE;
      const phaseData = getPhaseDataByWeek(currentWeekNumber);
      const workout = phaseData.workouts[phaseData.schedule[currentDay]];
      if (!workout) return;

      const dayKeys = Object.keys(phaseData.schedule);
      const currentDayIndex = dayKeys.indexOf(currentDay);
      const isPastWorkout = currentWeekNumber < highestUnlockedWeek || (currentWeekNumber === highestUnlockedWeek && currentDayIndex < highestUnlockedDayIndex);
      const allMarked = Object.values(APP_STATE.completionStatus).filter(Boolean).length >= workout.exercises.length;

      if (allMarked && isPastWorkout) {
        resetWorkout();
        return;
      }

      if (DOM_ELEMENTS.completeWorkoutBtn.disabled) return;

      if (!allMarked) {
        workout.exercises.forEach((_, index) => { APP_STATE.completionStatus[index] = true; });
        APP_STATE.allCompletions[`week${APP_STATE.currentWeekNumber}-${APP_STATE.currentDay}`] = APP_STATE.completionStatus;
        saveApplicationState();
        renderWorkoutDetails();
        return;
      }

      const confettiKey = `week${APP_STATE.currentWeekNumber}-${APP_STATE.currentDay}`;
      if (!APP_STATE.confettiLaunched[confettiKey]) {
        confettiInstance({ particleCount: 150, spread: 90, origin: { y: 0.6 }, colors: ["var(--primary-color)", "var(--primary-hover)", "#f9e2af", "#cdd6f4"] });
        APP_STATE.confettiLaunched[confettiKey] = true;
      }

      const isAtProgressFrontier = APP_STATE.currentWeekNumber === APP_STATE.highestUnlockedWeek && currentDayIndex === APP_STATE.highestUnlockedDayIndex;
      if (!isAtProgressFrontier) return;

      let nextDayIndex = dayKeys.findIndex((day, index) => index > currentDayIndex && phaseData.schedule[day] !== 'OFF');

      if (nextDayIndex === -1) { // Fim da semana
        if (!areAllWeekWorkoutsCompleted(APP_STATE.currentWeekNumber)) {
          showNotification("Conclua todos os treinos da semana para avançar!");
          return;
        }
        if (APP_STATE.highestUnlockedWeek < 12) {
          APP_STATE.highestUnlockedWeek++;
          APP_STATE.currentWeekNumber = APP_STATE.highestUnlockedWeek;
          const nextPhaseData = getPhaseDataByWeek(APP_STATE.currentWeekNumber);
          const nextDayKeys = Object.keys(nextPhaseData.schedule);
          APP_STATE.highestUnlockedDayIndex = nextDayKeys.findIndex(day => nextPhaseData.schedule[day] !== 'OFF');
          APP_STATE.currentDay = nextDayKeys[APP_STATE.highestUnlockedDayIndex];
        } else {
          saveApplicationState();
          showCompletionMessage();
          return;
        }
      } else {
        APP_STATE.highestUnlockedDayIndex = nextDayIndex;
        APP_STATE.currentDay = dayKeys[nextDayIndex];
      }

      loadCurrentCompletionStatus();
      saveApplicationState();
      setTimeout(() => { renderAllComponents(); window.scrollTo(0, 0); }, 300);
    }

    function toggleModal(modal, card, show) {
      if (!modal || !card) return;

      if (show) {
        lockBodyScroll();
        try {
          DOM_ELEMENTS.lastFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
        } catch (_) { DOM_ELEMENTS.lastFocus = null; }
        modal.inert = false;
        modal.removeAttribute('inert');
        modal.setAttribute('aria-hidden', 'false');
      } else {
        const active = document.activeElement;
        if (active && modal.contains(active)) {
          const fallbackTarget = (DOM_ELEMENTS.lastFocus && !modal.contains(DOM_ELEMENTS.lastFocus))
            ? DOM_ELEMENTS.lastFocus
            : (DOM_ELEMENTS.mainContent || document.body);
          const needsTabIndex = fallbackTarget && fallbackTarget.tabIndex < 0;

          try {
            if (needsTabIndex) fallbackTarget.setAttribute('tabindex', '-1');
            fallbackTarget?.focus({ preventScroll: true });
            if (needsTabIndex) fallbackTarget.removeAttribute('tabindex');
          } catch (_) { }

          if (active instanceof HTMLElement) {
            active.blur();
          }
        }

        modal.inert = true;
        modal.setAttribute('inert', '');
        modal.setAttribute('aria-hidden', 'true');
        DOM_ELEMENTS.lastFocus = null;

        unlockBodyScroll();
      }

      modal.classList.toggle("invisible", !show);
      modal.classList.toggle("opacity-0", !show);
      card.classList.toggle("scale-95", !show);
      DOM_ELEMENTS.mainContent?.classList.toggle("blur-sm", show);
      DOM_ELEMENTS.mainContent?.classList.toggle("scale-105", show);
    }

    // Helper para bloquear scroll do body (modal aberto)
    function lockBodyScroll() {
      const scrollY = window.scrollY;
      document.body.style.top = `-${scrollY}px`;
      document.body.classList.add('modal-open');
    }

    // Helper para desbloquear scroll do body (modal fechado)
    function unlockBodyScroll() {
      const scrollY = document.body.style.top;
      document.body.classList.remove('modal-open');
      document.body.style.top = '';
      window.scrollTo(0, parseInt(scrollY || '0') * -1);
    }

    // Helper para restaurar foco após fechar modal
    function restoreFocusAfterModal(modal) {
      try {
        const active = document.activeElement;
        if (active && modal.contains(active)) {
          if (DOM_ELEMENTS.lastFocus && !modal.contains(DOM_ELEMENTS.lastFocus)) {
            DOM_ELEMENTS.lastFocus.focus({ preventScroll: true });
          } else if (DOM_ELEMENTS.mainContent) {
            const hadTabindex = DOM_ELEMENTS.mainContent.hasAttribute('tabindex');
            if (!hadTabindex) DOM_ELEMENTS.mainContent.setAttribute('tabindex', '-1');
            DOM_ELEMENTS.mainContent.focus({ preventScroll: true });
            if (!hadTabindex) DOM_ELEMENTS.mainContent.removeAttribute('tabindex');
          }
        }
      } catch (_) { }
    }

    // Helper para abrir modal com animação de escala
    function openScaledModal(modal, card) {
      if (!modal) return;
      modal.classList.remove('invisible', 'opacity-0');
      modal.setAttribute('aria-hidden', 'false');
      card?.classList.remove('scale-95');
      card?.classList.add('scale-100');
    }

    // Helper para fechar modal com animação de escala
    function closeScaledModal(modal, card, onComplete) {
      if (!modal) return;
      card?.classList.remove('scale-100');
      card?.classList.add('scale-95');
      modal.classList.add('opacity-0');
      
      setTimeout(() => {
        restoreFocusAfterModal(modal);
        modal.classList.add('invisible');
        modal.setAttribute('aria-hidden', 'true');
        onComplete?.();
      }, 300);
    }

    function openEditModal() {
      const phaseData = getPhaseDataByWeek(APP_STATE.currentWeekNumber);
      if (!phaseData) return;
      const { schedule, workouts } = phaseData;
      const workoutOptions = Object.keys(workouts);
      const dayNames = { Seg: "Segunda", Ter: "Terça", Qua: "Quarta", Qui: "Quinta", Sex: "Sexta", Sáb: "Sábado", Dom: "Domingo" };

      DOM_ELEMENTS.editScheduleList.innerHTML = Object.keys(schedule).map(dayKey => `
          <div class="grid grid-cols-5 items-center gap-2 px-2 py-1.5 rounded-lg" style="background: var(--surface-0);">
              <label class="font-semibold text-white text-sm col-span-2">${dayNames[dayKey]}</label>
              <select id="edit-day-${dayKey}" class="text-white text-sm rounded-lg focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)] block w-full col-span-3 py-1 px-2" style="background: var(--surface-1); border: 1px solid var(--surface-2);">
                  <option value="OFF">Dia de Descanso</option>
                  ${workoutOptions.map(woKey => `<option value="${woKey}" ${schedule[dayKey] === woKey ? 'selected' : ''}>Treino ${woKey}</option>`).join('')}
              </select>
          </div>
      `).join('');
      toggleModal(DOM_ELEMENTS.editScheduleModal, DOM_ELEMENTS.editScheduleCard, true);
    }

    function closeEditModal() {
      toggleModal(DOM_ELEMENTS.editScheduleModal, DOM_ELEMENTS.editScheduleCard, false);
    }

    function saveScheduleChanges() {
      const phaseKey = getPhaseKeyByWeek(APP_STATE.currentWeekNumber);
      if (!phaseKey) return;

      const phase = WORKOUT_PHASES[phaseKey];
      const newSchedule = {};
      let firstActiveDay = null;

      Object.keys(phase.schedule).forEach(dayKey => {
        const select = document.getElementById(`edit-day-${dayKey}`);
        newSchedule[dayKey] = select.value;

        if (newSchedule[dayKey] === "OFF") {
          delete APP_STATE.allCompletions[getCompletionKey(APP_STATE.currentWeekNumber, dayKey)];
        }

        if (newSchedule[dayKey] !== "OFF" && !firstActiveDay) {
          firstActiveDay = dayKey;
        }
      });

      phase.schedule = newSchedule;

      if (newSchedule[APP_STATE.currentDay] === "OFF") {
        APP_STATE.currentDay = firstActiveDay || Object.keys(newSchedule)[0];
      }

      updateProgressAfterScheduleChange();
      saveApplicationState();
      renderAllComponents();
      closeEditModal();
    }

    // ======================
    // Proxies de CORS
    // ======================
    const CORS_PROXIES = Object.freeze(
      isLocalDev
        ? [
          (url) => ({
            id: 'corsproxy',
            url: `https://corsproxy.io/?${encodeURIComponent(url)}`
          })
        ]
        : [
          (url) => ({
            id: 'netlify-proxy',
            url: `/proxy?url=${encodeURIComponent(url)}`
          }),
          (url) => ({
            id: 'corsproxy',
            url: `https://corsproxy.io/?${encodeURIComponent(url)}`
          })
        ]
    );

    const PROXY_RANGE_HEADER = 'bytes=0-32767';
    const PROXY_VALIDATION_TIMEOUT_MS = 8000;

    // ======================
    // Helpers utilitários
    // ======================

    function buildNetlifyProxyUrl(url) {
      return `/proxy?url=${encodeURIComponent(url)}`;
    }

    // Remove wrappers de proxy para downloads diretos
    function unwrapProxiedUrl(url) {
      if (!url) return url;
      try {
        const parsed = new URL(url, window.location.origin);
        const proxiedParam = parsed.searchParams.get('url') || parsed.searchParams.get('quest');
        const isNetlifyProxy = parsed.pathname.startsWith('/proxy') && proxiedParam;
        const isKnownProxyHost = ['corsproxy.io', 'api.codetabs.com', 'api.allorigins.win'].includes(parsed.hostname);
        // Retorna a URL desembrulhada para proxy Netlify OU proxies conhecidos
        if ((isNetlifyProxy || isKnownProxyHost) && proxiedParam) {
          return decodeURIComponent(proxiedParam);
        }
      } catch {
        // fallback para strings sem URL completa
        const patterns = [
          '/proxy?url=',
          'corsproxy.io/?',
          'api.codetabs.com/v1/proxy?quest=',
          'api.allorigins.win/raw?url='
        ];
        for (const pattern of patterns) {
          const idx = url.indexOf(pattern);
          if (idx !== -1) {
            const raw = url.slice(idx + pattern.length);
            try { return decodeURIComponent(raw); } catch { return raw; }
          }
        }
      }
      return url;
    }

    function isProxyUrl(url) {
      if (!url) return false;
      try {
        const parsed = new URL(url, window.location.origin);
        const host = parsed.hostname;
        const path = parsed.pathname || '';
        if (path.startsWith('/proxy')) return true;
        return ['corsproxy.io', 'api.codetabs.com', 'api.allorigins.win'].includes(host);
      } catch {
        return url.includes('/proxy?url=') || url.includes('corsproxy.io/?') || url.includes('api.codetabs.com/v1/proxy?quest=') || url.includes('api.allorigins.win/raw?url=');
      }
    }

    const STORAGE_KEYS = {
      notepad: "hyperfitness-notepad"
    };

    function ensureDevConsole() {
      try {
        if (typeof window === 'undefined') return;
        if (window._erudaReady) return;

        if (typeof eruda !== 'undefined' && eruda && typeof eruda.init === 'function') {
          eruda.init();
          eruda.show?.();
          window._erudaReady = true;
        }
      } catch (_) { }
    }

    // Helper para mostrar elemento com fade (global)
    function showElementWithFade(el) {
      if (!el) return;
      el.style.opacity = '1';
      el.style.visibility = 'visible';
      el.style.pointerEvents = 'auto';
    }

    // Helper para esconder elemento com fade (global)
    function hideElementWithFade(el) {
      if (!el) return;
      el.style.opacity = '0';
      el.style.visibility = 'hidden';
      el.style.pointerEvents = 'none';
    }

    function initializeFloatingActions() {
      const toggleButton = document.getElementById('quick-actions-toggle');
      const menu = document.getElementById('quick-actions-menu');

      if (!toggleButton || !menu) {
        return;
      }

      const quickActionsContainer = document.getElementById('quick-actions-container') || toggleButton.parentElement;
      const menuButtons = Array.from(menu.querySelectorAll('[data-action]'));
      const ACTION_HANDLERS = {
        notepad: openNotepadModal,
        timer: openTimerModal,
        music: () => document.dispatchEvent(new CustomEvent('hyperfitness:open-music-player'))
      };

      let isOpen = false;

      const setMenuState = (open) => {
        isOpen = open;
        toggleButton.classList.toggle('is-open', open);
        toggleButton.setAttribute('aria-expanded', String(open));
        toggleButton.setAttribute('aria-label', open ? 'Fechar ações rápidas' : 'Abrir ações rápidas');
        menu.classList.toggle('is-open', open);
        menu.setAttribute('aria-hidden', String(!open));
        menuButtons.forEach((button) => {
          button.setAttribute('tabindex', open ? '0' : '-1');
          if (!open) {
            button.blur();
          }
        });

        // Controla o overlay com blur
        const overlay = document.getElementById('quick-actions-overlay');
        if (overlay) {
          if (open) {
            showElementWithFade(overlay);
          } else {
            hideElementWithFade(overlay);
          }
        }

        if (open) {
          window.setTimeout(() => menuButtons[0]?.focus({ preventScroll: true }), 120);
        }
      };

      const closeMenu = ({ focusToggle = false } = {}) => {
        if (!isOpen) return;
        setMenuState(false);
        document.removeEventListener('click', handleDocumentClick, true);
        document.removeEventListener('keydown', handleKeydown);
        if (focusToggle) {
          toggleButton.focus({ preventScroll: true });
        }
      };

      const handleDocumentClick = (event) => {
        if (!quickActionsContainer.contains(event.target)) {
          closeMenu();
        }
      };

      const handleKeydown = (event) => {
        if (event.key === 'Escape') {
          event.preventDefault();
          closeMenu({ focusToggle: true });
        }
      };

      const openMenu = () => {
        if (isOpen) return;
        setMenuState(true);
        window.setTimeout(() => {
          document.addEventListener('click', handleDocumentClick, true);
          document.addEventListener('keydown', handleKeydown);
        }, 0);
      };

      const toggleMenu = () => {
        if (isOpen) {
          closeMenu();
        } else {
          openMenu();
        }
      };

      toggleButton.addEventListener('click', (event) => {
        stopEvent(event);
        toggleMenu();
      });

      // Fecha o menu ao clicar no overlay
      const overlay = document.getElementById('quick-actions-overlay');
      if (overlay) {
        overlay.addEventListener('click', () => {
          closeMenu();
        });
      }

      toggleButton.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && isOpen) {
          event.preventDefault();
          closeMenu({ focusToggle: true });
        }
      });

      menuButtons.forEach((button) => {
        button.addEventListener('click', (event) => {
          stopEvent(event);
          const action = button.dataset.action;
          const handler = ACTION_HANDLERS[action];
          closeMenu();
          if (typeof handler === 'function') {
            window.setTimeout(() => handler(), 120);
          }
        });

        button.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            event.preventDefault();
            closeMenu({ focusToggle: true });
          }
        });
      });
    }

    function initializeQuickActionsToggleTextFit() {
      const toggleButton = document.getElementById('quick-actions-toggle');
      if (!toggleButton) return;

      const computeFallbackFontSize = () => {
        const rootStyles = window.getComputedStyle(document.documentElement);
        const sizeToken = parseFloat(rootStyles.getPropertyValue('--quick-action-size')) || toggleButton.clientHeight || 64;
        return sizeToken * 0.38;
      };

      const adjustFontSize = () => {
        const textContent = toggleButton.textContent.trim();
        const hasText = textContent.length > 0;
        toggleButton.toggleAttribute('data-text-mode', hasText);

        if (!hasText) {
          toggleButton.style.removeProperty('--quick-actions-font-size');
          return;
        }

        const availableWidth = toggleButton.clientWidth;
        if (!availableWidth) {
          return;
        }

        toggleButton.style.removeProperty('--quick-actions-font-size');

        let fontSize = parseFloat(window.getComputedStyle(toggleButton).fontSize);
        if (!Number.isFinite(fontSize) || fontSize <= 0) {
          fontSize = computeFallbackFontSize();
        }

        toggleButton.style.setProperty('--quick-actions-font-size', `${fontSize}px`);

        const minFontSize = Math.max(4, availableWidth * 0.08);
        let safeguard = 0;

        while (toggleButton.scrollWidth > availableWidth && fontSize > minFontSize && safeguard < 80) {
          fontSize -= 0.5;
          toggleButton.style.setProperty('--quick-actions-font-size', `${fontSize}px`);
          safeguard += 1;
        }
      };

      adjustFontSize();

      const observer = new MutationObserver(adjustFontSize);
      observer.observe(toggleButton, { childList: true, characterData: true, subtree: true });

      if (typeof ResizeObserver === 'function') {
        const resizeObserver = new ResizeObserver(() => adjustFontSize());
        resizeObserver.observe(toggleButton);
      }

      window.addEventListener('resize', adjustFontSize);

      toggleButton.addEventListener('quick-actions:fit', adjustFontSize);
    }

    const TIMER_STATE = {
      elapsedMs: 0,
      isRunning: false,
      startTimestamp: null,
      intervalId: null
    };

    function updateTimerDisplay() {
      if (!DOM_ELEMENTS.timerDisplay) return;
      DOM_ELEMENTS.timerDisplay.textContent = formatDuration(TIMER_STATE.elapsedMs);
    }

    function updateTimerUI() {
      if (!DOM_ELEMENTS.timerToggleBtn || !DOM_ELEMENTS.timerResetBtn || !DOM_ELEMENTS.timerStatus) return;

      const isIdle = TIMER_STATE.elapsedMs === 0 && !TIMER_STATE.isRunning;
      const label = TIMER_STATE.isRunning ? "Pausar" : TIMER_STATE.elapsedMs > 0 ? "Retomar" : "Iniciar";

      const { timerPlayIcon, timerPauseIcon, timerToggleLabel } = DOM_ELEMENTS;

      if (timerPlayIcon && timerPauseIcon && timerToggleLabel) {
        timerPlayIcon.classList.toggle('hidden', TIMER_STATE.isRunning);
        timerPauseIcon.classList.toggle('hidden', !TIMER_STATE.isRunning);
        timerToggleLabel.textContent = label;
        DOM_ELEMENTS.timerToggleBtn.classList.toggle('is-running', TIMER_STATE.isRunning);
      }

      DOM_ELEMENTS.timerResetBtn.disabled = isIdle;

      DOM_ELEMENTS.timerStatus.textContent = TIMER_STATE.isRunning
        ? "Cronômetro em andamento"
        : TIMER_STATE.elapsedMs > 0
          ? "Cronômetro pausado"
          : "Pronto para iniciar";
    }

    function startTimer() {
      if (TIMER_STATE.isRunning) return;

      TIMER_STATE.isRunning = true;
      TIMER_STATE.startTimestamp = Date.now() - TIMER_STATE.elapsedMs;

      if (TIMER_STATE.intervalId) {
        clearInterval(TIMER_STATE.intervalId);
      }

      TIMER_STATE.intervalId = window.setInterval(() => {
        TIMER_STATE.elapsedMs = Date.now() - TIMER_STATE.startTimestamp;
        updateTimerDisplay();
      }, 200);

      updateTimerUI();
    }

    function pauseTimer() {
      if (!TIMER_STATE.isRunning) return;

      TIMER_STATE.elapsedMs = Date.now() - TIMER_STATE.startTimestamp;
      TIMER_STATE.isRunning = false;

      if (TIMER_STATE.intervalId) {
        clearInterval(TIMER_STATE.intervalId);
        TIMER_STATE.intervalId = null;
      }

      updateTimerDisplay();
      updateTimerUI();
    }

    function resetTimer() {
      if (TIMER_STATE.intervalId) {
        clearInterval(TIMER_STATE.intervalId);
        TIMER_STATE.intervalId = null;
      }

      TIMER_STATE.elapsedMs = 0;
      TIMER_STATE.startTimestamp = null;
      TIMER_STATE.isRunning = false;

      updateTimerDisplay();
      updateTimerUI();
    }

    function handleTimerToggle() {
      if (TIMER_STATE.isRunning) {
        pauseTimer();
      } else {
        startTimer();
      }
    }

    function openTimerModal() {
      if (!DOM_ELEMENTS.timerModal || !DOM_ELEMENTS.timerCard) return;
      toggleModal(DOM_ELEMENTS.timerModal, DOM_ELEMENTS.timerCard, true);
      setTimeout(() => DOM_ELEMENTS.timerCard?.focus({ preventScroll: true }), 200);
    }

    function closeTimerModal() {
      if (!DOM_ELEMENTS.timerModal || !DOM_ELEMENTS.timerCard) return;
      toggleModal(DOM_ELEMENTS.timerModal, DOM_ELEMENTS.timerCard, false);
    }

    function initializeTimer() {
      updateTimerDisplay();
      updateTimerUI();

      DOM_ELEMENTS.timerToggleBtn?.addEventListener('click', handleTimerToggle);
      DOM_ELEMENTS.timerResetBtn?.addEventListener('click', resetTimer);
      DOM_ELEMENTS.closeTimerBtn?.addEventListener('click', closeTimerModal);
      addBackdropCloseListener(DOM_ELEMENTS.timerModal, closeTimerModal);
      DOM_ELEMENTS.timerCard?.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          event.preventDefault();
          closeTimerModal();
        }
      });

      document.addEventListener('keydown', (event) => {
        const isOpen = !DOM_ELEMENTS.timerModal?.classList.contains('invisible');
        if (isOpen && event.key === 'Escape') {
          event.preventDefault();
          closeTimerModal();
        }
      });
    }

    const EXERCISE_IMAGE_MODAL = {
      modal: null,
      closeBtn: null,
      content: null,
      image: null
    };

    function openExerciseImageModal(imageUrl) {
      if (!EXERCISE_IMAGE_MODAL.modal || !EXERCISE_IMAGE_MODAL.image) return;

      EXERCISE_IMAGE_MODAL.image.src = imageUrl;
      EXERCISE_IMAGE_MODAL.image.alt = 'Demonstração do exercício';

      lockBodyScroll();

      EXERCISE_IMAGE_MODAL.modal.classList.remove('invisible');
      EXERCISE_IMAGE_MODAL.modal.setAttribute('aria-hidden', 'false');

      requestAnimationFrame(() => {
        EXERCISE_IMAGE_MODAL.modal.classList.add('active');
      });

      setTimeout(() => {
        EXERCISE_IMAGE_MODAL.content?.focus({ preventScroll: true });
      }, 200);
    }

    function closeExerciseImageModal() {
      if (!EXERCISE_IMAGE_MODAL.modal) return;

      EXERCISE_IMAGE_MODAL.modal.classList.remove('active');

      setTimeout(() => {
        restoreFocusAfterModal(EXERCISE_IMAGE_MODAL.modal);
        EXERCISE_IMAGE_MODAL.modal.classList.add('invisible');
        EXERCISE_IMAGE_MODAL.modal.setAttribute('aria-hidden', 'true');

        unlockBodyScroll();

        if (EXERCISE_IMAGE_MODAL.image) {
          EXERCISE_IMAGE_MODAL.image.src = '';
        }
      }, 300);
    }

    function initializeExerciseImageModal() {

      EXERCISE_IMAGE_MODAL.modal = document.getElementById('exercise-image-modal');
      EXERCISE_IMAGE_MODAL.closeBtn = document.getElementById('close-exercise-image-btn');
      EXERCISE_IMAGE_MODAL.content = document.getElementById('exercise-image-content');
      EXERCISE_IMAGE_MODAL.image = document.getElementById('exercise-image');

      if (!EXERCISE_IMAGE_MODAL.modal) return;

      EXERCISE_IMAGE_MODAL.closeBtn?.addEventListener('click', (event) => {
        stopEvent(event);
        closeExerciseImageModal();
      });

      addBackdropCloseListener(EXERCISE_IMAGE_MODAL.modal, closeExerciseImageModal);

      document.addEventListener('keydown', (event) => {
        const isOpen = EXERCISE_IMAGE_MODAL.modal?.classList.contains('active');
        if (isOpen && event.key === 'Escape') {
          event.preventDefault();
          closeExerciseImageModal();
        }
      });

      EXERCISE_IMAGE_MODAL.content?.addEventListener('click', (event) => {
        event.stopPropagation();
      });
    }

    const NOTEPAD_STATE = {
      pages: [],
      activePageId: null,
      autosaveHandle: null,
      lastSavedAt: null,
      storedSelection: null
    };

    function generateNotepadId() {
      return (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function')
        ? crypto.randomUUID()
        : `notepad-${Date.now()}-${Math.random().toString(16).slice(2)}`;
    }

    function createDefaultNotepadPage(index = 1) {
      const timestamp = Date.now();
      return {
        id: generateNotepadId(),
        title: `Página ${index}`,
        content: '',
        createdAt: timestamp,
        updatedAt: timestamp
      };
    }

    function loadNotepadStateFromStorage() {
      NOTEPAD_STATE.pages = [];
      NOTEPAD_STATE.activePageId = null;
      NOTEPAD_STATE.lastSavedAt = null;

      if (typeof window === 'undefined' || !window.localStorage) {
        const fallbackPage = createDefaultNotepadPage();
        NOTEPAD_STATE.pages.push(fallbackPage);
        NOTEPAD_STATE.activePageId = fallbackPage.id;
        NOTEPAD_STATE.lastSavedAt = fallbackPage.updatedAt;
        return;
      }

      try {
        const stored = window.localStorage.getItem(STORAGE_KEYS.notepad);
        if (!stored) {
          throw new Error('no stored notepad state');
        }

        const parsed = JSON.parse(stored);
        const pages = Array.isArray(parsed?.pages) ? parsed.pages : [];
        if (!pages.length) {
          throw new Error('invalid notepad pages');
        }

        NOTEPAD_STATE.pages = pages.map((page, index) => {
          const timestamp = page?.updatedAt || Date.now();
          return {
            id: page?.id || generateNotepadId(),
            title: typeof page?.title === 'string' && page.title.trim() ? page.title.trim() : `Página ${index + 1}`,
            content: typeof page?.content === 'string' ? page.content : '',
            createdAt: page?.createdAt || timestamp,
            updatedAt: timestamp
          };
        });

        const activeCandidate = parsed?.activePageId;
        const activeExists = NOTEPAD_STATE.pages.some(page => page.id === activeCandidate);
        NOTEPAD_STATE.activePageId = activeExists ? activeCandidate : NOTEPAD_STATE.pages[0].id;
        NOTEPAD_STATE.lastSavedAt = parsed?.lastSavedAt || Date.now();
      } catch (error) {
        console.warn('Não foi possível carregar o bloco de anotações, criando um novo.', error);
        const fallbackPage = createDefaultNotepadPage();
        NOTEPAD_STATE.pages = [fallbackPage];
        NOTEPAD_STATE.activePageId = fallbackPage.id;
        NOTEPAD_STATE.lastSavedAt = fallbackPage.updatedAt;
        persistNotepadState();
      }
    }

    function persistNotepadState(updateTimestamp = false) {
      if (updateTimestamp) {
        NOTEPAD_STATE.lastSavedAt = Date.now();
      }

      if (typeof window === 'undefined' || !window.localStorage) {
        return false;
      }

      try {
        window.localStorage.setItem(STORAGE_KEYS.notepad, JSON.stringify({
          pages: NOTEPAD_STATE.pages,
          activePageId: NOTEPAD_STATE.activePageId,
          lastSavedAt: NOTEPAD_STATE.lastSavedAt
        }));
        return true;
      } catch (error) {
        console.warn('Não foi possível salvar o bloco de anotações.', error);
        return false;
      }
    }

    function getActiveNotepadPage() {
      return NOTEPAD_STATE.pages.find(page => page.id === NOTEPAD_STATE.activePageId) || null;
    }

    function formatNotepadTime(timestamp, { includeDate = false } = {}) {
      if (!timestamp) return 'agora mesmo';
      const date = new Date(timestamp);
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      if (!includeDate) {
        return `às ${hours}:${minutes}`;
      }
      const localeDate = date.toLocaleDateString('pt-BR');
      return `${localeDate} às ${hours}:${minutes}`;
    }

    function updateNotepadIndicator(message, variant = 'default') {
      if (!DOM_ELEMENTS.notepadSaveIndicator) return;
      const iconClass = variant === 'saving'
        ? 'ph-bold ph-cloud-arrow-down'
        : variant === 'warning'
          ? 'ph-bold ph-warning'
          : 'ph-bold ph-sparkle';

      DOM_ELEMENTS.notepadSaveIndicator.classList.toggle('is-saving', variant === 'saving');
      DOM_ELEMENTS.notepadSaveIndicator.classList.toggle('is-warning', variant === 'warning');
      DOM_ELEMENTS.notepadSaveIndicator.innerHTML = `<i class="${iconClass} text-sm" aria-hidden="true"></i><span>${message}</span>`;
    }

    function updateNotepadUpdatedAt() {
      if (!DOM_ELEMENTS.notepadUpdatedAt) return;
      const page = getActiveNotepadPage();
      if (!page) {
        DOM_ELEMENTS.notepadUpdatedAt.textContent = 'Nenhuma página ativa';
        return;
      }

      const now = new Date();
      const updatedAt = new Date(page.updatedAt);
      const sameDay = now.toDateString() === updatedAt.toDateString();
      DOM_ELEMENTS.notepadUpdatedAt.textContent = sameDay
        ? `Atualizado ${formatNotepadTime(page.updatedAt)}`
        : `Atualizado em ${formatNotepadTime(page.updatedAt, { includeDate: true })}`;
    }

    function updateNotepadControlsState() {
      const hasMultiplePages = NOTEPAD_STATE.pages.length > 1;
      if (DOM_ELEMENTS.notepadDeleteBtn) {
        DOM_ELEMENTS.notepadDeleteBtn.disabled = !hasMultiplePages;
        DOM_ELEMENTS.notepadDeleteBtn.setAttribute('aria-disabled', String(!hasMultiplePages));
      }
    }

    function renderNotepadTabs() {
      if (!DOM_ELEMENTS.notepadPagesList) return;
      DOM_ELEMENTS.notepadPagesList.innerHTML = '';

      NOTEPAD_STATE.pages.forEach(page => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'notepad-tab';
        button.dataset.pageId = page.id;
        button.setAttribute('role', 'tab');
        const isActive = page.id === NOTEPAD_STATE.activePageId;
        button.setAttribute('aria-selected', isActive ? 'true' : 'false');
        button.setAttribute('aria-controls', 'notepad-editor');
        button.textContent = page.title || 'Página';
        if (isActive) {
          button.classList.add('is-active');
        }
        DOM_ELEMENTS.notepadPagesList.appendChild(button);
      });
    }

    function renderNotepadEditor() {
      const editor = DOM_ELEMENTS.notepadEditor;
      if (!editor) return;
      const page = getActiveNotepadPage();

      if (!page) {
        editor.innerHTML = '';
        editor.setAttribute('contenteditable', 'false');
        updateFormatToolbarState();
        return;
      }

      editor.setAttribute('contenteditable', 'true');
      const preparedContent = prepareNotepadContentForEditor(page.content);
      editor.innerHTML = preparedContent;
      ensureChecklistIntegrity(editor);
      normalizeStandardLists(editor);
      updateFormatToolbarState();
      cacheEditorSelection();
    }

    function renderNotepadHeader() {
      const page = getActiveNotepadPage();
      if (DOM_ELEMENTS.notepadActiveTitle) {
        DOM_ELEMENTS.notepadActiveTitle.textContent = page?.title || 'Página atual';
      }
      updateNotepadControlsState();
      updateNotepadUpdatedAt();
    }

    function renderNotepadUI() {
      renderNotepadTabs();
      renderNotepadEditor();
      renderNotepadHeader();
      setTimeout(() => updateCharCounter(), 0);
    }

    function escapeHTML(value) {
      if (!value && value !== 0) return '';
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
      return String(value).replace(/[&<>"']/g, (char) => map[char]);
    }

    function convertPlainTextToHTML(text) {
      if (!text) return '';
      const lines = String(text).split(/\r?\n/);
      return lines
        .map((line) => {
          if (!line.trim()) return '<p><br></p>';
          return `<p>${escapeHTML(line)}</p>`;
        })
        .join('');
    }

    function sanitizeEditorHTML(html) {
      const container = document.createElement('div');
      container.innerHTML = html || '';
      const allowedTags = new Set(['P', 'BR', 'UL', 'OL', 'LI', 'DIV', 'SPAN', 'STRONG', 'EM', 'B', 'I', 'U', 'BUTTON', 'A']);
      const allowedAttributes = new Set(['class', 'data-list-type', 'data-checked', 'aria-pressed', 'aria-label', 'type', 'href', 'target', 'rel', 'title']);

      const walker = document.createTreeWalker(container, NodeFilter.SHOW_ELEMENT, null);
      const nodesToStrip = [];

      while (walker.nextNode()) {
        const element = walker.currentNode;
        if (!allowedTags.has(element.tagName)) {
          nodesToStrip.push(element);
          continue;
        }

        [...element.attributes].forEach((attr) => {
          if (!allowedAttributes.has(attr.name) && !attr.name.startsWith('data-')) {
            element.removeAttribute(attr.name);
          }
        });
      }

      nodesToStrip.forEach((node) => {
        const parent = node.parentNode;
        if (!parent) return;
        while (node.firstChild) {
          parent.insertBefore(node.firstChild, node);
        }
        parent.removeChild(node);
      });

      return container.innerHTML;
    }

    function prepareNotepadContentForEditor(content) {
      if (!content) return '';
      const raw = String(content);
      const isHTML = /<([a-z][\s\S]*?)>/i.test(raw.trim());
      const baseContent = isHTML ? raw : convertPlainTextToHTML(raw);
      return sanitizeEditorHTML(baseContent);
    }

    function normalizeSerializedContent(html) {
      const trimmed = (html || '').trim();
      if (!trimmed) return '';
      const wrapper = document.createElement('div');
      wrapper.innerHTML = trimmed;
      const textContent = (wrapper.textContent || '').replace(/\u200B/g, '').trim();
      const hasChecklistHandle = wrapper.querySelector('.notepad-check-handle');
      if (!textContent && !hasChecklistHandle) {
        return '';
      }
      return trimmed;
    }

    function serializeEditorContent() {
      if (!DOM_ELEMENTS.notepadEditor) return '';
      const sanitized = sanitizeEditorHTML(DOM_ELEMENTS.notepadEditor.innerHTML || '');
      return normalizeSerializedContent(sanitized);
    }

    function commitEditorContent({ debounce = true } = {}) {
      const page = getActiveNotepadPage();
      if (!page) return;
      const serialized = serializeEditorContent();
      page.content = serialized;
      page.updatedAt = Date.now();
      updateNotepadUpdatedAt();

      if (debounce) {
        scheduleNotepadSave();
      } else {
        const success = persistNotepadState(true);
        if (success) {
          updateNotepadIndicator(`Tudo salvo ${formatNotepadTime(NOTEPAD_STATE.lastSavedAt)}`);
        } else {
          updateNotepadIndicator('Falha ao salvar', 'warning');
        }
      }
    }

    function createChecklistHandle(isChecked = false) {
      const handle = document.createElement('button');
      handle.type = 'button';
      handle.className = 'notepad-check-handle';
      handle.dataset.checked = isChecked ? 'true' : 'false';
      handle.setAttribute('aria-pressed', isChecked ? 'true' : 'false');
      handle.setAttribute('aria-label', isChecked ? 'Desmarcar item' : 'Marcar item');
      handle.contentEditable = 'false';
      handle.setAttribute('tabindex', '-1');
      return handle;
    }

    function updateChecklistItemState(listItem, handle) {
      if (!listItem || !handle) return;
      const isChecked = handle.dataset.checked === 'true';
      listItem.classList.toggle('is-checked', isChecked);
      handle.setAttribute('aria-pressed', isChecked ? 'true' : 'false');
      handle.setAttribute('aria-label', isChecked ? 'Desmarcar item' : 'Marcar item');
    }

    function ensureChecklistIntegrity(root = DOM_ELEMENTS.notepadEditor) {
      const editor = root || DOM_ELEMENTS.notepadEditor;
      if (!editor) return;

      let lists;
      if (editor.tagName === 'UL' && editor.hasAttribute('data-list-type') && editor.getAttribute('data-list-type') === 'checklist') {
        lists = [editor];
      } else {
        lists = editor.querySelectorAll('ul[data-list-type="checklist"]');
      }

      lists.forEach((list) => {
        Array.from(list.children).forEach((listItem) => {
          if (!(listItem instanceof HTMLElement)) return;

          let handle = listItem.querySelector('.notepad-check-handle');
          if (!handle) {
            const shouldStartChecked = listItem.classList.contains('is-checked') || listItem.dataset.checked === 'true';
            handle = createChecklistHandle(shouldStartChecked);
            listItem.insertBefore(handle, listItem.firstChild);
          }

          handle.contentEditable = 'false';
          handle.setAttribute('tabindex', '-1');

          let textContent = '';
          const nodes = Array.from(listItem.childNodes);
          nodes.forEach((node) => {
            if (node !== handle && node.nodeType === Node.TEXT_NODE) {
              textContent += node.textContent;
              listItem.removeChild(node);
            } else if (node !== handle && node.nodeType === Node.ELEMENT_NODE && !node.classList.contains('notepad-check-handle')) {
              if (node.classList?.contains('notepad-check-text')) return;
              textContent += node.textContent || node.innerText || '';
              listItem.removeChild(node);
            }
          });

          let textSpan = listItem.querySelector('.notepad-check-text');
          if (!textSpan) {
            textSpan = document.createElement('span');
            textSpan.className = 'notepad-check-text';
            listItem.appendChild(textSpan);
          }

          if (textContent.trim()) {
            textSpan.textContent = textContent;
          } else if (!textSpan.textContent) {
            textSpan.innerHTML = '<br>';
          }

          const isChecked = handle.dataset.checked === 'true' || listItem.classList.contains('is-checked');
          handle.dataset.checked = isChecked ? 'true' : 'false';
          updateChecklistItemState(listItem, handle);
        });
      });
    }

    function normalizeStandardLists(root = DOM_ELEMENTS.notepadEditor) {
      const editor = root || DOM_ELEMENTS.notepadEditor;
      if (!editor) return;
      const lists = editor.querySelectorAll('ul:not([data-list-type="checklist"]), ol');
      lists.forEach((list) => {
        if (list.tagName === 'UL') {
          list.removeAttribute('data-list-type');
        }
        list.querySelectorAll('.notepad-check-handle').forEach((handle) => handle.remove());
        Array.from(list.children).forEach((item) => item.classList?.remove('is-checked'));
      });
    }

    function cleanupOrphanedElements(root = DOM_ELEMENTS.notepadEditor) {
      const editor = root || DOM_ELEMENTS.notepadEditor;
      if (!editor) return;

      const allCheckboxes = editor.querySelectorAll('.notepad-check-handle');
      allCheckboxes.forEach((checkbox) => {
        const parent = checkbox.parentElement;
        if (!parent || parent.tagName !== 'LI' || !parent.closest('ul[data-list-type="checklist"]')) {
          checkbox.remove();
        }
      });

      const allListItems = editor.querySelectorAll('li');
      allListItems.forEach((item) => {

        const textContent = item.textContent?.trim() || '';
        const hasVisibleContent = Array.from(item.childNodes).some((node) => {
          if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) return true;
          if (node.nodeType === Node.ELEMENT_NODE && node.tagName !== 'BR' && !node.classList?.contains('notepad-check-handle')) return true;
          return false;
        });

        if (!textContent && !hasVisibleContent) {
          const list = item.parentElement;
          item.remove();

          if (list && list.children.length === 0) {
            list.remove();
          }
        }
      });

      const allLists = editor.querySelectorAll('ul, ol');
      allLists.forEach((list) => {
        if (list.children.length === 0) {
          list.remove();
        }
      });
    }

    function toggleChecklistHandle(handle) {
      if (!handle) return;
      const listItem = handle.closest('li');
      if (!listItem) return;

      const isChecked = handle.dataset.checked === 'true';
      handle.dataset.checked = isChecked ? 'false' : 'true';
      updateChecklistItemState(listItem, handle);

      const selection = window.getSelection();
      if (selection) {
        const range = document.createRange();
        range.selectNodeContents(listItem);
        range.collapse(false);
        selection.removeAllRanges();
        selection.addRange(range);
        NOTEPAD_STATE.storedSelection = range.cloneRange();
      }

      DOM_ELEMENTS.notepadEditor?.focus({ preventScroll: true });
      commitEditorContent();
      updateFormatToolbarState();
    }

    function handleChecklistToggle(event) {
      const target = event.target.closest('.notepad-check-handle');
      if (!target) return;
      stopEvent(event);
      toggleChecklistHandle(target);
    }

    function convertSingleChecklistItem(listItem, targetFormat) {
      if (!listItem) return null;

      const checklistUl = listItem.closest('ul[data-list-type="checklist"]');
      if (!checklistUl) return null;

      const handle = listItem.querySelector('.notepad-check-handle');
      if (handle) handle.remove();

      const textSpan = listItem.querySelector('.notepad-check-text');
      let textContent = '';
      if (textSpan) {
        textContent = textSpan.innerHTML;
        while (textSpan.firstChild) {
          listItem.insertBefore(textSpan.firstChild, textSpan);
        }
        textSpan.remove();
      }

      listItem.classList.remove('is-checked');

      const newList = document.createElement(targetFormat === 'ol' ? 'ol' : 'ul');

      listItem.remove();

      newList.appendChild(listItem);

      checklistUl.parentNode.insertBefore(newList, checklistUl.nextSibling);

      if (checklistUl.children.length === 0) {
        checklistUl.remove();
      }

      newList.setAttribute('data-converted-from-checklist', 'true');
      setTimeout(() => {
        if (newList && newList.hasAttribute('data-converted-from-checklist')) {
          newList.removeAttribute('data-converted-from-checklist');
        }
      }, 500);

      return newList;
    }

    function convertSingleItemToChecklist(listItem) {
      if (!listItem) return null;

      const currentList = listItem.closest('ul, ol');
      if (!currentList) return null;

      if (currentList.hasAttribute('data-converted-from-checklist')) {
        currentList.removeAttribute('data-converted-from-checklist');
        return null;
      }

      if (currentList.matches('ul[data-list-type="checklist"]')) {
        return null;
      }

      listItem.remove();

      const checklistUl = document.createElement('ul');
      checklistUl.setAttribute('data-list-type', 'checklist');
      checklistUl.style.listStyle = 'none';
      checklistUl.style.paddingLeft = '0';

      checklistUl.appendChild(listItem);

      currentList.parentNode.insertBefore(checklistUl, currentList.nextSibling);

      if (currentList.children.length === 0) {
        currentList.remove();
      }

      ensureChecklistIntegrity(checklistUl);

      return checklistUl;
    }

    function convertChecklistToStandardList(list, { keepList = true } = {}) {
      if (!list) return null;

      const items = Array.from(list.children);

      items.forEach((item) => {
        if (!(item instanceof HTMLElement)) return;
        item.classList.remove('is-checked');

        const handles = item.querySelectorAll('.notepad-check-handle');
        handles.forEach((handle) => handle.remove());

        const textSpans = item.querySelectorAll('.notepad-check-text');
        textSpans.forEach((span) => {

          while (span.firstChild) {
            item.insertBefore(span.firstChild, span);
          }
          span.remove();
        });
      });

      list.removeAttribute('data-list-type');

      list.setAttribute('data-converted-from-checklist', 'true');

      setTimeout(() => {
        if (list && list.hasAttribute('data-converted-from-checklist')) {
          list.removeAttribute('data-converted-from-checklist');
        }
      }, 500);

      list.style.listStyle = '';
      list.style.paddingLeft = '';

      if (list.getAttribute('style') === '') {
        list.removeAttribute('style');
      }

      if (keepList) {
        return list;
      }

      const fragment = document.createDocumentFragment();
      items.forEach((item) => {
        const paragraph = document.createElement('p');
        const clone = item.cloneNode(true);
        paragraph.innerHTML = clone.innerHTML.trim() || '<br>';
        fragment.appendChild(paragraph);
      });
      list.replaceWith(fragment);
      return fragment;
    }

    function transformListToParagraphs(list) {
      if (!list) return;

      const isChecklist = list.matches('ul[data-list-type="checklist"]');

      if (isChecklist) {
        convertChecklistToStandardList(list, { keepList: false });
        return;
      }

      const fragment = document.createDocumentFragment();
      Array.from(list.children).forEach((item) => {
        const paragraph = document.createElement('p');
        const clone = item.cloneNode(true);
        clone.querySelectorAll('.notepad-check-handle').forEach((handle) => handle.remove());
        paragraph.innerHTML = clone.innerHTML.trim() || '<br>';
        fragment.appendChild(paragraph);
      });
      list.replaceWith(fragment);
    }

    function getSelectionAnchorNode() {
      const selection = window.getSelection();
      if (!selection || selection.rangeCount === 0) return null;
      return selection.anchorNode || selection.getRangeAt(0).commonAncestorContainer;
    }

    function getClosestEditable(node, selector) {
      if (!node) return null;
      const element = node.nodeType === Node.ELEMENT_NODE ? node : node.parentElement;
      return element ? element.closest(selector) : null;
    }

    function placeCaretAtEnd(element) {
      if (!element) return;
      const range = document.createRange();
      range.selectNodeContents(element);
      range.collapse(false);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      NOTEPAD_STATE.storedSelection = range.cloneRange();
    }

    function cacheEditorSelection() {
      const editor = DOM_ELEMENTS.notepadEditor;
      if (!editor) return;
      const selection = window.getSelection();
      if (!selection || selection.rangeCount === 0) {
        NOTEPAD_STATE.storedSelection = null;
        return;
      }
      const range = selection.getRangeAt(0);
      const container = range.commonAncestorContainer;
      if (editor.contains(container)) {
        NOTEPAD_STATE.storedSelection = range.cloneRange();
      } else {
        NOTEPAD_STATE.storedSelection = null;
      }
    }

    function restoreEditorSelection() {
      const editor = DOM_ELEMENTS.notepadEditor;
      if (!editor || !NOTEPAD_STATE.storedSelection) return false;
      const selection = window.getSelection();
      selection.removeAllRanges();
      try {
        const range = NOTEPAD_STATE.storedSelection;
        if (!editor.contains(range.startContainer)) {
          NOTEPAD_STATE.storedSelection = null;
          return false;
        }
        selection.addRange(range.cloneRange());
        return true;
      } catch (error) {
        NOTEPAD_STATE.storedSelection = null;
        return false;
      }
    }

    function withEditorSelection(callback) {
      const editor = DOM_ELEMENTS.notepadEditor;
      if (!editor || typeof callback !== 'function') return;
      editor.focus({ preventScroll: true });
      if (!restoreEditorSelection()) {
        placeCaretAtEnd(editor);
      }
      callback();

      updateFormatToolbarState();
      cacheEditorSelection();
    }

    function applyChecklistFormat() {
      const anchor = getSelectionAnchorNode();

      let currentChecklist = getClosestEditable(anchor, 'ul[data-list-type="checklist"]');

      if (!currentChecklist && anchor) {
        const element = anchor.nodeType === Node.ELEMENT_NODE ? anchor : anchor.parentElement;
        const listItem = element?.closest('li');
        if (listItem) {
          currentChecklist = listItem.closest('ul[data-list-type="checklist"]');
        }
      }

      if (currentChecklist) {
        return;
      }

      let currentListItem = null;
      if (anchor) {
        const element = anchor.nodeType === Node.ELEMENT_NODE ? anchor : anchor.parentElement;
        currentListItem = element?.closest('li');
      }

      const currentBulletList = getClosestEditable(anchor, 'ul:not([data-list-type="checklist"])');
      const currentNumberList = getClosestEditable(anchor, 'ol');
      const currentList = currentBulletList || currentNumberList;

      if (currentList && currentList.hasAttribute('data-converted-from-checklist')) {
        currentList.removeAttribute('data-converted-from-checklist');
        return;
      }

      if (currentList && currentListItem) {

        const newChecklist = convertSingleItemToChecklist(currentListItem);

        if (newChecklist) {

          const firstItem = newChecklist.querySelector('li');
          const textSpan = firstItem?.querySelector('.notepad-check-text');
          if (textSpan) {
            placeCaretAtEnd(textSpan);
          }
        }

        commitEditorContent();
        updateFormatToolbarState();
        cacheEditorSelection();
        return;
      }

      document.execCommand('insertUnorderedList');

      setTimeout(() => {
        const selection = window.getSelection();
        const anchorAfter = selection?.anchorNode;

        let newList = null;
        if (anchorAfter) {
          newList = getClosestEditable(anchorAfter, 'ul');
        }

        if (!newList) {
          const editor = DOM_ELEMENTS.notepadEditor;
          const allLists = editor?.querySelectorAll('ul');
          if (allLists && allLists.length > 0) {

            newList = allLists[allLists.length - 1];
          }
        }

        if (newList) {

          if (!newList.hasAttribute('data-list-type')) {
            newList.setAttribute('data-list-type', 'checklist');
          }
          newList.style.listStyle = 'none';
          newList.style.paddingLeft = '0';

          ensureChecklistIntegrity(newList);

          const firstItem = newList.querySelector('li');
          const textSpan = firstItem?.querySelector('.notepad-check-text');
          if (textSpan) {
            const range = document.createRange();
            range.selectNodeContents(textSpan);
            range.collapse(false);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
            NOTEPAD_STATE.storedSelection = range.cloneRange();
          }

          commitEditorContent();
          updateFormatToolbarState();
          cacheEditorSelection();
        }
      }, 10);
    }

    function applyBulletListFormat() {
      const anchor = getSelectionAnchorNode();

      let currentListItem = null;
      if (anchor) {
        const element = anchor.nodeType === Node.ELEMENT_NODE ? anchor : anchor.parentElement;
        currentListItem = element?.closest('li');
      }

      let currentChecklist = null;
      if (currentListItem) {
        currentChecklist = currentListItem.closest('ul[data-list-type="checklist"]');
      }

      if (!currentChecklist) {
        currentChecklist = getClosestEditable(anchor, 'ul[data-list-type="checklist"]');
      }

      if (currentChecklist && currentListItem) {

        const newList = convertSingleChecklistItem(currentListItem, 'ul');

        if (newList) {
          normalizeStandardLists(newList);

          const firstItem = newList.querySelector('li');
          if (firstItem) {
            placeCaretAtEnd(firstItem);
          }
        }

        commitEditorContent();
        updateFormatToolbarState();
        return;
      }

      const currentBulletList = getClosestEditable(anchor, 'ul:not([data-list-type="checklist"])');
      if (currentBulletList) {

        return;
      }

      document.execCommand('insertUnorderedList');

      setTimeout(() => {
        const newList = getClosestEditable(getSelectionAnchorNode(), 'ul');
        if (newList && newList.hasAttribute('data-list-type')) {
          newList.removeAttribute('data-list-type');
        }
        normalizeStandardLists();
        commitEditorContent();
        updateFormatToolbarState();
        cacheEditorSelection();
      }, 10);
    }

    function applyNumberListFormat() {
      const anchor = getSelectionAnchorNode();

      let currentListItem = null;
      if (anchor) {
        const element = anchor.nodeType === Node.ELEMENT_NODE ? anchor : anchor.parentElement;
        currentListItem = element?.closest('li');
      }

      let currentChecklist = null;
      if (currentListItem) {
        currentChecklist = currentListItem.closest('ul[data-list-type="checklist"]');
      }

      if (!currentChecklist) {
        currentChecklist = getClosestEditable(anchor, 'ul[data-list-type="checklist"]');
      }

      if (currentChecklist && currentListItem) {

        const newList = convertSingleChecklistItem(currentListItem, 'ol');

        if (newList) {

          const firstItem = newList.querySelector('li');
          if (firstItem) {
            placeCaretAtEnd(firstItem);
          }
        }

        commitEditorContent();
        updateFormatToolbarState();
        return;
      }

      const currentNumberList = getClosestEditable(anchor, 'ol');
      if (currentNumberList) {

        return;
      }

      document.execCommand('insertOrderedList');

      setTimeout(() => {
        normalizeStandardLists();
        commitEditorContent();
        updateFormatToolbarState();
        cacheEditorSelection();
      }, 10);
    }

    function removeListFormatting() {
      const anchor = getSelectionAnchorNode();

      let currentListItem = null;
      if (anchor) {
        const element = anchor.nodeType === Node.ELEMENT_NODE ? anchor : anchor.parentElement;
        currentListItem = element?.closest('li');
      }

      const currentList = getClosestEditable(anchor, 'ul, ol');

      if (!currentList) {
        document.execCommand('removeFormat');
        commitEditorContent();
        updateFormatToolbarState();
        return;
      }

      if (currentListItem && currentList.children.length > 1) {
        const paragraph = document.createElement('p');

        const handle = currentListItem.querySelector('.notepad-check-handle');
        if (handle) handle.remove();

        const textSpan = currentListItem.querySelector('.notepad-check-text');
        if (textSpan) {
          while (textSpan.firstChild) {
            currentListItem.insertBefore(textSpan.firstChild, textSpan);
          }
          textSpan.remove();
        }

        currentListItem.classList.remove('is-checked');

        paragraph.innerHTML = currentListItem.innerHTML.trim() || '<br>';

        currentList.parentNode.insertBefore(paragraph, currentList.nextSibling);

        currentListItem.remove();

        if (currentList.children.length === 0) {
          currentList.remove();
        }

        placeCaretAtEnd(paragraph);

        commitEditorContent();
        updateFormatToolbarState();
        return;
      }

      transformListToParagraphs(currentList);
      commitEditorContent();
      updateFormatToolbarState();
    }

    function applyFormattingCommand(command) {
      if (!command) return;
      withEditorSelection(() => {
        if (command === 'checklist') {
          applyChecklistFormat();
        } else if (command === 'bullet') {
          applyBulletListFormat();
        } else if (command === 'number') {
          applyNumberListFormat();
        } else if (command === 'paragraph') {
          removeListFormatting();
        }
      });
    }

    function handleFormatButtonPointerDown(event) {
      stopEvent(event);
      restoreEditorSelection();
      DOM_ELEMENTS.notepadEditor?.focus({ preventScroll: true });
    }

    function handleFormatButtonClick(event) {
      stopEvent(event);
      const command = event.currentTarget?.dataset?.command;
      applyFormattingCommand(command);
    }

    function handleEditorKeydown(event) {

      if (event.key === 'Enter') {
        const selection = window.getSelection();
        if (!selection || !selection.isCollapsed) return;

        const anchorNode = selection.anchorNode;

        let listItem = null;
        if (anchorNode?.nodeType === Node.ELEMENT_NODE && anchorNode.tagName === 'LI') {
          listItem = anchorNode;
        } else if (anchorNode?.parentElement) {
          listItem = anchorNode.parentElement.closest('li');
        }

        if (!listItem) return;

        const checklistUl = listItem.closest('ul[data-list-type="checklist"]');
        const bulletUl = listItem.closest('ul:not([data-list-type="checklist"])');
        const numberedOl = listItem.closest('ol');

        if (checklistUl) {
          event.preventDefault();

          const textSpan = listItem.querySelector('.notepad-check-text');
          const textContent = textSpan?.textContent?.trim() || '';

          if (!textContent) {
            const paragraph = document.createElement('p');
            paragraph.innerHTML = '<br>';
            checklistUl.parentElement.insertBefore(paragraph, checklistUl.nextSibling);

            listItem.remove();

            if (checklistUl.children.length === 0) {
              checklistUl.remove();
            }

            const range = document.createRange();
            range.setStart(paragraph, 0);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            NOTEPAD_STATE.storedSelection = range.cloneRange();
          } else {

            const newItem = document.createElement('li');
            const newCheckbox = createChecklistHandle(false);
            const newTextSpan = document.createElement('span');
            newTextSpan.className = 'notepad-check-text';
            newTextSpan.innerHTML = '<br>';

            newItem.appendChild(newCheckbox);
            newItem.appendChild(newTextSpan);

            listItem.parentElement.insertBefore(newItem, listItem.nextSibling);

            const range = document.createRange();
            range.setStart(newTextSpan, 0);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            NOTEPAD_STATE.storedSelection = range.cloneRange();
          }

          commitEditorContent();
          updateFormatToolbarState();
          return;
        }

        if (bulletUl || numberedOl) {
          const textContent = listItem.textContent?.trim() || '';

          if (!textContent) {
            event.preventDefault();

            const list = bulletUl || numberedOl;
            const paragraph = document.createElement('p');
            paragraph.innerHTML = '<br>';
            list.parentElement.insertBefore(paragraph, list.nextSibling);

            listItem.remove();

            if (list.children.length === 0) {
              list.remove();
            }

            const range = document.createRange();
            range.setStart(paragraph, 0);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            NOTEPAD_STATE.storedSelection = range.cloneRange();

            commitEditorContent();
            updateFormatToolbarState();
            return;
          }

          setTimeout(() => {
            normalizeStandardLists();
            cacheEditorSelection();
          }, 0);
          return;
        }
      }

      if (event.key === 'Backspace' || event.key === 'Delete') {
        const selection = window.getSelection();

        if (event.key === 'Backspace' && selection && selection.isCollapsed) {
          const anchorNode = selection.anchorNode;
          const anchorOffset = selection.anchorOffset;

          let checklistItem = null;
          if (anchorNode?.nodeType === Node.ELEMENT_NODE && anchorNode.tagName === 'LI') {
            checklistItem = anchorNode;
          } else if (anchorNode?.parentElement) {
            checklistItem = anchorNode.parentElement.closest('li');
          }

          if (checklistItem && checklistItem.closest('ul[data-list-type="checklist"]')) {
            const textSpan = checklistItem.querySelector('.notepad-check-text');
            const checkbox = checklistItem.querySelector('.notepad-check-handle');

            const textContent = textSpan?.textContent?.trim() || '';
            const isEmpty = !textContent || textContent === '';

            if (isEmpty) {
              event.preventDefault();

              const list = checklistItem.parentElement;
              const wasOnlyItem = list.children.length === 1;

              if (wasOnlyItem) {

                const paragraph = document.createElement('p');
                paragraph.innerHTML = '<br>';
                list.parentElement.insertBefore(paragraph, list);
                list.remove();

                const range = document.createRange();
                range.setStart(paragraph, 0);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
                NOTEPAD_STATE.storedSelection = range.cloneRange();
              } else {

                const nextItem = checklistItem.nextElementSibling;
                const prevItem = checklistItem.previousElementSibling;

                checklistItem.remove();

                const targetItem = prevItem || nextItem;
                if (targetItem) {
                  const targetText = targetItem.querySelector('.notepad-check-text');
                  if (targetText) {
                    const range = document.createRange();
                    range.selectNodeContents(targetText);
                    range.collapse(false);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    NOTEPAD_STATE.storedSelection = range.cloneRange();
                  }
                }
              }

              commitEditorContent();
              updateFormatToolbarState();
              return;
            }
          }
        }

        if (!selection || selection.isCollapsed) {

          requestAnimationFrame(() => {
            cleanupOrphanedElements();
            ensureChecklistIntegrity();
            normalizeStandardLists();
            updateFormatToolbarState();
            cacheEditorSelection();
          });
          return;
        }

        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;
        const editor = DOM_ELEMENTS.notepadEditor;

        if (!editor || !editor.contains(container)) {
          requestAnimationFrame(() => {
            cleanupOrphanedElements();
            ensureChecklistIntegrity();
            normalizeStandardLists();
            updateFormatToolbarState();
            cacheEditorSelection();
          });
          return;
        }

        const fragment = range.cloneContents();
        const checkboxes = fragment.querySelectorAll('.notepad-check-handle');
        const listItems = fragment.querySelectorAll('li');

        if (checkboxes.length > 0 || listItems.length > 1) {
          event.preventDefault();

          range.deleteContents();

          requestAnimationFrame(() => {
            cleanupOrphanedElements();
            ensureChecklistIntegrity();
            normalizeStandardLists();
            updateFormatToolbarState();
            cacheEditorSelection();
            commitEditorContent();
          });

          return;
        }
      }

      if (event.key === 'Enter') {

        return;
      }

      if (!['Backspace', 'Delete'].includes(event.key)) return;

      requestAnimationFrame(() => {
        cleanupOrphanedElements();
        ensureChecklistIntegrity();
        normalizeStandardLists();
        updateFormatToolbarState();
        cacheEditorSelection();
      });
    }

    function preventCheckboxFocus(event) {
      const selection = window.getSelection();
      if (!selection || !selection.anchorNode) return;

      const checkboxHandle = selection.anchorNode.closest?.('.notepad-check-handle') ||
        (selection.anchorNode.parentElement?.classList?.contains('notepad-check-handle') ? selection.anchorNode.parentElement : null);

      if (checkboxHandle) {
        event.preventDefault();
        const listItem = checkboxHandle.closest('li');
        const textSpan = listItem?.querySelector('.notepad-check-text');
        if (textSpan) {
          const range = document.createRange();
          range.selectNodeContents(textSpan);
          range.collapse(true);
          selection.removeAllRanges();
          selection.addRange(range);
        }
      }
    }

    function handleEditorClick(event) {
      const target = event.target;

      if (target.classList?.contains('notepad-check-handle')) {
        return;
      }

      const listItem = target.closest('li');
      if (listItem && listItem.closest('ul[data-list-type="checklist"]')) {
        const textSpan = listItem.querySelector('.notepad-check-text');
        if (textSpan && target !== textSpan) {
          setTimeout(() => {
            const range = document.createRange();
            range.selectNodeContents(textSpan);
            range.collapse(false);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
          }, 0);
        }
      }
    }

    function setFormatButtonActive(button, isActive) {
      if (!button) return;
      if (isActive) {
        button.dataset.active = 'true';
        button.setAttribute('aria-pressed', 'true');
      } else {
        button.removeAttribute('data-active');
        button.setAttribute('aria-pressed', 'false');
      }
    }

    function updateFormatToolbarState() {
      const editor = DOM_ELEMENTS.notepadEditor;
      const selection = window.getSelection();
      const anchor = selection?.anchorNode;
      const focus = selection?.focusNode;
      const insideEditor = editor && ((anchor && editor.contains(anchor)) || (focus && editor.contains(focus)));

      if (!insideEditor) {
        setFormatButtonActive(DOM_ELEMENTS.notepadFormatChecklistBtn, false);
        setFormatButtonActive(DOM_ELEMENTS.notepadFormatBulletBtn, false);
        setFormatButtonActive(DOM_ELEMENTS.notepadFormatNumberBtn, false);
        setFormatButtonActive(DOM_ELEMENTS.notepadFormatParagraphBtn, false);
        return;
      }

      const targetNode = anchor || focus;
      const isChecklist = !!getClosestEditable(targetNode, 'ul[data-list-type="checklist"]');
      const isBullet = !!getClosestEditable(targetNode, 'ul:not([data-list-type="checklist"])');
      const isNumber = !!getClosestEditable(targetNode, 'ol');
      const isParagraph = !isChecklist && !isBullet && !isNumber;

      setFormatButtonActive(DOM_ELEMENTS.notepadFormatChecklistBtn, isChecklist);
      setFormatButtonActive(DOM_ELEMENTS.notepadFormatBulletBtn, isBullet);
      setFormatButtonActive(DOM_ELEMENTS.notepadFormatNumberBtn, isNumber);
      setFormatButtonActive(DOM_ELEMENTS.notepadFormatParagraphBtn, isParagraph);
    }

    function handleSelectionChange() {
      cacheEditorSelection();
      updateFormatToolbarState();
    }

    function finalizeNotepadAutosave() {
      if (!NOTEPAD_STATE.autosaveHandle) return;
      window.clearTimeout(NOTEPAD_STATE.autosaveHandle);
      NOTEPAD_STATE.autosaveHandle = null;
      const success = persistNotepadState(true);
      if (success) {
        updateNotepadIndicator(`Tudo salvo ${formatNotepadTime(NOTEPAD_STATE.lastSavedAt)}`);
        updateNotepadUpdatedAt();
      } else {
        updateNotepadIndicator('Falha ao salvar', 'warning');
      }
    }

    function scheduleNotepadSave() {
      if (NOTEPAD_STATE.autosaveHandle) {
        window.clearTimeout(NOTEPAD_STATE.autosaveHandle);
      }

      updateNotepadIndicator('Salvando...', 'saving');
      NOTEPAD_STATE.autosaveHandle = window.setTimeout(() => {
        NOTEPAD_STATE.autosaveHandle = null;
        const success = persistNotepadState(true);
        if (success) {
          updateNotepadIndicator(`Tudo salvo ${formatNotepadTime(NOTEPAD_STATE.lastSavedAt)}`);
          updateNotepadUpdatedAt();
        } else {
          updateNotepadIndicator('Falha ao salvar', 'warning');
        }
      }, 600);
    }

    function getNextNotepadPageIndex() {
      let candidate = NOTEPAD_STATE.pages.length + 1;
      while (NOTEPAD_STATE.pages.some(page => page.title?.trim().toLowerCase() === `página ${candidate}`)) {
        candidate += 1;
      }
      return candidate;
    }

    function setActiveNotepadPage(pageId) {
      if (!pageId || pageId === NOTEPAD_STATE.activePageId) return;
      const exists = NOTEPAD_STATE.pages.some(page => page.id === pageId);
      if (!exists) return;
      finalizeNotepadAutosave();
      NOTEPAD_STATE.storedSelection = null;
      NOTEPAD_STATE.activePageId = pageId;
      persistNotepadState();
      renderNotepadUI();
      updateNotepadIndicator(`Tudo salvo ${formatNotepadTime(NOTEPAD_STATE.lastSavedAt)}`);
      updateCharCounter();
      setTimeout(() => DOM_ELEMENTS.notepadEditor?.focus({ preventScroll: true }), 160);
    }

    function updateCharCounter() {
      const editor = DOM_ELEMENTS.notepadEditor;
      const counter = DOM_ELEMENTS.notepadCharCounter;
      if (!editor || !counter) return;

      const text = editor.innerText || editor.textContent || '';
      const normalizedText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

      if (!normalizedText || normalizedText === '\n' || !normalizedText.trim()) {
        counter.textContent = `0 / 280`;
        counter.classList.remove('warning', 'error');
        return;
      }

      const lines = normalizedText.split('\n');
      const lineBreaks = Math.max(0, lines.length - 1);
      const textChars = normalizedText.replace(/\n/g, '').length;
      const length = textChars + (lineBreaks * 56);
      const maxLength = 280;

      counter.textContent = `${length} / ${maxLength}`;

      counter.classList.remove('warning', 'error');
      if (length > maxLength) {
        counter.classList.add('error');
      } else if (length >= maxLength - 20) {
        counter.classList.add('warning');
      }
    }

    function enforceCharLimit(event) {
      const editor = DOM_ELEMENTS.notepadEditor;
      if (!editor) return;

      if (event.inputType === 'deleteContentBackward' ||
        event.inputType === 'deleteContentForward' ||
        event.inputType === 'deleteByCut' ||
        event.inputType === 'deleteContent' ||
        event.inputType === 'deleteByDrag') {
        return;
      }

      const text = editor.innerText || editor.textContent || '';
      const normalizedText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

      const lines = normalizedText.split('\n');
      const lineBreaks = Math.max(0, lines.length - 1);
      const textChars = normalizedText.replace(/\n/g, '').length;
      const currentLength = textChars + (lineBreaks * 56);

      let addedLength = 1;
      if (event.inputType === 'insertParagraph' || event.inputType === 'insertLineBreak') {
        addedLength = 56;
      } else if (event.inputType === 'insertText' && event.data) {
        addedLength = event.data.length;
      } else if (event.inputType === 'insertCompositionText' && event.data) {
        addedLength = event.data.length;
      }

      const newLength = currentLength + addedLength;
      const maxLength = 280;

      if (newLength > maxLength) {
        stopEvent(event);
        updateCharCounter();
        return false;
      }
    }

    function handleNotepadEditorBeforeInput(event) {
      enforceCharLimit(event);
    }

    function handleNotepadEditorInput(event) {
      updateCharCounter();
      ensureChecklistIntegrity();
      normalizeStandardLists();
      commitEditorContent();
      updateFormatToolbarState();
    }

    function handleNotepadAddPage() {
      finalizeNotepadAutosave();
      NOTEPAD_STATE.storedSelection = null;
      const nextIndex = getNextNotepadPageIndex();
      const newPage = createDefaultNotepadPage(nextIndex);
      NOTEPAD_STATE.pages.push(newPage);
      NOTEPAD_STATE.activePageId = newPage.id;
      persistNotepadState(true);
      renderNotepadUI();
      updateNotepadIndicator(`Tudo salvo ${formatNotepadTime(NOTEPAD_STATE.lastSavedAt)}`);
      updateCharCounter();
      setTimeout(() => DOM_ELEMENTS.notepadEditor?.focus({ preventScroll: true }), 180);
    }

    function handleNotepadRenamePage() {
      const page = getActiveNotepadPage();
      if (!page) return;
      openRenameModal(page);
    }

    function openRenameModal(page) {
      if (!DOM_ELEMENTS.renameModal || !DOM_ELEMENTS.renameInput) return;

      DOM_ELEMENTS.renameInput.value = page.title;
      updateRenameCharCount();

      openScaledModal(DOM_ELEMENTS.renameModal, DOM_ELEMENTS.renameCard);

      setTimeout(() => {
        DOM_ELEMENTS.renameInput?.focus();
        DOM_ELEMENTS.renameInput?.select();
      }, 150);
    }

    function closeRenameModal() {
      closeScaledModal(DOM_ELEMENTS.renameModal, DOM_ELEMENTS.renameCard, () => {
        DOM_ELEMENTS.renameInput.value = '';
      });
    }

    function confirmRename() {
      const page = getActiveNotepadPage();
      if (!page || !DOM_ELEMENTS.renameInput) return;

      const newTitle = DOM_ELEMENTS.renameInput.value.trim();

      if (!newTitle) {
        updateNotepadIndicator('O título não pode ficar vazio', 'warning');
        DOM_ELEMENTS.renameInput?.focus();
        return;
      }

      page.title = newTitle;
      page.updatedAt = Date.now();

      const success = persistNotepadState(true);
      if (!success) {
        updateNotepadIndicator('Falha ao salvar título', 'warning');
        return;
      }

      renderNotepadUI();
      updateNotepadIndicator(`Tudo salvo ${formatNotepadTime(NOTEPAD_STATE.lastSavedAt)}`);
      closeRenameModal();
    }

    function updateRenameCharCount() {
      if (!DOM_ELEMENTS.renameInput || !DOM_ELEMENTS.renameCharCount) return;
      const length = DOM_ELEMENTS.renameInput.value.length;
      DOM_ELEMENTS.renameCharCount.textContent = `${length} / 50`;
    }

    function handleNotepadDeletePage() {
      if (NOTEPAD_STATE.pages.length <= 1) {
        updateNotepadIndicator('Mantenha ao menos uma página ativa', 'warning');
        return;
      }
      const page = getActiveNotepadPage();
      if (!page) return;
      openDeleteModal(page);
    }

    function openDeleteModal(page) {
      if (!DOM_ELEMENTS.deleteModal || !DOM_ELEMENTS.deletePageTitle) return;

      DOM_ELEMENTS.deletePageTitle.textContent = `"${page.title}"`;
      openScaledModal(DOM_ELEMENTS.deleteModal, DOM_ELEMENTS.deleteCard);
    }

    function closeDeleteModal() {
      closeScaledModal(DOM_ELEMENTS.deleteModal, DOM_ELEMENTS.deleteCard);
    }

    function confirmDelete() {
      const page = getActiveNotepadPage();
      if (!page) return;

      finalizeNotepadAutosave();
      NOTEPAD_STATE.storedSelection = null;
      NOTEPAD_STATE.pages = NOTEPAD_STATE.pages.filter(item => item.id !== page.id);
      if (!NOTEPAD_STATE.pages.length) {
        const fallback = createDefaultNotepadPage();
        NOTEPAD_STATE.pages.push(fallback);
        NOTEPAD_STATE.activePageId = fallback.id;
      } else if (!NOTEPAD_STATE.pages.some(item => item.id === NOTEPAD_STATE.activePageId)) {
        NOTEPAD_STATE.activePageId = NOTEPAD_STATE.pages[0].id;
      }

      persistNotepadState(true);
      renderNotepadUI();
      updateNotepadIndicator(`Página excluída • tudo salvo ${formatNotepadTime(NOTEPAD_STATE.lastSavedAt)}`);
      closeDeleteModal();
    }

    function openNotepadModal() {
      if (!DOM_ELEMENTS.notepadModal || !DOM_ELEMENTS.notepadCard) return;
      renderNotepadUI();
      updateNotepadIndicator(`Tudo salvo ${formatNotepadTime(NOTEPAD_STATE.lastSavedAt)}`);
      updateCharCounter();
      toggleModal(DOM_ELEMENTS.notepadModal, DOM_ELEMENTS.notepadCard, true);
      setTimeout(() => DOM_ELEMENTS.notepadEditor?.focus({ preventScroll: true }), 200);
    }

    function closeNotepadModal() {
      finalizeNotepadAutosave();
      if (!DOM_ELEMENTS.notepadModal || !DOM_ELEMENTS.notepadCard) return;
      toggleModal(DOM_ELEMENTS.notepadModal, DOM_ELEMENTS.notepadCard, false);
    }

    function initializeNotepad() {
      loadNotepadStateFromStorage();
      renderNotepadUI();
      updateNotepadIndicator(`Tudo salvo ${formatNotepadTime(NOTEPAD_STATE.lastSavedAt)}`);
      updateCharCounter();

      DOM_ELEMENTS.notepadAddPageBtn?.addEventListener('click', handleNotepadAddPage);
      DOM_ELEMENTS.notepadRenameBtn?.addEventListener('click', handleNotepadRenamePage);
      DOM_ELEMENTS.notepadDeleteBtn?.addEventListener('click', handleNotepadDeletePage);
      DOM_ELEMENTS.notepadPagesList?.addEventListener('click', (event) => {
        const target = event.target.closest('[data-page-id]');
        if (!target) return;
        event.preventDefault();
        setActiveNotepadPage(target.dataset.pageId);
      });
      DOM_ELEMENTS.notepadEditor?.addEventListener('beforeinput', handleNotepadEditorBeforeInput);
      DOM_ELEMENTS.notepadEditor?.addEventListener('input', handleNotepadEditorInput);
      DOM_ELEMENTS.notepadEditor?.addEventListener('paste', (event) => {
        const editor = DOM_ELEMENTS.notepadEditor;
        if (!editor) return;

        const text = editor.innerText || editor.textContent || '';
        const normalizedText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        const lines = normalizedText.split('\n');
        const lineBreaks = Math.max(0, lines.length - 1);
        const textChars = normalizedText.replace(/\n/g, '').length;
        const currentLength = textChars + (lineBreaks * 56);

        const pastedText = (event.clipboardData || window.clipboardData).getData('text');
        const pastedLength = pastedText.length;

        if (currentLength + pastedLength > 280) {
          event.preventDefault();
          updateCharCounter();
          return false;
        }
      });
      DOM_ELEMENTS.notepadEditor?.addEventListener('click', (e) => {
        handleChecklistToggle(e);
        handleEditorClick(e);
      });
      DOM_ELEMENTS.notepadEditor?.addEventListener('keydown', (e) => {
        handleEditorKeydown(e);
        preventCheckboxFocus(e);
      });
      DOM_ELEMENTS.notepadEditor?.addEventListener('keyup', cacheEditorSelection);
      DOM_ELEMENTS.notepadEditor?.addEventListener('mouseup', cacheEditorSelection);
      DOM_ELEMENTS.closeNotepadBtn?.addEventListener('click', closeNotepadModal);
      addBackdropCloseListener(DOM_ELEMENTS.notepadModal, closeNotepadModal);
      DOM_ELEMENTS.notepadCard?.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          event.preventDefault();
          closeNotepadModal();
        }
      });

      const formatButtons = [
        DOM_ELEMENTS.notepadFormatChecklistBtn,
        DOM_ELEMENTS.notepadFormatBulletBtn,
        DOM_ELEMENTS.notepadFormatNumberBtn,
        DOM_ELEMENTS.notepadFormatParagraphBtn
      ];

      formatButtons.forEach((button) => {
        button?.addEventListener('pointerdown', handleFormatButtonPointerDown);
        button?.addEventListener('click', handleFormatButtonClick);
      });

      document.addEventListener('selectionchange', handleSelectionChange);

      DOM_ELEMENTS.renameConfirmBtn?.addEventListener('click', confirmRename);
      DOM_ELEMENTS.renameCancelBtn?.addEventListener('click', closeRenameModal);
      DOM_ELEMENTS.closeRenameBtn?.addEventListener('click', closeRenameModal);
      DOM_ELEMENTS.renameInput?.addEventListener('input', updateRenameCharCount);
      DOM_ELEMENTS.renameInput?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          confirmRename();
        } else if (event.key === 'Escape') {
          event.preventDefault();
          closeRenameModal();
        }
      });
      addBackdropCloseListener(DOM_ELEMENTS.renameModal, closeRenameModal);

      DOM_ELEMENTS.deleteConfirmBtn?.addEventListener('click', confirmDelete);
      DOM_ELEMENTS.deleteCancelBtn?.addEventListener('click', closeDeleteModal);
      DOM_ELEMENTS.closeDeleteBtn?.addEventListener('click', closeDeleteModal);
      addBackdropCloseListener(DOM_ELEMENTS.deleteModal, closeDeleteModal);

      document.addEventListener('keydown', (event) => {
        const isOpen = !DOM_ELEMENTS.notepadModal?.classList.contains('invisible');
        if (isOpen && event.key === 'Escape') {
          event.preventDefault();
          closeNotepadModal();
        }
      });
    }

    function initializeApp() {
      if (appInitialized) {
        return;
      }
      appInitialized = true;

      // Inicializa Eruda apenas se já estiver presente (não interfere com extensões/inspector)
      ensureDevConsole();

      Object.assign(DOM_ELEMENTS, {
        mainContent: document.getElementById("main-content"),
        stepperNav: document.getElementById("stepper-nav"),
        daySelector: document.getElementById("day-selector"),
        workoutDetails: document.getElementById("workout-details"),
        workoutTitle: document.getElementById("workout-title"),
        progressBarContainer: document.getElementById("progress-bar-container"),
        phaseHeader: document.getElementById("phase-header"),
        headerBackground: document.querySelector('.header-background'),
        footer: document.getElementById("footer-container"),
        completeWorkoutBtn: document.getElementById("complete-workout-btn"),
        editScheduleModal: document.getElementById("edit-schedule-modal"),
        editScheduleCard: document.getElementById("edit-schedule-card"),
        editScheduleList: document.getElementById("edit-schedule-list"),
        closeEditScheduleBtn: document.getElementById("close-edit-schedule-btn"),
        cancelEditBtn: document.getElementById("cancel-edit-btn"),
        saveEditBtn: document.getElementById("save-edit-btn"),
        timerModal: document.getElementById("timer-modal"),
        timerCard: document.getElementById("timer-card"),
        timerDisplay: document.getElementById("timer-display"),
        timerStatus: document.getElementById("timer-status"),
        timerToggleBtn: document.getElementById("timer-toggle-btn"),
        timerResetBtn: document.getElementById("timer-reset-btn"),
        timerPlayIcon: document.getElementById("timer-play-icon"),
        timerPauseIcon: document.getElementById("timer-pause-icon"),
        timerToggleLabel: document.getElementById("timer-toggle-label"),
        closeTimerBtn: document.getElementById("close-timer-btn"),
        notepadModal: document.getElementById("notepad-modal"),
        notepadCard: document.getElementById("notepad-card"),
        closeNotepadBtn: document.getElementById("close-notepad-btn"),
        notepadPagesList: document.getElementById("notepad-pages-list"),
        notepadAddPageBtn: document.getElementById("notepad-add-page-btn"),
        notepadRenameBtn: document.getElementById("notepad-rename-btn"),
        notepadDeleteBtn: document.getElementById("notepad-delete-btn"),
        notepadEditor: document.getElementById("notepad-editor"),
        notepadCharCounter: document.getElementById("notepad-char-counter"),
        notepadFormatChecklistBtn: document.getElementById("notepad-format-checklist"),
        notepadFormatBulletBtn: document.getElementById("notepad-format-bullet"),
        notepadFormatNumberBtn: document.getElementById("notepad-format-number"),
        notepadFormatParagraphBtn: document.getElementById("notepad-format-paragraph"),
        notepadSaveIndicator: document.getElementById("notepad-save-indicator"),
        notepadActiveTitle: document.getElementById("notepad-active-title"),
        notepadUpdatedAt: document.getElementById("notepad-updated-at"),
        renameModal: document.getElementById("rename-modal"),
        renameCard: document.getElementById("rename-card"),
        renameInput: document.getElementById("rename-input"),
        renameCharCount: document.getElementById("rename-char-count"),
        renameConfirmBtn: document.getElementById("rename-confirm-btn"),
        renameCancelBtn: document.getElementById("rename-cancel-btn"),
        closeRenameBtn: document.getElementById("close-rename-btn"),
        deleteModal: document.getElementById("delete-modal"),
        deleteCard: document.getElementById("delete-card"),
        deletePageTitle: document.getElementById("delete-page-title"),
        deleteConfirmBtn: document.getElementById("delete-confirm-btn"),
        deleteCancelBtn: document.getElementById("delete-cancel-btn"),
        closeDeleteBtn: document.getElementById("close-delete-btn")
      });

      const confettiCanvas = document.getElementById("confetti-canvas");
      confettiInstance = confetti.create(confettiCanvas, { resize: true, useWorker: true });

      setupScrollAnimation();
      initializeCardParallaxSystem();
      loadApplicationState();
      renderAllComponents();
      setupEventListeners();
      setupRepsOutsideClickHandler();
      setupMethodOutsideClickHandler();
      initializeTimer();
      initializeExerciseImageModal();
      initializeNotepad();
      initializeFloatingActions();
      initializeQuickActionsToggleTextFit();
      setupHorizontalScrollForTabs();
    }

    // Função unificada para scroll horizontal via wheel
    function enableHorizontalWheelScroll(element, options = {}) {
      if (!element) return;
      const { capture = false, parentElement = null } = options;
      
      const handler = (e) => {
        // Se parentElement definido, verifica se está sobre o elemento
        if (parentElement) {
          const rect = element.getBoundingClientRect();
          const isOver = e.clientX >= rect.left && e.clientX <= rect.right && 
                         e.clientY >= rect.top && e.clientY <= rect.bottom;
          if (!isOver) return;
          if (element.style.pointerEvents === 'none') return;
        }
        
        // Se já é scroll horizontal nativo, deixa passar
        if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) return;
        
        const delta = e.deltaX !== 0 ? e.deltaX : e.deltaY;
        if (delta !== 0) {
          e.preventDefault();
          if (capture) e.stopPropagation();
          element.scrollLeft += delta;
        }
      };
      
      const target = parentElement || element;
      target.addEventListener('wheel', handler, { capture, passive: false });
    }

    function setupHorizontalScrollForTabs() {
      enableHorizontalWheelScroll(document.getElementById('notepad-pages-list'));
    }

    function setupEventListeners() {
      const eventBindings = [
        [DOM_ELEMENTS.completeWorkoutBtn, 'click', handleWorkoutCompletion],
        [DOM_ELEMENTS.closeEditScheduleBtn, 'click', closeEditModal],
        [DOM_ELEMENTS.cancelEditBtn, 'click', closeEditModal],
        [DOM_ELEMENTS.saveEditBtn, 'click', saveScheduleChanges],
        [DOM_ELEMENTS.workoutDetails, 'click', handleExerciseToggle],
        [DOM_ELEMENTS.editScheduleModal, 'click', (e) => {
          if (e.target === DOM_ELEMENTS.editScheduleModal) closeEditModal();
        }]
      ];

      eventBindings.forEach(([element, event, handler]) => {
        element?.addEventListener(event, handler);
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp, { once: true });
    } else {
      initializeApp();
    }
  </script>
</body>

</html>
